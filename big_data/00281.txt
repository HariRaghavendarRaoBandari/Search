6
1
0
2

 
r
a

M
8

 

 
 
]
h
p
-
c
c
a
.
s
c
i
s
y
h
p
[
 
 

2
v
1
8
2
0
0

.

3
0
6
1
:
v
i
X
r
a

Error analysis of linear optics measurements via turn-by-turn beam position data in

circular accelerators

A. Franchi

ESRF, Grenoble, France
(Dated: March 9, 2016)

Many advanced techniques have been developed, tested and implemented in the last decades in
almost all circular accelerators across the world to measure the linear optics. However, the greater
availability and accuracy of beam diagnostics and the ever better correction of linear magnetic
lattice imperfections (beta beating at 1% level and coupling at 1‰) are reaching what seems to
be the intrinsic accuracy and precision of diﬀerent measurement techniques. This paper aims to
highlight and quantify, when possible, the limitations of one standard method, the harmonic analysis
of turn-by-turn beam position data. To this end, new analytic formulas for the evaluation of lattice
parameters modiﬁed by focusing errors are derived. The unexpected conclusion of this study is that
for the ESRF storage ring (and possibly for any third generation light source operating at ultra-low
coupling and with similar diagnostics), measurement and correction of linear optics via orbit beam
position data are to be preferred to the analysis of turn-by-turn data.

I.

INTRODUCTION AND MOTIVATION

Measurement and correction of focusing errors in cir-
cular accelerators is one of the top priorities in collid-
ers and storage ring-based light sources to provide users
with beam sizes and divergences as close as possible to
the design values and to limit the possible detrimental
eﬀects on the beam lifetime caused by the integer and
half-integer resonances. To this end, so many diﬀerent
techniques have been developed and successfully tested
since decades that they already occupy entire chapters in
textbooks [1].

A brief and non-exhaustive historical overview may
help understand the great advancements in this domain.
Back to the early ’80s, one of the ﬁrst measurements
of betatron phase advance and beta functions was doc-
umented in Ref. [2]. In the early ’90s systematic mea-
surements and correction were already carried out at
the CERN Large Electron Positron (LEP) collider from
the harmonic analysis of turn-by-turn (TBT) beam po-
sition monitor (BPM) data, reaching a beta beating of
10% [3, 4]. In the ﬁrst decades of the new century other
colliders worldwide reported similar or even lower mod-
ulation [5–7]. With the advent of 3rd generation light
sources, a major breakthrough was provided by the ex-
ploitation of orbit BPM data for the reconstruction of
machine errors [8, 9], resulting in modulation of the beta
functions from 10% down to 1% or even less in more re-
cent facilities.

The ever increasing BPM resolution and computing
power made the analysis and correction of linear optics
(focusing error and betatron coupling) via measurements
of the orbit response matrix (ORM) a routine task in
basically all light sources worldwide. The inclusion of
TBT features in the BPM electronics and the reﬁne-
ment of the data analysis via several model-independent
techniques [10, 11] provided these facilities with a vi-
able alternative tool. However, systematic comparisons
between these two techniques on the same machine ap-

peared only recently (for the ALBA and SOLEIL stor-
age rings) [12, 13]: While both approaches evaluated the
measured beta beating in the 1% − 2% range with re-
spect to the ideal model, they diﬀered of about the same
quantity when compared against each other. System-
atic numerical simulations on the same lattice showed
indeed that the expected resolution of both approaches
is of about 1% [13, 14].

These observations fostered an intense debate (mostly
oral, during workshops, conferences or informal meet-
ings) on a series of questions:
i) Which is the best ap-
proach to measure the linear optics at 1% level of beta
beating?
ii) Why do the two methods predict diﬀer-
ent modulations of the optics functions and fail to con-
verge toward the same model? iii) Which is the ulti-
mate resolution at which lattice errors can be measured
and corrected? The community split in two main schools
of thoughts. The ORM-oriented group argues that the
higher BPM resolution of the orbit mode with respect to
the TBT setup provides the most reliable observable (the
ORM) and that the inferred model best reproducing it
can be trusted for the evaluation (and correction) of the
lattice parameters. The TBT-oriented school replies that
TBT data can be trusted more in the evaluation of beta
beating and betatron phase errors because these quanti-
ties are more direct observables, whereas their measure-
ments result from a series of model-dependent ﬁts when
orbit data are used.

This paper aims to help answer the above questions.
Even though the scrutiny of TBT data is limited here
to the harmonic analysis, the general ﬁnal conclusions
are expected to apply to other approaches, such as the
BPM matrix, the 1-turn or N-turn matrix. Each aspect is
quantiﬁed here by using the ESRF electron storage ring
as example: Even though numbers may vary in other fa-
cilities, the overall considerations should apply to other
machines with similar level of ultra-low coupling, diag-
nostics and beam stability. On the other hand, hadron
machines are not expected to be subjected to the same

conclusions, because their nonlinearities are weaker than
in modern light sources, i.e. they have a larger area in the
x-y plane within the linear regime of the betatron mo-
tion compared to storage rings like the ESRF’s. More-
over, analytic error estimates are derived here for the
TBT analysis only. No equivalent results are obtained
for the ORM approach, for which the only error study
presently available is based on the same numerical para-
metric scans of Ref. [14]. The scope of this comparison is
also limited to the analysis of lattice errors without en-
tering into the ﬁeld of diﬀerent correction schemes. The
analysis of practical considerations which may prevent
some facilities from using either technique is also out of
the scope of this paper, which is organized as follows. Af-
ter brieﬂy reviewing the main physical and mathematical
ingredients behind the two approaches in Sec. II, a more
detailed discussion on the validity of approximations and
assumptions proper of each method under typical mea-
surement conditions is presented in Sec. III. Cosequences
for the present and future ESRF storage rings are even-
tually outlined in Sec. IV. All mathematical derivations
have been put in separated appendices.

II. CURRENT APPROACHES TO THE

ANALYSIS OF LINEAR OPTICS ERRORS

As mentioned in the Introduction, two main strategies
are implemented in circular accelerators for the analysis
of linear lattice errors. The ﬁrst, which is routinely used
in probably all synchrotron-based light sources, is based
on the examination of the orbit response to a steering
angle. The second focuses on the analysis of free beta-
tron oscillations induced by a pulsed excitation and is the
preferred one in hadron circular accelerators.

In the ﬁrst approach, after introducing an orbit dis-
tortion via horizontal and vertical deﬂections, repre-
sented by two vectors ~Θx = (Θx,1, Θx,2, ..., Θx,NS ) and
~Θy = (Θy,1, Θy,2, ..., Θy,NS ), where Ns is the number of
available magnets, the horizontal and vertical orbits are
recorded at NB BPMs ~Ox = (Ox,1, Ox,2, ..., Ox,NB ) and
~Oy = (Oy,1, Oy,2, ..., Oy,NB ). They can be written as

~Oy (cid:19) = ORM(cid:18) ~Θx
(cid:18) ~Ox

~Θy (cid:19) , ORM =(cid:18) O(xx) O(xy)

O(yx) O(yy) (cid:19) ,

O(xx)

wj =

O(yx)

wj =

∂Ox,j
∂Θx,w
∂Oy,j
∂Θx,w

, O(xy)

wj =

, O(yy)

wj =

∂Ox,j
∂Θy,w
∂Oy,j
∂Θy,w

,

,

1 < j < NB ,

(1)

1 < w < NS

Optics codes such as MADX [17] or AT [18] can easily
compute ORM for the ideal (or initial) lattice model
and the diﬀerence between the measured and expected
matrix may be written as

δORM = ORM(meas) − ORM(ideal) .

(2)

The horizontal and vertical dispersion are also measured
and their diﬀerence with respect to the ideal model is

computed

~δDx,y = ~D(meas)

x,y

− ~D(ideal)

x,y

.

(3)

Both δORM and ~δDx,y depend linearly on the linear lat-
tice errors (i.e. from bending and quadrupole magnets).
By sorting the elements of each ORM block sequentially
in a vector, the dependence reads

δ ~O(xx)
δ ~O(yy)
δ ~Dx
δ ~O(xy)
δ ~O(yx)
δ ~Dy







 = Mnorm(cid:18) δ ~K1
δ ~K0 (cid:19) ,

 = Mskew(cid:18) ~θ(quad)
~θ(bend) (cid:19) .

(4)

(5)

δ ~K1 and δ ~K0 are the vectors containing the quadrupole
and dipole errors, respectively, whereas ~θ refers to the
magnet tilts. The latter may be replaced in Eq. (5) by
the corresponding skew multipolar components
J0 = −K0 sin (θ(bend)) . (6)
J1 = −K1 sin (2θ(quad)) ,
Throughout the paper, the MADX nomenclature for the
multipolar expansion of magnetic ﬁelds is adopted,

− ℜ"Xn

(Kw,n−1 + iJw,n−1)

(xw + iyw)n

n!

# ,

(7)

with K and J referring to the integrated normal and
skew magnetic strengths. The response matrices Mnorm
and Mskew can be computed by the optics codes. By
pseudo-inverting the above system, for instance via sin-
gular value decomposition (SVD), eﬀective models that
best ﬁt the measured ORM can be built. A unique model
may not be extracted, since a trade-oﬀ between accu-
racy (i.e.
large number of eigen-values in the decompo-
sition) and reasonableness of the errors (i.e. low number
of eigen-values to prevent numerical instabilities) shall
be ﬁxed on a subjective base. Moreover, the systems
of Eqs. (4)-(5) ignores contributions from the feed-down
eﬀects of quadrupoles and sextupoles induced by their
misalignments and/or oﬀ-axis orbit at their locations.
The closed orbit distortion resulting from this modelling
renders the analysis more complex without adding val-
ues to the physical observables (betatron phase φ and
amplitude β at the BPMs) and are usually absorbed
by additional dipole errors (accounting for quadrupole
misalignments) and quadrupole errors (representing the
quadrupolar feed-down in sextupoles).
In optics codes
dipole errors induce a distortion of the reference orbit,
though not of the closed one. Eqs. (4)-(5) are the core
of the Linear Optics from Closed Orbit (LOCO) analy-
sis [8, 9]. Additional ﬁt parameters may be included in
the r.h.s. of the two equations, such as calibration fac-
tors and rolls of steerers and BPMs. Once the errors
(δ ~K1, δ ~K0 and ~θ) are included into the lattice model,
the optical parameters (β, φ and D) are computed by

the optics codes and compared to the ones from the ideal
model. Beta beating and phase advance errors are the
most common ﬁgures of merit for focusing errors:

β(meas) − β(mod)

=

∆β
β
δφij = ∆φ(meas)

ij

β(mod)

− ∆φ(mod)

ij

, ∆φij = φj − φi

, (8)

1

where both quantities are evaluated at the BPM lo-
cations, with i and j two diﬀerent monitors, usually
(though not necessarily [19]) consecutive. A consensus
on a ﬁgure of merit for the evaluation of betatron cou-
pling has not yet been reached. In hadron machines the
amplitude of the diﬀerence resonance stop-band |C| is
widely used, [1]
2πI ds j(s)qβx(s)βy(s)e−i(φx(s)−φy(s))+i(s/R)∆Q ,

C =−
where j(s) represents the distribution of the non-
integrated skew quadrupole ﬁelds along the ring, R is the
machine radius, s is the longitudinal coordinate, β and
φ are the Twiss parameters of the uncoupled lattice, and
∆Q = Qx−Qy the fractional distance from the resonance
of the set tunes. |C| evaluated on the resonance (∆Q = 0)
corresponds to the minimum separation experienced by
In lepton cir-
the measured eigen-tunes |∆Qmin| [20].
cular accelerators the ratio between the two transverse
emittances ǫr = ǫy/ǫx is preferred, since any measurable
value of ǫy is usually generated by betatron coupling and
vertical dispersion. Both |C| and ǫr are global parame-
ters that prevent a detailed localisation and compensa-
tion of sources of coupling in light sources. To this end,
in Ref. [22] the coupling resonance driving terms (RDTs)
were proposed as ﬁgure of merit along with vertical dis-
persion,

f 1001

1010 , j =

W

Pw

Jw,1pβw,xβw,yei(∆φx,wj ∓∆φy,wj )

4(1 − e2πi(Qu∓Qv ))

+ O(J 2

1 ) .

(9)

Jw,1, w = 1, 2, 3... , W are the skew quadrupole in-
tegrated strengths present in the ring and originated
by quadrupole tilts, sextupole misalignments, insertion
devices, and corrector skew quadrupoles already pow-
ered. βw is the beta function at the source of coupling
w, while ∆φwj denotes its phase advance with respect
to the BPM j. Qu,v are the measurable eigen-tunes,
which are, in ﬁrst approximation, equal to the set tunes:
Qu,v = Qx,y + O(J 2
w,1). ∆φwj is the phase advance
between the source of coupling w and the BPM j where
the RDTs are computed. These two RDTs can be
evaluated (and minimized) at all BPMs from the model
obtained after ﬁtting the measured ORM and used to
evaluate (and reduce) the vertical emittance along the
ring, as shown in Ref. [22].

The second approach is based on the harmonic analysis
of turn-by-turn (TBT) free betatron oscillations induced

by a pulsed magnet. Forced oscillations generated for ex-
ample by an AC dipole are not discussed here. However,
to the ﬁrst order, and provided that the AC dipole driv-
ing frequency is suﬃciently separated from the tune, the
following analysis can be applied to both signals, either
free or forced. At each BPM, the TBT signal can be de-
composed in its main harmonics via a Fourier transform.
The main harmonic is found at a frequency correspond-
ing to the tune, whereas secondary harmonics appear at
linear combinations of both tunes, nxQx + nyQy, with
nx,y ∈ N, as reported in Fig.7 of Ref. [23]. Spectral lines
in the horizontal and vertical planes are usually denoted
as H(nx, ny) and V (nx, ny), respectively. The tune lines
at the BPM j read

H(1, 0)j,β =Cx,jq2Ixβ(meas)
V (0, 1)j,β =Cy,jq2Iyβ(meas)

x,j

y,j

cos (2πN Qx +φ(meas)

cos (2πN Qy +φ(meas)

x,j +ψx0)
.
y,j +ψy0)

j

ψ0 is an arbitrary initial phase equal for all BPMs (pro-
vided that the latter are perfectly synchronized in time),
N is the turn number, φ(meas)
is the BPM betatron phase
and 2I is the invariant (i.e. the action) proportional to
the strength of the pulsed excitation. The BPM calibra-
tion factor Cj is added to account for values potentially
diﬀerent from 1. By performing the harmonic analysis on
the TBT signal normalized by the model beta function,
the horizontal tune line reads
H(1, 0)j,β

xj

= H(1, 0)j ,




An equivalent expression applies to the vertical plane. At
the ESRF the same ﬁltered and interpolated Fast Fourier
Transfort (FFT) of Ref. [24] is used to extract amplitude
and phase of this harmonic, namely

|H(1, 0)j| =

1

2Cx,jvuut2Ix

β(meas)
x,j
β(mod)
x,j

,

(11)

ΦH(1,0)j = φ(meas)

x,j

+ ψx0

The invariant may be inferred by averaging the tune line
amplitude over all BPMs, provided that their number
and location are suﬃcient to cancel the contribution of
the modulation of beta function and calibration factors,

p2Ix ≃ 2 < |H(1, 0)| > , p2Iy ≃ 2 < |V (0, 1)| > . (12)

The actual beta functions β(meas) can be extracted from
Eqs. (11)-(12), according to

β(meas)
x,j

β(meas)
y,j

≃ β(mod)

x,j (cid:18) |H(1, 0)j|
y,j (cid:18) |V (0, 1)j|
≃ β(mod)

< |H(1, 0)| >(cid:19)2 1
C2
< |V (0, 1)| >(cid:19)2 1
C2

x,j

y,j

.

(13)

˜xj =

−→

x,j

qβ(mod)
H(1, 0)j =Cx,jvuut2Ix

qβ(mod)

x,j

β(meas)
x,j
β(mod)
x,j

(10)

cos (2πN Qx +φ(meas)

x,j +ψx0) .

The uncomfortable dependence on the calibration factors
in the above formulas motivated the search for an alter-
native way to extract β(meas) from the tune line. The
BPM phase Φ of Eq. (11) turns out to be independent
of both C, BPM rolls and betatron coupling. Because of
this robustness, Φ was used in Ref. [3] to derive a diﬀer-
ent formula. The ﬁrst observation is that the betatron
phase advance ∆φij between two BPMs is equal to the
diﬀerence of the tune line phases, namely

∆ΦH,ij = ΦH(1,0)j − ΦH(1,0)i = ∆φx,ij
∆ΦV,ij = ΦV (0,1)j − ΦV (0,1)i = ∆φy,ij

,

(14)

the initial phases ψx0,y0 of Eq. (10) canceling out. By
assuming that the region between three BPMs is free
from unknown focusing errors, the following formula was
derived in Ref. [3] to compute the beta function at the
ﬁrst BPM from the measured and model phase advances
between three monitors:

tively:




1010,j

1010,j

Fxy,j = f1001,j − f ∗
Fyx,j = f ∗
1001,j − f ∗
|Fxy,j| = |H(0, 1)j|/(2|V (0, 1)j|)Cy,j/Cx,j
|Fyx,j| = |V (1, 0)j|/(2|H(1, 0)j|)Cx,j/Cy,j
qFxy,j = arg{H(0, 1)j} −
qFyx,j = arg{V (1, 0)j} −

π − arg{V (0, 1)j}
π − arg{H(1, 0)j}

3
2
3
2

,

(16)

where the possible dependence on the BPM calibration
In (hadron) machines
factors has been made explicit.
where |f1010| ≪ |f1001|, Fxy ≃ F ∗
yx ≃ f1001 and a
calibration-independent formula to measure the ampli-
tude of the RDT reads [25]

|f1001| ≃

1

2s|H(0, 1)||V (1, 0)|
|H(1, 0)||V (0, 1)|

.

(17)

β(meas)
1

= β(mod)

1

cot ∆φ(meas)
cot ∆φ(mod)

12

12

III. LIMITS OF THE CURRENT APPROACHES

.

(15)

A. ORM analysis: model-dependent and

time-consuming

13

− cot ∆φ(meas)
− cot ∆φ(mod)

13

The above relation applies to both transverse planes and
is independent of any BPM calibration factor and roll.
Even though originally conceived to work on three con-
secutive BPMs, it provides more robust results if several
sets of triplets are used to apply Eq. (15) ﬁrst, and the
corresponding beta functions are properly averaged after,
as shown in Ref. [19].

As far as betatron coupling is concerned, the same
RDTs of Eq. (9) can be measured independently only if
the harmonic analysis is performed on the complex sig-
nal of the Courant-Snyder (C-S) coordinates ˜x− i˜px (and
˜y − i˜py) [23], whereas the harmonic analysis discussed
here is carried out on the real signals ˜x (˜y) of Eq. (10).
The momentum ˜p can be inferred by combining the po-
sition data of two BPMs [29] under the assumption that
the invariant is constant between the two monitors. The
presence of sextupoles and higher-order multipoles be-
tween two BPMs does alter the invariant, though this
change is a higher order deformation that should not af-
fect the linear analysis. On the other hand, the presence
of coupling sources introduces a partial exchange of the
two betatron invariants 2Ix,y [21]. This introduces a sys-
tematic error in the reconstruction of the momenta ˜px,y,
which is proportional to the coupling RDTs(i.e. to the
unknown quantity to be measured), with the risk of cor-
rupting the analysis of the betatron coupling. In Ref. [23]
it is shown that combined coupling RDTs, Fxy and Fyx
can be measured at each BPM j from the two coupling
harmonics of ˜x and ˜y, i.e. H(0, 1) and V (1, 0), respec-

The retrieval of lattice parameters from the analysis
of the closed orbit requires twice the employment of the
computer lattice model: ﬁrst in the ﬁt of the measured
ORM, Eqs. (4)-(5), then in computation of the new lat-
tice parameters for the evaluation of beta beating and
phase advance errors of Eq. (4). Moreover, the analy-
sis of orbit data is sensitive to BPM calibration factors,
though eﬀective coeﬃcients can be inferred during the
analysis of the ORM. This strong dependence on the ini-
tial lattice model, along with numerical issues related to
possible degeneracies between ﬁtting parameters, is con-
sidered by some as an intrinsic weakness of the ORM
analysis.

Another drawback of the ORM analysis is its lengthy
procedure for a single measurement and analysis. The ac-
quisition typically foresees a sequence of current changes
in orbit correctors and the retrieval of the correspond-
ing orbit data.
In the ESRF storage ring, this phase
takes about 10 minutes for a partial ORM (32 out of
192 steerers), or 1 hour for a complete one.
In larger
machines such as the Large Hadron Collider (LHC) of
CERN the time needed to scan the entire magnetic cycle
makes this approach unsuitable for operational purposes.
However, a new approach making use of alternating cur-
rent steerers, fast BPM acquisition system (at 10 kHz)
and harmonic analysis of orbit data was proved to obtain
the same measurement with simultaneous magnet exci-
tations at diﬀerent frequencies, hence reducing dramati-
cally the measurement time [16]. Still, superconducting
machines like the LHC may not beneﬁt from this varia-
tion. The analysis too is quite time consuming, since the

responses Mnorm and Mskew of the ORM on the lattice
errors (δKs and θs) in Eqs. (4)-(5) is computed by sim-
ulating an ORM for each error: A heavy computation
already for the ESRF storage ring with 256 quadrupoles
and 64 dipoles, which can only become more lengthy in
larger machines and future light sources.

B. TBT analysis: error analysis of Eq. (15)

Eﬀorts have been made in the last three decades to
conceive measurement techniques (as much as possible)
independent of the initial computer model. Eq. (15) was
derived in the 90s along with other handy expressions
for the reconstruction of lattice parameters from TBT
data in a way to be independent of the BPM calibra-
tion factors [3]. Moreover, the dependence on the initial
model was smartly limited optics functions only (i.e. of
β(meas) starting from β(mod) and ∆φ(mod)). The Model
Independent Analysis (MIA) of Ref. [10, 26, 27] and the
more recent Independent Component Analysis (ICA) of
Ref. [11, 28] proposed a statistical approach to extract
the same lattice parameters with no a priori knowledge
of the initial model. All these advancements were suc-
cessfully applied to many circular accelerators across the
world. However, the autonomy from the initial model to
ﬁt and/or interpret the measured TBT data comes to the
price of forcing the description of the same data accord-
ing to some hypothesis, assumptions or approximations,
of which more will be said in Sec. III F.

As mentioned in the previous section, Eq. (15) assumes
that no quadrupole error is present between the three
BPMs. In Appendix A an extension of that formula not
requiring this hypothesis is derived up to the ﬁrst order
in the ﬁeld errors δK1:

β(meas)
1

= β(mod)

1

cot ∆φ(mod)
+O(δK 2
1 )

,

12

cot ∆φ(meas)
12 −cot ∆φ(mod)

−cot ∆φ(meas)

13

13

+ (¯h12−¯h13)
(18)

from MADX:  rms= 5.0%(H) 3.5%(V)   p-t-p= 25%(H) 15% (V)
from Eq.(15)
from Eq.(18)

15
10
5
0
-5
-10
-15
10

5

0

-5

]

%

[
 
β
/
β
∆

 
l

a

t

n
o
z
i
r
o
h

]

%

[
 
β
/
β
∆

 
l

a
c
i
t
r
e
v

-10

0

1

0.5

0

-0.5

-1

1

0.5

0

-0.5

-1

0

28

56

84

112

140

168

196

224

BPM number

MADX - from Eq.(15): rms=0.25%  p-t-p=2.1%
MADX - from Eq.(18): rms=0.06%  p-t-p=0.9%

28

56

84

112

140

168

196

224

BPM number

]

%

[
 
β
/
β
∆

 
l

a

t

n
o
z
i
r
o
h

]

%

[
 
β
/
β
∆

 
l

a
c
i
t
r
e
v

FIG. 1. (Color) Top: Beta beating induced by a typical set of
errors in the ESRF storage ring as computed by MADX and
the two formulas Eqs. (15) and (18). rms stands for “root-
mean square”, p-t-p for “peak-to-peak”. Bottom: diﬀerence
between the real beating (MADX) and one obtained from two
formulas: In this example, the new Eq. (18) is four time more
accurate than Eq. (15). A pity ¯hij is not observable and
Eq. (18) may not be used for measurements!

¯hij = ∓ Xi<w<j

β(mod)
w

δKw,1 sin2 ∆φ(mod)

wj

sin2 ∆φ(mod)

ij

,

(19)

along the rest of the ring, see discussion after Eq. (A33)
of Appendix A.

where the sum runs over all quadrupole errors between
the BPMs i and j. The sign depends on the plane: neg-
ative for x, positive for y.

If no error is present between the three BPMs, Eq. (15)
is retrieved as expected. A special case where this equa-
tion still applies even in the presence of strong localized
focusing errors is when ¯h13 = ¯h12 6= 0. More generally, it
remains a robust approximation whenever the beating in-
duced by the quadrupole errors between three BPMs has
a minor impact on the cotangent of their phase advance,
|, or when it is
much smaller than the one generated by focusing glitches

|¯h13 − ¯h12| ≪ | cot ∆φ(mod)

− cot ∆φ(mod)

12

13

In the upper plot of Fig. 1 an example is shown with
the beta beating computed for a typical set of linear lat-
tice errors in the ESRF storage ring. The beating is ﬁrst
computed by MADX, then the BPM phase advances are
used to evaluate it with the existing formulas of Eq. (15),
and eventually the ¯hij are also calculated from the model
and applied to Eq. (18). The latter turns out to be more
accurate than the former (see bottom plot of Fig. 1).
Unfortunately, Eq. (18) is of no help in improving the
measurement of the beta beating, since ¯hij is not an ob-
servable. However, once the error model is built, it can be
computed a posteriori and used to estimate the accuracy
(i.e. systematic error bars) of the direct measurement via

Eq. (15), which reads

δβmeas

β

=

βEq.(15) − βEq.(18)

βEq.(18)

≃

¯h13 − ¯h12

cot ∆φ(mod)

12

− cot ∆φ(mod)

13

.

(20)

An interesting feature of the above expression is that
it depends on the ideal lattice parameters (φ(mod) and
β(mod)) and the ﬁeld deviations δK1 only. Hence it does
not require the evaluation of the new optics induced by
the errors. This may accelerate the estimation of the
systematic errors from the statistical analysis of various
error distributions along large rings, as in Ref. [19].

In the derivation of Eq. (18), other handy formulas for
the evaluation of C-S parameters modiﬁed by focusing
errors have been obtained,






x,j

βxj ≃ β(mod)
αx,j ≃ α(mod)
∆φx,ij ≃ ∆φ(mod)

(1 + 8ℑ{f2000,j})
(1 + 8ℑ{f2000,j}) − 8ℜ{f2000,j}
x,ij −2hx,ij + 4ℜ{f2000,j − f2000,i}

x,j

y,j

βyj ≃ β(mod)
αy,j ≃ α(mod)
∆φy,ij ≃ ∆φ(mod)

(1 + 8ℑ{f0020,j})
(1 + 8ℑ{f0020,j}) − 8ℜ{f0020,j}
y,ij −2hy,ij + 4ℜ{f0020,j − f0020,i}

y,j

,

(21)

,

where the focusing RDTs f2000 and f0020 are deﬁned
deﬁned in Eqs. (A2) and (A36), while explicit expres-
sions for the detuning coeﬃcients hij can be found in
Eq. (A18). Even though the RDTs are complex quanti-
ties, only their real (ℜ) and imaginary (ℑ) parts enter in
the above equations, whose reminders are proportional
to f 2.

C. TBT analysis: error analysis of Eq. (13)

In Appendix A, a more general version of Eq. (13) is

derived, namely

β(meas)
x,j

β(meas)
y,j

= β(mod)

< |H(1, 0)| >(cid:19)2

x,j (cid:18) |H(1, 0)j|
×
[1 + 2(< Ex > −Ex,j) + O(E 2
x)] ×
[1 + 64 < |f2000|2 > +O(|f2000|3)]
y,j (cid:18) |V (0, 1)j|
×
[1 + 2(< Ey > −Ey,j) + O(E 2
y )] ×
[1 + 64 < |f0020|2 > +O(|f0020|3)]

< |V (0, 1)| >(cid:19)2

= β(mod)




, (22)

Cx,y = 1 + Ex,y

,

0 ≃ Ex,y ≪ 1

where < |f|2 > and < E > represent the averaged val-
ues (over all BPMs) of the amplitudes of focusing RDTs
squared and calibration errors, respectively. Unless these
are determined by independent measurements, they can-
not be disentangled and are not observable. A (rude)

zero-order truncation is then needed in order to apply
Eq. (22) to real data, yielding to

βx,j = β(mod)

βy,j = β(mod)

x,j (cid:18) |H(1, 0)j|
y,j (cid:18) |V (0, 1)j|

< |H(1, 0)| >(cid:19)2
< |V (0, 1)| >(cid:19)2

+ O(Ex,|f2000|2)

+ O(Ey,|f0020|2)

. (23)




D. TBT analysis: Eq. (13) Vs Eq. (15)

Eq. (23) shows that the error of Eq. (13) is proportional
to the calibration error E and to square of the RDTs |f|2.
Since the latter are, to the ﬁrst order, linearly dependent
on the focusing errors, the error of Eq. (13) scales with
δK 2
1 , whereas the uncertainty of Eq. (15) scales with δK1,
as indicated by Eq. (20). From a purely theoretical point
of view, hence, either formula is to be preferred to the
other according to the largest source of uncertainty. If
BPM calibration errors E are either unknown or expected
to be larger than ¯hij of Eq. (19) (i.e. of the focusing errors
between three BPMs), beta functions are better inferred
by Eq. (15). If the opposite is true, then Eq. (13) is to
be preferred.

As far as the ESRF storage ring is concerned, BPM
calibration factors are routinely ﬁtted from the analysis
of measured ORM. In the top plot of Fig. 2 the mean val-
ues over 32 measurement repeated during one whole year
of operation are displayed along with the error bars rep-
resenting their standard deviation. The rms (systematic)
BPM gain error is of about 0.7% (2.7% maximum), with
rms (random) error bars below 0.1%.
It is worthwhile
noticing that these calibrations factors refers to Libera
BPMs operating in slow (orbit) acquisition mode and
that they may vary in the fast (TBT) acquisition mode.
In the bottom plot of Fig. 2 the variation of the RDT am-
plitudes along the ring is showed for the same lattice error
of Fig. 1. With < |f2000| > of about 0.9% (2.1% maxi-
mum),which is larger than < |f0020| >, the RDT-related
rms uncertainty 64|f|2 of Eq. (22) is then of about 0.6%
(2.8% maximum).
The bottom plot of Fig. 1 shows the error of Eq. (15)
associated to δK1 via the ¯hij: 0.25% rms (2.1% peak-to-
peak). Even admitting that the BPM calibration factors
of Fig. 2 are applicable to TBT data and can be used
in Eq. (13), this formula is expected in any case to be
less precise (residual rms error of 0.6%) than Eq. (15)
(residual rms error of 0.25%). For storage rings with
lower rms beta beating (which is of about 5% at the
ESRF) the opposite might be true.

The above considerations are rather mathematical and
other aspects are to be taken into account when selecting
the best approach for the evaluation of the beta function.
First, Eq. (15) relies on the perfect synchronization be-
tween all BPMs, i.e. BPM reporting on the same turn
and on the same bunch. Any systematic delay or jit-
ter (even of a tiny fraction of revolution frequency) be-
tween the BPM data acquisition, would result in an arti-

mean and std from 32 ORMs measured in 2011

horizontal:  error rms=0.73%  p-t-p=3.5%
vertical:      error rms=0.69%  p-t-p=3.0%

E. ORM and TBT analysis: impact of BPM

resolution and ultra-low coupling

 
 
s
r
o

t
c
a

f
 

n
o

i
t

a
r
b

i
l

a
c
 
M
P
B

1.03

1.02

1.01

1

0.99

0.98

]

%

[
 
e
d
u
t
i
l

p
m
a
 
T
D
R

2.5

2

1.5

1

0.5

0

0

0

28

56

84

112

140

168

196

224

mean and std from 32 ORMs measured in 2011

BPM number 

2000

|f       | mean=0.9%  max=2.1%
|f       | mean=0.5%  max=1.5%

0020

Ideally, ORM and TBT should be generated by excit-
ing the beam (with orbit correctors and dipole kickers, re-
spectively) so to optimize the signal-to-noise ratio, while
remaining in the linear regime of the betatron motion.
In this section rough estimates of the beam excitation
amplitudes ensuring suﬃcient resolution are provided for
the ESRF storage ring equipped with commercial Libera
Brilliance BPMs and operating with ultra-low coupling,
i.e. with a ratio between the betatron equilibrium emit-
tances Ex/Ey ≃ 1‰. The question whether these ampli-
tudes remain in the linear regime or not is addressed in
the next sections.

ORMs are measured by using the BPMs in the slow-
mode acquisition (10 Hz), which ensures a resolution of
about 10 nm. Specialists prefer to deﬁne the BPM res-
olution as integrated noise spectrum or integrated rms
noise [32, 33], denoted as measured uncertainty for fre-
quencies integrated from 0.1 Hz or 1 Hz up to a spec-
iﬁed bandwidth and represented by a spatial resolution
per square root of the bandwidth (the noise being typi-
cally expected to be white so that the measurement error
would decrease with the square root of the bandwidth).
For the Libera Brilliance BPMs, the typical value in slow-
mode acquisition is 10 nm/√Hz. Since the resolution de-
pends on the beam intensity too, ORMs are measured at
30mA, which ensure suﬃcient beam signal while remain-
ing low enough to prevent beam induced eﬀects on the
orbit motion. The rms orbit distortion is of 200-250 µm
in the plane of the steerer, 2-5 µm in the other one be-
cause of the ultra-low coupling achieved in the machine.
Despite this low orbit distortion in the orthogonal plane,
data remain more than two orders of magnitude above
the noise ﬂoor (10 nm), permitting a reliable coupling
measurement.

28

56

84

112

140

168

196

224

BPM number 

FIG. 2. (Color) Top: ESRF’s eﬀective BPM calibration fac-
tors Cx,y inferred from the analysis of the orbit response
matrix, averaged over 32 measurements repeated during one
whole year of operation. The error bars represent their stan-
dard deviation. Bottom : variation of the focusing RDT am-
plitudes along the ESRF storage ring for the same lattice error
of Fig. 1.

ﬁcial BPM phase advance error, since the initial arbitrary
phase ψ0 of Eq. (10) would be no longer the same for all
BPMs and, hence, not canceled out in Eq. (14).

∆Φij = ∆φij + δφ(tim)

ij

,

(24)

ij

where δφ(tim)
is the phase error introduced by the moni-
tors relative delay. The BPMs in the ESRF storage ring,
for instance, are synchronized within about 0.1 µs (peak-
to-peak) over a revolution time of 2.82 µs. Eq. (13) does
not suﬀer from such a constraint and would work even
with BPMs reporting on diﬀerent turns. Second, the
presence of trigonometric functions in the denominator
of Eq. (14) requires that BPMs are separated by a phase
advance away from either zero or multiples of π, to pre-
vent the cotangent from becoming inﬁnite. If this is the
case, the triplet can be deﬁned by using BPMs further
downstream, as indicated in Ref. [19]. This may come to
the price of increasing the number of sources of focusing
errors between the BPMs, i.e. ¯hij , and in turn the mea-
surement error of Eq. (20). Eq. (13) is not aﬀected by
the relative position of the BPMs.

TBT data are acquired by switching the BPMs into
the fast-acquisition mode (10 kHz), whose expected res-
olution is in the µm range. Two independent evaluations
of the noise ﬂoor with beam (one recording TBT data of
the unperturbed beam, the other via SVD of the BPM
matrix) indicate that the actual noise ﬂoor is of about
10 µm. This accounts also for the natural beam mo-
tion which can be corrected by a fast orbit correction
scheme during operation but not during the acquisition
of TBT data (the method requires free oscillations). The
resolution of TBT data is then three orders of magni-
tude worse than in the ORM measurement. This has a
dramatic consequence in the minimum beam excitation
necessary for a robust evaluation of coupling via TBT
data. This is performed by analyzing the coupling lines
of the TBT spectrum, H(0, 1) and V (1, 0) of Eq. (16),

vertical
plane

V(0,1)@0.39

F. TBT analysis: Can higher-order terms may be

really neglected?

]
s
t
i
n
u
 
y
r
a
r
t
i
b
r
a
[
 
e
d
u
t
i
l

p
m
a
 
T
F
F

]
s
t
i
n
u
 
y
r
a
r
t
i
b
r
a
[
 
e
d
u
t
i
l

p
m
a
 
T
F
F

1e-02

1e-03

1e-04

1e-05

1e-06

1e-02

1e-03

1e-04

1e-05

1e-06

tune line
coupling line

horizontal

plane

H(1,0)@0.44

H(0,1)
@0.39

0

0.05

0.1

0.2

0.35
0.15
frequency [tune units]

0.25

0.3

0.4

0.45

0.5

tune line
coupling line

horizontal

plane

H(1,0)@0.44

H(0,1)
@0.39

0

0.05

0.1

0.2

0.35
0.15
frequency [tune units]

0.25

0.3

0.4

0.45

0.5

1e-02

1e-03

1e-04

1e-05

1e-06

1e-02

1e-03

1e-04

1e-05

1e-06

0

0.05

0.1

0

0.05

0.1

V(1,0)
@0.44

0.4

0.45

0.5

0.2

0.15
0.35
frequency [tune units]

0.25

0.3

vertical
plane

V(0,1)@0.39

V(1,0)
@0.44

0.4

0.45

0.5

0.2

0.15
0.35
frequency [tune units]

0.25

0.3

The harmonic analysis of TBT data discussed here,
as well as other techniques analyzing the BPM matrix,
assumes that the tune line (or the betatron mode) is ex-
clusively generated by quadrupolar terms, independent
of the initial oscillation amplitude.

In Appendix B more general expressions for the tune
line amplitude and BPM phase advance in the nonlinear
(amplitude dependent) regime are derived. The result is

∆ΦH,ij = ∆φ(mod)

∆ΦV,ij = ∆φ(mod)

x,ij + arg{Bx,i − Bx,j} − 2h1100,ij

− 2h1111,ij(2Ix) − 4h0022,ij(2Iy)

− 4h2200,ij(2Ix) − 2h1111,ij(2Iy)


y,ij + arg{By,i − By,j} − 2h0011,ij

√2Ix

|H(1, 0)j| =
2
|V (0, 1)j| = p2Iy

(Bx,j =1+i4f ∗

2 , K3, Ix,y)+TH,j(K 2
2 , K3, Ix,y)+TV,j(K 2

2000,j+iFxx,j(K 2
0020,j+iFyy,j(K 2

By,j =1+4if ∗

|Bx,j|

|By,j|

2

,

,

(26)

2 , Ix,y)
2 , Ix,y)

.

The functions F and the octupolar-like amplitude de-
pendent detuning terms h are proportional to octupolar
ﬁelds (∝ K3) and to quadratic functions of sextupole
strengths (∝ K 2
2 ), whereas T scales quadratically with
K2.

The above expressions indicate that when the initial
oscillation amplitude (2I) is too large, the betatron BPM
phase advance ∆φij is no longer measurable from the dif-
ference of the tune line phases ∆Φij, since (octupolar-
like) amplitude dependent focusing terms corrupt the
tune line. The same is true for the invariant itself (2I),
which is no longer measurable from the tune line ampli-
tude. In fact, the latter is not anymore constant along
the ring and its modulation depends on the invariant it-
self via the functions F and T of Eq. (26).

There are two ways to estimate the maximum accept-
able initial oscillation preventing nonlinearities from pol-
luting the linear analysis of the tune line. The ﬁrst is
to evaluate the explicit expressions for B and h from
the nonlinear lattice model. The second is to perform
the harmonic analysis of single-particle tracking. To this
end, it is enough to compare the tune line modulation and
the deviation of the BPM phase advance ∆Φij from the
betatron phase ∆φij for an ideal model with no focusing
error. By repeating this test for several initial condi-
tions, a threshold can be set to ensure a certain limit to
the pollution. In Fig. 4 the results of four diﬀerent tests
are reported for the horizontal tune line. The impact on
the vertical tune line is weaker because of the stronger
horizontal focusing and chromaticity which result in a
stronger impact of nonlinearities in that plane. A single
particle has been tracked through the ideal lattice (i.e.
with no focusing error, f2000 = f0020 = 0 along the ring)

FIG. 3.
(Color) Examples of spectra from measured TBT
BPM data of the ESRF storage ring. Because of the ultra-
low coupling, data with an initial excitation of 1 mm (βx = 35
m) and 0.3 mm (βx = 3 m) result in coupling lines close to
the background noise (top plots). In order to limit the latter
to about 2% of the coupling lines, the initial oscillations need
to be tripled (bottom plots).

whose amplitudes in real units [m] read

|H(0, 1)|[m] = 2s βx
|V (1, 0)|[m] = 2s βy




βy × |V (0, 1)|[m] × |Fxy|

.

(25)

βx × |H(1, 0)|[m] × |Fyx|

The beta functions at the BPMs are such that both
square roots in the above expressions range between 0.4

and 2.8: pβx,y/βy,x ∼ 1 can be then assumed. Because
of the ultra-low coupling, the amplitudes of combined
RDTs |F| are of the order of 10−2. An excitation in both
planes of 1 mm (|H(1, 0)|[m] ∼ |V (0, 1)|[m] ∼ 10−3 m,
since these are by far the largest harmonics of the TBT
signal) would result then in coupling lines |H(0, 1)|[m] ∼
|V (1, 0)|[m] ∼ 10 µm, which is of the same order of mag-
nitude than the noise ﬂoor (see upper plots of Fig. 3).

In conclusion, even though a tune line of ∼ 1 mm would
suﬃce for a reliable analysis of focusing errors, the eval-
uation of ultra-low coupling via the secondary harmon-
ics would be rather inaccurate. Hence, unless the BPM
resolution in TBT mode and the natural beam stability
are signiﬁcantly improved, an initial oscillation of sev-
eral mm is necessary for a robust and complete study of
the linear lattice errors with TBT data (see lower plots
of Fig. 3). These numbers may of course be diﬀerent in
other 3rd generation (and more recent) light sources, but
the orders of magnitude are expected to be similar as long
as they operate with ultra-low coupling and comparable
BPM spectral background noise.

HORIZONTAL tune line amplitude and phase: true Vs FFT of TBT data

[single particle tracking over 1024 turns]

0

28

56

84 112 140 168 196 224

HORIZONTAL tune line amplitude and phase: true Vs FFT of TBT data

BPM #

[single particle tracking over 1024 turns]

]
d
a
r
m

[
 
r
o
r
r
e
 
e
s
a
h
p
 
M
P
B

9

6

3

0

-3

-6

-9

]
d
a
r
m

[
 
r
o
r
r
e
 
e
s
a
h
p
 
M
P
B

9

6

3

0

-3

-6

-9

]
d
a
r
m

 

[
 
r
o
r
r
e
e
s
a
h
p
M
P
B

 

9

6

3

0

-3

-6

-9

0

28

56

84 112 140 168 196 224

BPM #

0

28

56

84 112 140 168 196 224

BPM #

0

28

56

84 112 140 168 196 224

BPM #

x0=0.1 mm  y0=0.1 mm

0.9

0.6

0.3

0

-0.3

-0.6

]

%

[
 
 
n
o
i
t
a
u
d
o
m

l

 
|
)
0
,
1
(
H

|

x0=1.4 mm  y0=0.3 mm

0.9

0.6

0.3

0

-0.3

-0.6

]

%

[
 
 
n
o
i
t
a
u
d
o
m

l

 
|
)
0
,
1
(
H

|

x0=2.7 mm  y0=0.8 mm

0.9

0.6

0.3

0

-0.3

-0.6

]

%

[
 
 
n
o

i
t

l

a
u
d
o
m

,

 
|
)
0
1
(
H

|

0

28

56

84 112 140 168 196 224

HORIZONTAL tune line amplitude and phase: true Vs FFT of TBT data

BPM #

[single particle tracking over 1024 turns]

0

28

56

84 112 140 168 196 224

HORIZONTAL tune line amplitude and phase: true Vs FFT of TBT data

BPM #

[single particle tracking over 1024 turns]

0.9

0.6

0.3

0

]

%

[
 
 

n
o

i
t

l

a
u
d
o
m

,

 
|
)
0
1
(
H

|

-0.3

-0.6

x0=2.7 mm  y0=0.8 mm sextupoles OFF

]

d
a
r
m

 

[
 
r
o
r
r
e
e
s
a
h
p
M
P
B

 

9

6

3

0

-3

-6

0

28

56

84 112 140 168 196 224

BPM #

-9

0

28

56

84 112 140 168 196 224

BPM #

FIG. 4. (Color) Modulation of the horizontal tune line am-
plitude (left) and error of the BPM phase advance ∆Φx,ij
inferred from the tune line phase with respect to the beta-
tron BPM phase advance ∆φx,ij (right) obtained from single
particle tracking simulations with diﬀerent initial conditions.
The large BPM phase error observed at (x0, y0) = (2.7, 0.8)
mm (third row) disappears when nonlinear magnets are re-
moved from the lattice model of the ESRF storage ring (last
row). For the vertical tune line (not shown) amplitude mod-
ulation and phase errors are about a factor two and three
lower, respectively.

of the ESRF storage ring for 1024 turns. The positions
recorded at the 224 BPMs are Fourier analyzed and the
tune line amplitude is used to evaluate the modulation of
|H(1, 0)| (left plots) along the ring due to the nonlinear
terms F and T of Eq. (26). The tune line phase is used
to compute the BPM phase advance ∆Φij and its diﬀer-
ence with the betatron phase advance ∆φij is reported in
the right plots. The test is ﬁrst run for an extremely low
initial excitation of 100 µm in both planes (uppermost
plot), then (x0, y0) = (1.4, 0.3) mm (second plot) and
(x0, y0) = (2.7, 0.8) mm (third plot). Even though the
tune line modulation is relatively modest, below 0.3%
rms, an sizable deviation from the betatron phase ad-

vance of 2.6 mrad rms (6.6 mrad maximum), roughly
corresponding to an rms artiﬁcial beta beating of 1%, is
observed in the last case ((x0, y0) = (2.7, 0.8) mm). This
means that the linear analysis carried out in Ref. [23],
which ﬁtted quadrupolar errors from similar TBT data
to best match ∆φij and ∆φij up to 0.9 mrad rms, was in-
deed erroneous, since a great part of the initial deviation
came from the nonlinear terms of Eq. (26) and not from
quadrupolar errors. The conﬁrmation that such devia-
tions from the betatron parameters stem from nonlinear
magnets is given in the lower most plot, where both the
invariant and the betatron phase advance are retrieved
with the same initial conditions (x0, y0) = (2.7, 0.8) mm
after turning oﬀ all sextupoles and octupoles in the lat-
tice model.

The results of Fig. 4 have important consequences on
the possibility of using TBT data for a complete linear
analysis of the ESRF storage ring. The above simulations
indeed suggest to limit the initial oscillation amplitude
to about 1.4 mm horizontally and 0.3 mm vertically in
order to limit the nonlinear contribution to the BPM
phase to less than 0.5 mrad rms. On the other hand,
in Sec. III E it was shown that at this level of excitation
the coupling analysis via the spectral lines H(0, 1) and
V (1, 0) becomes inaccurate when the machine operates
(as it has been doing since 2010) with ultra-low coupling.

G. TBT analysis: which model BPM phase

advance?

A possible way out to this dilemma can be found in
replacing as reference betatron phase advance the one
computed from the lattice ∆φij (ptc_twiss command in
MADX or linopt function in AT) with the BPM phase
advance ∆Φ(SP T )
inferred from the harmonic analysis of
single-particle tracking simulations with the same oscil-
lation amplitudes of the measured data. The linear anal-
ysis could be then performed on the diﬀerence between
measured and model BPM phase advances, namely

ij

δ∆φij (δK1) ≃∆Φ(meas)
∆Φ(SP T )

ij

ij

(δK1, K2, K3, Ix,y) −
(K2, K3, Ix,y)

,

(27)

since in ﬁrst approximation (i.e. by ignoring sextupole
and octupole errors) the amplitude dependent nonlinear
terms B and hpprr of Eq. (26) would cancel out and the
diﬀerence would depend on quadrupole errors only via
δ∆φij .

By doing so, however, the quality of the linear analysis
would become dependent on the nonlinear lattice setting
and model, as well as on tracking parameters, since they
all aﬀect ∆Φ(SP T )
. In Fig. 5 the results of three numeri-
cal tests are reported for the same (linear and nonlinear)
optics of Fig. 1. The center plot shows how actually the
inclusion of nonlinear magnetic errors in the model does
indeed inﬂuence ∆Φ(SP T )
. A weak dependence on the

ij

ij

HORIZONTAL                                  VERTICAL

HORIZONTAL                                  VERTICAL

]

d
a
r
m

 

[
 
 
r
o
r
r
e
e
c
n
a
v
d
a
e
s
a
h
p
M
P
B

 

 

8
4
0
-4
-8

8
4
0
-4
-8

8
4
0
-4
-8

w/o octupoles & fringe fields, 4D tracking 

2.1 (rms)  7.7 (max)

with octupoles & fringe fields, 4D tracking

3.0 (rms)  11.6 (max)

with octupoles & fringe fields, 6D tracking + radiation

2.9 (rms)  11.9 (max)

]

m
m

[
 
 

a

t

a
d

 

n
r
u
t
-
y
b
-
n
r
u

t
 

d
e

t

l

a
u
m
s

i

2
1
0
-1
-2

2
1
0
-1
-2

2
1
0
-1
-2

special optics

multi-bunch optics

few-bunch optics

0

56

112

168

224

BPM #

280

336

392

448

0

500

1000

number of turns

1500

2000

ij

FIG. 5. (Color) BPM phase advance error ∆Φ(SP T )
− ∆φij
evaluated from single-particle simulations with initial condi-
tions (x0, y0) = (2.7, 0.8) mm against tracking parameters and
additional nonlinearities on top of the sextupoles: 4D tracking
with ideal sextupole setting (top), including the same nonlin-
ear lattice error model (sextupole errors, octupolar ﬁeld com-
ponent in quadrupoles and fringe ﬁelds) of Ref. [23] (center),
and 6D tracking including radiation eﬀects (bottom).

inclusion of longitudinal tracking with radiation eﬀects
can be also observed in the lower most plot.

It can be argued that the beam itself is not a single
particle and that its multi-particle nature and its ﬁnite
rms emittances (Ex = 4 nm, Ey = 4 pm, σp = 0.1% for
the ESRF electron beam) would require an even more re-
alistic approach to account for the damping of the TBT
signal of its centroid (i.e. decoherence) due to chromatic-
ity, amplitude dependent detuning [34–36] and possibly
radiation eﬀects. To this end, multi-particle tracking sim-
ulations and the harmonic analysis on the TBT motion
of the beam centroid could be performed to infer the cor-
responding BPM phase advance ∆Φ(MP T )

.

ij

In the top plots of Fig. 6 the simulated TBT signal at
one BPM is shown for three diﬀerent sextupole settings
of the ESRF storage ring: with low chromaticity and de-
tuning with amplitude (special optics, typically used for
TBT studies), with low chromaticity but large detuning
(multi-bunch optics), and high vertical chromaticity and
low detuning (few-bunch optics). Tracking is performed
in the transverse plane only (4D) with frozen longitudi-
nal motion and no radiation eﬀects. The decoherence is
much more visible in the horizontal plane because of the
much larger horizontal emittance compared to the verti-
cal plane. Simulations were run with no betatron cou-
pling. In the bottom plots of Fig. 6 the BPM phase dif-
ference between multi-particle and single-particle BPM
phase advance, ∆Φ(MP T )
, is plotted along
the ring : Deviations are more pronounced in the hori-
zontal plane (as expected from the stronger decoherence)
though they are a mere 10% of ∆φ(SP T )

− ∆φ(SP T )

of Fig. 5.

ij

ij

ij

Since the spectral resolution of the harmonic analysis
depends on the number of turns suitable to be Fourier-
analyzed, the quality of the linear analysis is expected

]

d
a
r
m

[
 
 

e
c
n
e
r
e

f
f
i

d

 
e
c
n
a
v
d
a
 
e
s
a
h
p
 
M
P
B

1

0

-1

1

0

-1

1

0

-1

HORIZONTAL                                  VERTICAL

dedicated optics

0.2 (rms)  1.2 (max)

multibunch optics

0.2 (rms)  1.1 (max)

few-bunch optics

0.1 (rms)  0.3 (max)

0

56

112

168

224

BPM #

280

336

392

448

FIG. 6.
(Color) Top: TBT beam centroid oscillation ob-
tained from multi-particle 4D tracking (Gaussian distribu-
tion, 5 × 104 particles, Ex = 4 nm, Ey = 4 pm, σp = 0.1%).
Three various sextupole settings of the ESRF storage ring are
tested: low chromaticity and weak detuning with amplitude
(special optics), low chromaticity and strong detuning (multi-
bunch optics), and high vertical chromaticity and weak detun-
ing (few-bunch optics). Bottom: corresponding BPM phase
advance deviation between the harmonic analysis of a multi-
particle TBT signals with respect its single-particle counter-
part, ∆Φ(M P T )

− ∆φ(SP T )

.

ij

ij

ij

to increase with the number of turns. This eﬀect is
displayed in Fig. 7, where the diﬀerence ∆Φ(MP T )
−
∆φ(SP T )
is showed for two diﬀerent nonlinear optics
against the number of turns used for the FFT. Diﬀerently
from Fig. 6, tracking is here performed in all planes (6D)
including radiation eﬀects. In both cases, when 512 or
more turns are analyzed multi-particle eﬀects appear to
account for a mere fraction of mrad.

ij

These and other multi-particle simulations conﬁrm
that the multi-particle eﬀects are negligible compared to
∆φ(SP T )
and that the latter can be eﬀectively used for a
linear analysis via Eq. (27), provided that a solid nonlin-
ear lattice model is available.

ij

HORIZONTAL                                  VERTICAL

derived:

3
2
1
0
-1
-2
-3

12
8
4
0
-4
-8
-12

 
]

m
m

[
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
]

d
a
r
m

[

t

 

 

a
a
d
T
b
T
d
e
a
u
m
s

t

i

l

e
c
n
e
r
e

f
f
i

d

 
.
v
d
a

 

e
s
a
h
p
M
P
B

 

3
2
1
0
-1
-2
-3

12
8
4
0
-4
-8
-12

 
]

m
m

[
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
]
d
a
r
m

[

 

t

a
a
d
T
b
T
d
e

 

t

l

a
u
m
s

i

e
c
n
e
r
e
f
f
i
d
 
.
v
d
a
 
e
s
a
h
p
 
M
P
B

0

250

500

750

1000
turn #

few-bunch optics

1250

1500

1750

2000

FFT(128):   rms error = 3.5 mrad
FFT(256):   rms error = 1.4 mrad
FFT(512):   rms error = 0.3 mrad
FFT(1024): rms error = 0.4 mrad

0

56

112

168

224

BPM #

280

336

392

448

HORIZONTAL                                  VERTICAL

0

250

500

750

special optics

1000
turn #

1250

1500

1750

2000

FFT(128):   rms error = 0.6 mrad
FFT(256):   rms error = 0.3 mrad
FFT(512):   rms error = 0.2 mrad
FFT(1024): rms error = 0.2 mrad

0

56

112

168

224

BPM #

280

336

392

448

ij

(Color) BPM phase advance error ∆Φ(M P T )
FIG. 7.
∆φ(SP T )
evaluated against the number of turns used in the
harmonic analysis for two diﬀerent sextupole settings, with
strong decoherence (top) and negligible attenuation (bottom).
The same multi-particle simulations of Fig. 6 is used, this time
with a full 6D tracking including radiation eﬀects.

−

ij

H. TBT analysis: Can beta beating and ultra-low
coupling be evaluated with separate measurements?

It can be argued that TBT analysis of focusing errors
and betatron coupling at the ESRF storage ring could
be carried out with two separate measurements: one at
low excitation amplitude for the evaluation and correc-
tion of beta beating only (with no or limited pollution
of the tune lines by nonlinear terms), and a second with
large oscillation to enhance the coupling spectral lines
well above the noise ﬂoor. While the ﬁrst measurement
is perfectly feasible, two mains obstacles prevent the sec-
ond from being viable.

First, at large amplitudes nonlinear terms aﬀect the
coupling spectral lines too. In Appendix C analytic ex-
pressions for the coupling lines of the real signals ˜x and
˜y including the leading amplitude dependent terms are

|H(0, 1)j|=(cid:12)(cid:12)Fxy,j(J1) + Txy,j(J3, K3, K 2

|V (1, 0)j|=(cid:12)(cid:12)Fyx,j(J1) + Tyx,j(J3, K3, K 2


arg{H(0, 1)j} = φx,j + ψx0 + arg{Fxy,j + Txy,j} −
arg{V (1, 0)j} = φy,j + ψy0 + arg{Fyx,j + Tyx,j} −

2 , J1, Ix,y)(cid:12)(cid:12)p2Iy
2 , J1, Ix,y)(cid:12)(cid:12)p2Ix

π
2
π
2
(28)

,

where the betatron coupling terms Fxy and Fyx are the
same of Eq. (16). The complex nonlinear amplitude
dependent coupling functions Txy and Tyx, deﬁned in
Eq. (C2), scale linearly with the skew octupole gradient
J3, as well as with the products K3J1 (cross product be-
tween normal octupole and skew quadrupole strengths)
and K 2
2 J1 (cross product between normal sextupole and
skew quadrupole ﬁelds). Hence, even in the absence of
physical octupoles, normal sextupoles excite Txy and Tyx
via betatron coupling. Since both Fxy and Fyx scale lin-
early with J1 too, the overall amplitude dependent mod-
ulation of the coupling lines scales quadratically with the
sextupole ﬁelds, i.e. with the same order of magnitude
of the tune line modulation Bx,y and hpprr of Eq. (26).
The analysis of the coupling lines to evaluate betatron
coupling at large amplitudes would then be corrupted by
the machine nonlinearities in the same way the study of
focusing errors from the tune lines would be.

√2Ix, |V (0, 1)| 6= p2Iy, arg{H(1, 0)} 6= φx + ψx0 and

Second, the tune lines are used to extract the cou-
pling RDTs f1001 and f1010 (or their combined func-
tions Fxy and Fyx) via Eqs. (16)-(17).
If a large exci-
tation is imparted to generate measurable coupling lines,
the nonlinear terms contributing to the tune line am-
plitudes and phase, Bx,y of Eq. (26), would corrupt
the evaluation of the coupling RDTs, since |H(1, 0)| 6=
arg{V (0, 1)} 6= φy + ψy0.
An example of betatron coupling analysis corrupted by
nonlinear terms is shown in Fig. 8. The harmonic decom-
position is carried out on simulated single-particle TBT
BPM data with the lattice of the ESRF storage ring com-
prising 64 skew quadrupoles distributed along the ring,
whose normalized integrated strengths J1 are reported
in the upper plot. By assuming that the coupling lines
H(0, 1) and V (1, 0) are generated only by betatron cou-
pling terms Fxy and Fyx, respectively, the latter are in-
ferred and used to extract the strengths of the 64 skew
quadrupoles by pseudo-inverting the system of Eqs. (16)
and (9). This exercise has been repeated for three diﬀer-
ent sextupoles settings and at diverse initial excitations.
The errors remain in the few percent level when the ini-
tial displacement is of about 1 mm (center plot), though
this amplitude is too low for real measurements. How-
ever, when simulating oscillation amplitudes suﬃcient to
generate measurable coupling spectral lines, the rms er-
ror ranges from 25% to 100% depending on the nonlinear
setting (bottom plot). When turning oﬀ all sextupoles in
the lattice (along with any other nonlinearities) the rms
error remains well below 0.5% for any initial condition.

]

m

/
3
 
 
-
0
 
 
1
 
[
 

d
e

l

i
f

2
1
0
-1
-2

]

m

/
3
 
 
-
0
 
 
1
 
[
 

n
o

i
t
c
u
r
t
s
n
o
c
e
r
 

d
e

l

i
f
 

n

i
 
r
o
r
r
e

0.08
0.04
0
-0.04
-0.08
2
1
0
-1
-2

expected corrector skew quadrupoles

(x0,y0)=(1.3,0.4)mm

error with special optics
error with multi-bunch optics
error with few-bunch optics

(x0,y0)=(4.6,1.6)mm
16

8

0

24

32

BPM #

40

48

56

64

FIG. 8.
(Color) Example of simulated betatron coupling
analysis corrupted by nonlinear terms. The coupling lines
H(0, 1) and V (1, 0) of simulated single-particle TBT BPM
data with the lattice of the ESRF storage ring comprising 64
skew quadrupoles (top plot) are assumed to be excited by lin-
ear coupling functions Fxy and Fyx only. They are inferred
via Eq. (16) and the skew quadrupole strengths retrieved by
pseudo-inverting the system via Eq. (9). At low amplitude
the diﬀerence between set and reconstructed skew quadrupole
ﬁelds is of a few percent (center plot), while at large initial
excitation it increases to 25% and 100% depending on the sex-
tupole settings (bottom plot). When sextupoles are turned oﬀ
in the model (which does not comprise octupoles), the errors
remains well below 0.5% (not shown), irrespective of the ini-
tial conditions.

IV. CONCLUSION

Analytic formulas for the evaluation of linear lattice
parameters from either turn-by-turn beam position data
or an error lattice model have been derived and used to
perform an error analysis. This study also presented a
procedure for the estimation of detrimental eﬀects of non-
linear terms stemming from sextupoles and higher order
multipole magnets. These may result in a wrong evalua-
tion of the BPM phase advance and hence of the focus-
ing errors. Preliminary single-particle simulations how-
ever would suﬃce to properly account for such nonlinear
terms.
It has been also shown how beam decoherence
does not corrupt the evaluation of the BPM phase ad-
vance, the error found in multi-particle simulations being
the same determined by single-particle tracking (within
a 10% uncertainty).

The elements presented in this paper indicate that for
the ESRF electron storage ring operating with ultra-low
coupling and making use of the Libera Brilliance BPMs,
the analysis of the linear lattice errors (focusing and cou-
pling) is limited in its accuracy and precision by several
factors. As a rule of thumb, 3 mrad of rms BPM phase
advance error correspond to about 1% of rms beta beat-
ing. The ORM analysis is to be preferred to the harmonic
study of TBT data for several reasons:

• The ORM analysis of focusing errors and cou-
pling requires a maximum beam excitation of about
250 µm well within the linear regime of the beta-
tron motion.

• Because of the natural beam motion (vibrations),
the worse BPM resolution when operating in TBT
mode and the need of measuring an ultra-low cou-
pling, the harmonic analysis requires a minimum
beam excitation of some mm, reaching a region of
the betatron motion where magnetic nonlinearities
reduce the measurement accuracy in the range of
2-6 mrad for the rms BPM phase advance error and
of 1% − 2% in the evaluation of the beta beating
(depending on the sextupole settings).
If nonlin-
ear terms are not taken into account, the inferred
quadrupolar errors would wrongly account for sex-
tupolar and octupolar contributions to the beta-
tron motion.

• Formulas for the evaluation of beta beating from
TBT data are aﬀected by intrinsic errors at the
level of ∼ 0.3% rms (∼ 2% peak to peak) if the
BPM phase advance is used (and a perferct syn-
chronization between the monitors is assumed),
whereas if the tune line amplitude is used (and
BPM calibration factors inferred from orbit data
can be trusted) the uncertainty is of ∼ 0.6% rms
(∼ 3% maximum). No error estimate for the ORM
analysis has been performed so far.

The above numbers may clearly vary in other ring-
based light sources, though recent comparisons between
ORM and TBT analysis of linear lattice errors in other
facilities report similar uncertainties [12, 13].

The same considerations made here for the FFT-based
analysis of TBT data should apply the the techniques of
Refs. [10, 11, 26–28]. Indeed the nonlinearities of Eq. (26)
aﬀecting the tune lines are expected to alter the betatron
modes which are used for the evaluation of focusing er-
rors. In these schemes, in fact, it is assumed that any
deviation from the ideal betatron modes, i.e. those os-
cillating at the frequency of the linear tunes, would stem
from quadrupolar errors, whereas Eq. (26) suggests that
at large amplitudes (needed for the analysis of ultra-low
coupling) the impact of nonlinear eﬀects needs to be as-
sessed. Hence, as for the harmonic analysis, if nonlinear-
ities are ignored, the inferred quadrupolar errors would
wrongly account for sextupolar and octupolar contribu-
tions to the betatron motion.

A last consideration worth to be made concerns the
new ESRF storage ring under design (and possibly any
new light source with sub-nm natural horizontal emit-
tance). The new lattice design is expected to provide
a natural emittance of about 130 pm (4 nm today) and
features beta functions globally much smaller than in the
existing machine. Today the lowest beta function at the
BPMs is of about 5.6 m. In the new machine two BPMs
(out of ten) per cell are located in regions with βx = 1.1

m (βy = 3.3 m), and βx = 1.9 m (βy = 2.3 m) in other
two monitors. In the future storage ring the BPM elec-
tronics remains based on the existing Libera Brilliance
hardware (additional Libera Spark modules will be in-
stalled to cover the increased number of monitors). This
means that in order to preserve today’s spectral resolu-
tion, the initial beam excitation, i.e. the invariant, shall
be larger by about a factor two, in a machine which is
by far more nonlinear than the existing one. This casts
even stronger concerns on the possibility of measuring
and correcting linear optics (focusing errors and beta-
tron coupling) via TBT data in the upcoming storage

ring.

The above conclusions are expected not to apply to
hadron circular accelerators with less aggressive focusing
lattices and larger regions of the betatron phase space,
i.e. the invariants, within the linear optics regime.

V. ACKNOWLEDGMENT

I am deeply indebted with Rogelio Tom´as for inspiring
this work. I am also grateful to him and Reine Versteegen
for reading the original manuscript and for providing pre-
cious comments and suggestions during its preparation.

Appendix A: Linear lattice parameters with focusing errors

In Appendix C of Ref. [23] a non-truncated expression for the tune lines H(1, 0) and V (0, 1) is derived assuming
ultra low coupling, i.e. that coupling RDTs are negligible compared to the ones excited by focusing errors, f2000 and
f0020. A second, though not less important, assumption is that the impact on the tune lines from nonlinear RDTs is
negligible, i.e. that the oscillation amplitudes (2Ix,y) are low enough to prevent octupolar-like RDT f3100, f2011, f0031
and f1120 from contributing to H(1, 0) and V (0, 1), See Table V-VII of Ref. [30]. Note that the spectral lines reported
there refer to the complex signals hx = ˜x − i˜px and hy = ˜y − i˜py, for which the above octupolar-like RDTs excite the
lines Hh(−1, 0) and Vh(0,−1), hence introducing amplitude-dependent focusing errors. Since the harmonic analysis is
performed here on the real signals ˜x and ˜y, those lines pollute the tune peaks, since H(1, 0) = 1/2[Hh(1, 0)+H ∗
h(−1, 0)]
and V (0, 1) = 1/2[Vh(0, 1)+ V ∗
h (0,−1)]. A more detailed discussion is made in the Appendices C and D of Ref. [23]. A
third condition is that Hamiltonian octupolar-like terms h2200(2Ix)2, h1111(2Ix)(2Iy) and h0022(2Iy)2 can be neglected,
as they would introduce amplitude-dependent detuning and shifts of the betatron phase unrelated to linear lattice
errors. It is worthwhile reminding that such nonlinear resonant and detuning terms are generated by octupole magnets
(to the ﬁrst order) as well as by sextupoles (to the second order) and are in general much stronger in light sources
than in hadron machines (because of the higher natural chromaticity). Unless speciﬁed, throughout this appendix
only ideal BPMs with calibration factors Cx,y = 1 are considered. Under these three important assumptions the tune
lines at a generic BPM j read

H(1, 0)j =

V (0, 1)j =




where

1

1

2h cosh (4|f2000,j|) + i sinh (4|f2000,j|)e−iq2000,jip2Ixei(2πN Qx+φ(mod)
2h cosh (4|f0020,j|) + i sinh (4|f0020,j|)e−iq0020,jip2Iyei(2πN Qy+φ(mod)

x,j +ψx0)

y,j +ψy0)

x,w δKw,1e2i∆φ(mod)
β(mod)

x,wj

+ O(δK 2
1 )

,

W

Pw

f2000,j =




8(1 − e4πiQx)

q2000,j = arg{f2000,j}

W

Pw

y,w δKw,1e2i∆φ(mod)
β(mod)
8(1 − e4πiQy )

y,wj

f0020,j = −
q0020,j = arg{f0020,j}




,

(A1)

+ O(δK 2
1 )

, (A2)

with β(mod) and ∆φ(mod) are the the Courant-Snyder (C-S) parameters of the ideal lattice (i.e. without focusing
errors δKw,1). O(δK 2
1 ) denotes the reminder proportional to the square of the focusing errors. The above sums run
over all W quadrupole errors along the ring, and ∆φwj denotes the phase advance between the magnet w and the
BPM j. Eq. (A1) may be rewritten as

H(1, 0)j =

1

2p2IxAf,jei(2πN Qx+φ(mod)

x,j +θf,j ) ,

Af,j =(cid:16)1 + 2 sinh (4|f2000,j|)h sinh (4|f2000,j|) + cosh (4|f2000,j|) sin q2000,ji(cid:17)1/2
θf,j = tan−1(cid:26)

cosh (4|f2000,j|) + sinh (4|f2000,j|) sin q2000,j(cid:27) + ψx0 .

sinh (4|f2000,j|) cos q2000,j

,

(A3)

(A4)

(A5)

The s-dependent term Af represents the phase space deformation induced by focusing errors not included in the
model. With the ideal lattice the s-dependent phase space ellipses of the Cartesian coordinates are mapped into
circles of constant radius √2Ix when moving in the C-S coordinates. With lattice errors not included in the model,
the C-S transformation with the ideal C-S parameters will map the initial ellipses in other ellipses whose semi-axis
depend on Af . Only when those errors are included in the model f2000 = 0 and Af = 1 along the ring, and the phase
space circles are retrieved with the new C-S parameters and transformation.

Analytic formulas for the beta beating: By comparing Eq. (A3) and Eq. (11) (assuming an ideal BPM
calibration factor, C = 1), the measured β can be interpreted as the initial model β(mod) modiﬁed by the focusing
errors via the RDTs so to have tune line amplitude constant along the ring and equal to √2I. This is equivalent to
say that at the BPM j βx,j = β(mod)

x,j A2

f,j, i.e.

βx,j = β(mod)

x,j

βy,j = β(mod)

y,j

n1 + 2 sinh (4|f2000,j|)h sinh (4|f2000,j|) + cosh (4|f2000,j|) sin q2000,jio
n1 + 2 sinh (4|f0020,j|)h sinh (4|f0020,j|) + cosh (4|f0020,j|) sin q0020,jio

,

(A6)

where the expression for the vertical plane follows from the same interpretation of V (0, 1) in Eq. (A1). The beta
beating then reads




∆βx,j
βx,j
∆βy,j
βy,j

= 2 sinh (4|f2000,j|)h sinh (4|f2000,j|) + cosh (4|f2000,j|) sin q2000,ji
= 2 sinh (4|f0020,j|)h sinh (4|f0020,j|) + cosh (4|f0020,j|) sin q0020,ji

.

(A7)

To the ﬁrst order in the RDTs the hyperbolic functions can be truncated to their leading terms,

( βx,j = β(mod)

βy,j = β(mod)

x,j

y,j

(1 + 8ℑ{f2000,j}) + O(|f2000|2)
(1 + 8ℑ{f0020,j}) + O(|f0020|2)

(cid:18) ∆βx
βx (cid:19)j
βy (cid:19)j
(cid:18) ∆βy

= 8ℑ{f2000,j} + O(|f2000|2)

= 8ℑ{f0020,j} + O(|f0020|2)

.

(A8)

, 


O(|f|2) denotes the reminder proportional to the square of the RDT amplitude. To the ﬁrst order in δK1 the RDTs
can be substituted by Eq. (A2), yielding







βx (cid:19)(1)
(cid:18) ∆βx
βy (cid:19)(1)
(cid:18) ∆βy

j ≃ +

j ≃ −

β(mod)
x,j

2 sin (2πQx)

β(mod)
y,j

2 sin (2πQy)

W

W

Xw
Xw

x,w δKw,1 cos (2|∆φ(mod)
β(mod)

x,wj | − 2πQx)

,

y,w δKw,1 cos (2|∆φ(mod)
β(mod)

y,wj | − 2πQy)

(A9)

which are the standard textbook formulas.

Analytic formulas for the phase shift. The phase space deformation introduced by Af in Eq. (A3) and the
resulting beta beating are accompanied by local jumps (or shifts) of the betatron phase with respect the ideal one.
These are generated by the phase space deformation induced by the RDTs via the s-dependent term θf in Eq. (A3) and
by detuning Hamiltonian coeﬃcient h1100 (h0011 in the vertical plane) which does not alter the phase space topology.
The tune Qx in Eq. (A3) is indeed equal to the ideal one minus the derivative of all additional phase-independent
Hamiltonian terms,

Qx = Q(mod)

x

1
2π

∂ < H >φ

∂Ix

= Q(mod)

x

1
2π

−

∂h1100(2Ix)

∂Ix

+ O(Ix) ≃ Q(mod)

x

−

1
π

h1100

,

(A10)

x,w δKw,1 + O(δK 2
β(mod)
1 )

,

(A11)

h1100 = −

1
4

W

−
Xw=1

where the reminder O(Ix) includes amplitude-dependent octupolar-like detuning not discussed here, and O(δK 2
1 )
denotes the second order contribution to detuning from quadrupole errors (as well as from coupling) which is neglected

in the following derivation though it can be computed as shown in Ref. [23]. In the vertical plane the following relations
apply

Qy = ≃ Q(mod)

y

−

1
π

h0011

,

h0011 = +

1
4

y,w δK1,w + O(δK 2
β(mod)
1 )

.

(A12)

W

Xw=1

The betatron phase computed by any optics code refers always to the origin (s=0). When comparing the betatron
phases with and without lattice errors, it shall be noted that with errors the initial phase is not zero with respect to
the ideal case, namely

( φx,s=0 = θf2000,s=0

φx,j = φ(mod)

x,j − 2h1100,j + θf2000,j − φx,s=0

, ( φy,s=0 = θf0020,s=0

φy,j = φ(mod)

y,j − 2h0011,j + θf0020,j − φy,s=0

.

(A13)

The s-dependent terms h1100,j and h0011,j include the focusing errors from the origin (s=0) and the BPM j:

h1100,j = −

1
2

β(mod)
x,w δKw,1 + O(δK 2
1 )

,

h0011,j = +

1
2

β(mod)
y,w δKw,1 + O(δK 2
1 )

.

(A14)

W <j

Xw=1

W <j

Xw=1

Note that even if the ﬁnal detuning is zero (in practice two or more dedicated quadrupole families are trimmed so to
have the desired ideal tunes), h1100,j and h0011,j are in general nonzero along the ring. By manipulating Eq. (A13)
the phase shift then reads

( φx,j − φ(mod)
φy,j − φ(mod)

x,j = −2h1100,j + θf2000,j − θf2000,s=0
y,j = −2h0011,j + θf0020,j − θf0020,s=0

.

(A15)

The truncation to the ﬁrst order in the RDT of θf from Eq. (A5) reads

1 + 4|f2000,j| sin q2000,j(cid:27) ≃ tan−1 (4|f2000,j| cos q2000,j) ≃ 4|f2000,j| cos q2000,j ≃ 4ℜ{f2000,j}
θf2000,j ≃ tan−1(cid:26) 4|f2000,j| cos q2000,j
The equivalent approximation in the vertical plane yields to θf0020,j ≃ 4ℜ{f0020,j}. Eq. (A15) then simpliﬁes to

.(A16)

( φx,j − φ(mod)
φy,j − φ(mod)

x,j = −2h1100,j + 4ℜ{f2000,j − f2000,s=0} + O(|f2000|2)
y,j = −2h0011,j + 4ℜ{f0020,j − f0020,s=0} + O(|f0020|2)

.

(A17)

The shift of the BPM phase advance can be computed from the above expressions

( ∆φx,ij = ∆φ(mod)

∆φy,ij = ∆φ(mod)

x,ij − 2h1100,ij + 4ℜ{f2000,j − f2000,i} + O(|f2000|2)
y,ij − 2h0011,ij + 4ℜ{f0020,j − f0020,i} + O(|f0020|2)

h1100,ij = −

h0011,ij = +

, 


1

2 Xi<w<j
2 Xi<w<j

1

x,w δKw,1 + O(δK 2
β(mod)
1 )

,
y,w δKw,1 + O(δK 2
β(mod)
1 )

(A18)

where the above sums extend over the focusing errors between the two BPMs i and j only. Since the latter monitor
is donwstream the former, i.e. sj > si, the above sum is well deﬁned. Explicit expressions truncated to the ﬁrst order
in δK1 similar to Eq. (A9) can be retrieved after substituting the RDTs in the above equations with Eq. (A2).

Analytic formulas for the alpha shift. The last C-S parameters to be evaluated is α = −1/2β′, where the

derivative is with respect to s. The beta function is the one of Eq. (A6). The derivative can be written as

β′(β(mod),|f|, q) =

∂β

∂β(mod) β′(mod) +

∂β

∂|f||f|′ +

∂β
∂q

q′

,

(A19)

Two approximations are made here to simplify the mathematical derivation. The ﬁrst is that 0 ≃ |f|′ ≪ β′(mod), q′
and corresponds to the fact that the variation along the ring of |f| can be neglected, this being much smaller than the
one of oscillating functions β and q. The second is that q ≃ 2φ(mod), see Eq. (A2). Both are actually exact conditions
along regions free of focusing errors, as proved in Ref. [31]. From Eq. (A6) and the above relation, α reads

αx,j ≃ −

1
2

β′(mod)
x,j
−β(mod)

n1 + 2 sinh (4|f2000,j|)h sinh (4|f2000,j|) + cosh (4|f2000,j|) sin q2000,jio
sinh (4|f2000,j|) cosh (4|f2000,j|) cos q2000,jq′

2000,j

x,j

.

(A20)

2 β′(mod) = α(mod), the above expression becomes

x,j n1 + 2 sinh (4|f2000,j|)h sinh (4|f2000,j|) + cosh (4|f2000,j|) sin q2000,jio − sinh (8|f2000,j|) cos q2000,j

,

Since q′ ≃ (2φ)′ = 2/β(mod) and 1
αx,j ≃ α(mod)
and the alpha shifts ∆α = α − α(mod) read

x,j

∆αx,j ≃ α(mod)
∆αy,j ≃ α(mod)

y,j

2 sinh (4|f2000,j|)h sinh (4|f2000,j|) + cosh (4|f2000,j|) sin q2000,ji − sinh (8|f2000,j|) cos q2000,j
2 sinh (4|f0020,j|)h sinh (4|f0020,j|) + cosh (4|f0020,j|) sin q0020,ji − sinh (8|f0020,j|) cos q0020,j

. (A21)

By keeping only the leading terms from the hyperbolic functions, the following ﬁrst-order expression is retrieved




x,j

( αx,j ≃ α(mod)
αy,j ≃ α(mod)

y,j

(1 + 8ℑ{f2000,j}) − 8ℜ{f2000,j} + O(|f2000|2)
(1 + 8ℑ{f0020,j}) − 8ℜ{f0020,j} + O(|f0020|2)

.

(A22)

Explicit expressions truncated to the ﬁrst order in δK1 similar to Eq. (A9) can be retrieved after substituting the
RDTs in the above equations with Eq. (A2).

Improved formula to evaluate the beta beating from BPM phase advance. Eq. (15) was derived in Ref. [3]
under the assumption that the region between the three BPMs is free of unknown focusing errors. Here a more general
formula is derived, which does not requires this condition. The only approximation made is a series of truncations to
the ﬁrst order in δK1, and hence in the RDTs f2000 and f0020. The starting point are Eqs. (A8), (A18), (A22)

j

βj ≃ β(mod)
∆φij ≃ ∆φ(mod)
αj ≃ α(mod)

ij

j

(1 + 8ℑ{fj})

− 2hij + 4ℜ{fj − fi}
(1 + 8ℑ{fj}) − 8ℜ{fj}




, 


1
β1
1
β1

(cot ∆φ12 + α1)

(cot ∆φ13 + α1)

,

(A23)

where hij and fj are the detuning term of Eq. (A18) and the RDT, respectively, corresponding to each plane, whose
subscript is omitted here for the sake of notation (the derivation is the same). Before making explicit the two
expressions in the above second bracket, the term ℜ{fj − fi} needs to be evaluated ﬁrst. From Eq.(4.2)-(4.3) of
Ref. [31] fj can be rewritten as function of fi according to

i

− fie−i2φ(mod)
β(mod)
w

δKw,1e−i2φ(mod)

w

⇒ fj = ˆhijei2φ(mod)

j

+ fiei2∆φ(mod)

ij

,

(A24)

j

ˆhij = fje−i2φ(mod)
ˆhij = ∓

8 Xi<w<j

1




where again the sum extends over the focusing errors between the two BPMs i and j only, while the sign is negative for

x, positive for y. The label i shall not be confused with the imaginary unit in the above exponential terms i = √−1.

Hence

j

j

ℜ{fj − fi} = ℜnˆhijei2φ(mod)
= ℜnˆhijei2φ(mod)
= ℜnˆhijei2φ(mod)
= ℜnˆhijei2φ(mod)
= ℜnˆhijei2φ(mod)

j

j

j

ij

ij

+ fi(cid:16)ei2∆φ(mod)
− 1(cid:17)o
o + |fi|ℜnei(2∆φ(mod)
o + |fi|ncos (2∆φ(mod)
o + |fi|ncos qihcos 2∆φ(mod)
o + ℜ{fi}h−2 sin2 ∆φ(mod)

ij

ij

ij

+qi) − eiqio
+ qi) − cos qio

− 1i − sin qi sin 2∆φ(mod)
i − ℑ{fi} 2 sin ∆φ(mod)

ij

ij

o

qi is the phase of fi

cos ∆φ(mod)

ij

.

(A25)

By making use the Taylor expansion of cot (x + ǫ) with ǫ ≪ x, the BPM phase advance ∆φij of Eq. (A23) can be
approximated to

cot (x + ǫ) = cot x −

ǫ

sin2 x

+ O(ǫ2) ⇒ cot ∆φij ≃ cot ∆φ(mod)

ij

+

2hij − 4ℜ{fj − fi}

sin2 ∆φ(mod)

ij

.

(A26)

By substituting ℜ{fj − fi} with Eq. (A25), the above expression reads

cot ∆φij ≃ cot ∆φ(mod)

ij

(1 + 8ℑ{fi}) + ¯hij + 8ℜ{fi}

,

¯hij =

¯hij can be further made explicit via Eqs. (A11) and (A24), namely

2hij − 4ℜnˆhijei2φ(mod)

sin2 ∆φ(mod)

j

ij

o

.

(A27)

β(mod)
w

β(mod)
w

j

δKw,1h1 − ℜnei2(φ(mod)
δKw,1h1 − cos 2∆φ(mod)

wj

−φ(mod)

w

)oi + O(δK 2

1 )

i + O(δK 2

1 )

β(mod)
w

δKw,12 sin2 ∆φ(mod)

wj + O(δK 2
1 )

¯hij = ∓

= ∓

= ∓

= ∓

2 sin2 ∆φ(mod)

2 sin2 ∆φ(mod)

2 sin2 ∆φ(mod)

1

1

1

ij Xi<w<j
ij Xi<w<j
ij Xi<w<j
ij Xi<w<j

1

sin2 ∆φ(mod)

β(mod)
w

δKw,1 sin2 ∆φ(mod)

wj + O(δK 2
1 )

,

(A28)

where the sign depends on the plane and the above sum extends over the focusing errors between the two BPMs i
and j, while ∆φ(mod)
denotes the phase advance between the BPM j and the source of error w of the ideal (or initial)
lattice model.

wj

¯hx,ij = −

¯hy,ij = +

sin2 ∆φ(mod)

1

1

x,ij Xi<w<j
y,ij Xi<w<j

sin2 ∆φ(mod)

x,w δKw,1 sin2 ∆φ(mod)
β(mod)

x,wj + O(δK 2
1 )

y,w δKw,1 sin2 ∆φ(mod)
β(mod)

y,wj + O(δK 2
1 )

,

(A29)




All the ingredients are now ready to make explicit the quantities in the most right block of Eq. (A23), by noting that

1
β1

(cot ∆φ12 + α1) ≃

cot ∆φ(mod)

12

(1 + 8ℑ{f1}) + ¯h12 + 8ℜ{f1} + α(mod)

1

(1 + 8ℑ{f1}) − 8ℜ{f1}

≃

≃

1
β1

(cot ∆φ13 + α1) ≃

1

β(mod)
1

1

β(mod)
1

1

β(mod)
1

12

(cid:16)cot ∆φ(mod)
(cid:16)cot ∆φ(mod)
(cid:16)cot ∆φ(mod)

12

13

+ α(mod)

1

+ α(mod)

1

+ α(mod)

1

(cid:17) +
(cid:17) +
(cid:17) +

β(mod)
1
¯h13

β(mod)
1

β(mod)
1

(1 + 8ℑ{f1})
¯h12
(1 + 8ℑ{f1})
+ O(δK 2
,
1 )

β(mod)
1
¯h12

+ O(δK 2
1 )

.

(A30)

(A31)

The diﬀerence between the above expressions reads

1
β1

(cot ∆φ13 − cot ∆φ12) ≃

1

β(mod)
1

h(cot ∆φ(mod)

13

− cot ∆φ(mod)

12

) + (¯h13 − ¯h12)i + O(δK 2

1 )

,

(A32)

which is equivalent to

β1 ≃ β(mod)

1

(cot ∆φ(mod)

13

cot ∆φ13 − cot ∆φ12
− cot ∆φ(mod)

12

) + (¯h13 − ¯h12)

+ O(δK 2
1 )

,

(A33)

with ¯hij deﬁned in Eq. (A29). Eq. (18) is then demonstrated. When no source of focusing error is present
between the three BPMs, ¯h13 = ¯h12 = 0 and Eq. (15) is retrieved. A special case where Eq. (15) still applies
even in the presence of strong localized focusing errors is when ¯h13 = ¯h12 6= 0. More generally, Eq. (15) remains
a robust approximation whenever |¯h13 − ¯h12| ≪ | cot ∆φ(mod)
|, or when the beating induced by any
quadrupole errors between two BPMs is much smaller than the one generated by focusing glitches along the rest of the
ring, i.e. |¯h12| ≪ |β(mod)
(1 + 8ℑ{f1}) | in Eq. (A30), the RDT f1 being generated by all sources of error, see Eq. (A2).

− cot ∆φ(mod)

13

12

1

]

m

 

 
 

[
 
)
 
d
 
o
 
m
β
−
β

(
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
)
d
o
m
 
α
−
α

(

horizontal
vertical

0

-5

-10

6
3
0
-3
-6

 
 
 
|
 
 
 
0
 
 
0
 
0
 
2
 
 
 
f
 
 
|
 
 
 
 
 
 
 
 
 
 
 
 
 
 
|
 
 
 
0
 
 
2
 
0
 
 
0
 
f
|

0.3

0.15

0
0.14

0.07

0
119

126

133

BPM number 

140

147

FIG. 9. (Color) Diﬀerence between the C-S parameters computed by MADX at the BPMs with and without an example of
insertion optics introduced in the lattice of the ESRF storage ring (upper plots). The amplitude of the two corresponding
RDTs is plotted in the lower plots, which is zero outside the insertion region. The perfectly matched insertion corresponds
hence to a closed RDT bump.

Interpreting an insertion optics as a closed RDT bump. Eqs. (A8), (A18), (A22) provide an interesting
interpretation of an insertion optics, i.e. of a local modiﬁcation of the linear optics conﬁned between two points i and
j, with no change outside.

i

( βi ≃ β(mod)
αi ≃ α(mod)

i

(1 + 8ℑ{fi})
(1 + 8ℑ{fi}) − 8ℜ{fi}

, 


j

βj ≃ β(mod)
αj ≃ α(mod)
∆φij ≃ ∆φ(mod)

ij

(1 + 8ℑ{fj})
(1 + 8ℑ{fj}) − 8ℜ{fj}
− 2hij + 4ℜ{fj − fi}

j

.

(A34)

If the insertion is perfectly matched to the rest of the machines, βi = βj and αi = αj (in general the same is true for
the dispersion function and its derivative, not discussed here). This implies that: (i) fi = fj = 0, (ii) the RDTs are
zero outside the two locations i and j, and (iii) the phase advance of the whole insertion is ∆φij = ∆φ(mod)
− 2hij,
with hij in general nonzero. This in turn implies that the above equations are actually exact, since the reminders
proportional to |f|2 is also zero at the insertion ends. An example of matched insertion optics introduced in the lattice
of the ESRF storage ring is showed in Fig. 9, along with the amplitude of the two RDTs. As predicted by Eq. (A34),
the RDTs are zero at the ends and outside the insertion region, with a closed bump inside.

ij

Accurate evaluation of the focusing errors RDTs. Eqs. (A8), (A17), (A22) compute the C-S parameters
modiﬁed by focusing errors (or insertion optics) via the corresponding RDTs f2000 and f0020. They represent already
an approximation, linear in RDTs, since terms proportional to higher powers (f 2, f 3,
...) are neglected. For light
sources such as the ESRF storage ring, with a typical rms beating of about 3-5% (see top plot of Fig. 1) and ultra-low
coupling (the emittance ratio ǫy/ǫx is about 1‰) this approximation is already rather robust and is expected to be
of no concern for more recent machines with the same coupling level and an RMS beating lower than 1%. It remains
to asses how reliable is the computation of the RDT from the lattice formula (linear in δK1) of Eq. (A2). In Fig. 10
the diﬀerences between the C-S parameters computed from an error model (the same of Fig. 1) and from the ideal
lattice of the ESRF storage ring are displayed. By taking as reference the values computed by MADX (red curves), an
overall good agreement is observed when the lattice formula, Eq. (A2), is used to evaluate the RDTs (green curves),
though some local and global discrepancies can be observed: up to 1 m for β, 0.5 for α, and 5 mrad for the betatron
phases φ, see Fig. 11.

Fortunately a more accurate way to compute the RDTs exists, though it requires several computational steps.
First, single particle tracking is to be performed, with focusing errors included in the lattice and with non-zero initial
conditions in both planes, small enough so to remain in the linear regime (a few tens of µm). Turn-by-turn position

HORIZONTAL

VERTICAL

]

m

 

[
β
∆

α
∆

]
d
a
r
m

 

[
φ
∆

4
2
0
-2
-4

2

1
0

-1
-2
30

20

10

0

0

from MADX
from RDT (lattice)
from RDT (FFT)

56

112

168

BPM number

2

0

-2

1
0.5
0
-0.5
-1

10

0

-10

-20

0

224

56

112

168

224

BPM number

FIG. 10. (Color) Diﬀerences between the C-S parameters evaluated from an error model (the same of Fig. 1) and from the
ideal lattice of the ESRF storage ring. These diﬀerences are computed by MADX (solid red line) and from Eq. (A8) (for β),
Eq. (A22) (for α) and Eq. (A17) (for φ). The RDTs in those formulas are computed by the lattice formula (linear in δK1) of
Eq. (A2) (solid green line) and from Eq. (A36) (FFT of simulated single particle tracking data, dashed blue line).

]

m

 

[
β
∆

2

1

0

-1

-2

α
∆

0.6
0.3
0
-0.3
-0.6

]

d
a
r
m

 

[
φ
∆

6

4

2

0

-2

0

HORIZONTAL

from RDT (lattice) - MADX
from RDT(FFT) - MADX

56

112

168

BPM number

0.6

0.3

0

-0.3

0.2

0.1

0

-0.1

-0.2
6

4

2

0

0

224

VERTICAL

56

112

168

224

BPM number

FIG. 11. (Color). Deviations between the change of the C-S parameters computed by MADX and the one predicted by Eq. (A8)
(for β), Eq. (A22) (for α) and Eq. (A17) (for φ). The green line is obtained when computing the RDTs via Eq. (A2), whereas
the application of Eq. (A36) results in the blue curve, which is much more accurate.

(x, px) and momentum (y, py) shall be recorded at the BPMs. The complex C-S variables hx = ˜x−i˜px and hy = ˜y−i˜py
are then computed at each BPM, where the C-S parameters used to convert the Cartesian coordinates are the ones
of the ideal model (i.e. without the focusing errors used for tracking). As showed in Appendix C of Ref. [23], from
the FFT of hx at each BPM two main harmonics can be extracted, one at the tune frequency Hh(1, 0) and the other
at its opposite Hh(−1, 0) (the same applies to the vertical plane):

hx = cosh (4|f2000|) ζx,− − i sinh (4|f2000|) eiq2000 ζx,+ ,

hy = cosh (4|f0020|) ζy,− − i sinh (4|f0020|) eiq0020 ζy,+ ,

⇑

⇑

Hh(1, 0)

Vh(0, 1)

⇑

⇑

Hh(−1, 0)

Vh(0,−1)

(A35)

amplitude of the four lines, according to

where ζ± = √2Ie∓i(2πN Q+φ+ψ0). The RDT phase q and amplitude |f| can then be inferred from the phase and



[ln (1 + gx) − ln (1 − gx)] , gx = |Hh(−1, 0)|
|Hh(1, 0)|
[ln (1 + gy) − ln (1 − gy)] , gy = |Vh(0,−1)|
|Vh(0, 1)|

π
q2000 = ΦHh(−1,0) + ΦHh(1,0) +
2
π
2

q0020 = ΦVh(0,−1) + ΦVh(0,1) +

|f2000| =

|f0020| =

arctanh gx =

arctanh gy =

1
8
1
8

1
4
1
4

.

(A36)

, 


By using the RDTs inferred from the above FFT formulas in Eqs. (A8), (A17), (A22), the agreement with the C-S
parameters computed by MADX is greatly improved, as showed by the blue curves of Figs. 10 and 11: The accuracy
is better than 1 mm for β, 0.15 for α, and up 3 mrad for φ. When computing the BPM phase advance error, the
deviation drops to about 0.1 mrad. The accumulation of inaccuracy for φ along the ring (bottom plot of Fig. 11)
can be attributed to higher-order terms in the computation of hij and nonlinear terms put in the reminder O(|f|2) of
Eq. (A18).
Evaluating the beta beating from the tune line amplitude. From Eqs. (A3)-(A4) the tune line amplitude

at the BPM j reads

|H(1, 0)j| = Cx,j

2 p2IxAf,j

,

Cx,j = 1 + Ex,j

,

0 ≃ Ex,j ≪ 1

,

(A37)

where the BPM calibration factor is included and represented by a small calibration error Ex,j for a later perturbative
expansion. By averaging over all BPMs the following expression for the invariant is obtained
2 < |H(1, 0)| >
< Cx >< Af >

< Cx >
2 p2Ix < Af >

C and Af being uncorrelated quantities. On the other hand, Af,j can be written as the ratio between the real beta
and the ideal one, see Eq. (11),

⇒ p2Ix =

< |H(1, 0)| >=

(A38)

,

Af,j =s βx,j

β(mod)
x,j

⇒ |H(1, 0)j| = Cx,j

2 p2Ixs βx,j

β(mod)
x,j

⇒ βx,j = β(mod)

x,j

2|H(1, 0)j|2
C2
x,j(2Ix)

.

(A39)

By replacing (2Ix) with the expression of Eq. (A38), the above expression reads

The last two terms in the r.h.s of the above equation can be approximated by

βx,j = β(mod)

x,j (cid:18) |H(1, 0)j|

< |H(1, 0)| >(cid:19)2(cid:18) < Cx >
Cx,j (cid:19)2

< Af >2

.

(A40)

Cx,j (cid:19)2
(cid:18) < Cx >
≃ 1 + 2(< Ex > −Ex,j) + O(E 2
x)
< Af >2≃< 1 + 32|f2000|2 + 8|f2000| sin q2000 + O(|f2000|3) >2≃ 1 + 64 < |f2000|2 > +O(|f2000|3)

x)(cid:1)2
≃(cid:0)1+ < Ex > −Ex,j + O(E 2

1 + Ex,j (cid:19)2
=(cid:18) 1+ < Ex >

Eq. (A40) then becomes

βx,j = β(mod)

βy,j = β(mod)

x,j (cid:18) |H(1, 0)j|
y,j (cid:18) |V (0, 1)j|

< |H(1, 0)| >(cid:19)2
< |V (0, 1)| >(cid:19)2

[1 + 2(< Ex > −Ex,j) + O(E 2

x)][1 + 64 < |f2000|2 > +O(|f2000|3)]

[1 + 2(< Ey > −Ey,j) + O(E 2

y )][1 + 64 < |f0020|2 > +O(|f0020|3)]






.

(A41)

,

(A42)

where the expression for the vertical plane is obtained with the same derivation. < E > and < |f|2 > represent the
averaged values (over all BPMs) of the calibration errors and of the amplitudes of the RDTs, respectively . Unless
these are determined by independent measurements, they cannot be disentangled and are not observable. A (rude)
zero-order truncation is then needed in order to apply Eq. (A42) to real data, yielding to

βx,j = β(mod)

βy,j = β(mod)

x,j (cid:18) |H(1, 0)j|
y,j (cid:18) |V (0, 1)j|

< |H(1, 0)| >(cid:19)2
< |V (0, 1)| >(cid:19)2




+ O(Ex,|f2000|2)

+ O(Ey,|f0020|2)

.

(A43)

Appendix B: Impact of octupolar-like terms on the tune lines: an amplitude dependent focusing

All results of Appendix A and Sec. II are valid as long as the beam motion remains in the linear regime, i.e. nonlinear
terms may be neglected. In this appendix this assumption is removed and the extension of Eq. (10) to include higher-
order contributions is derived. The result will be a more complicated formula with additional terms dependent on the
initial oscillation amplitudes (2Ix,y), both in the tune line amplitude and phase. These are proportional to octupolar
ﬁelds (∝ K3) and to quadratic functions of sextupole strengths (∝ K 2
2 ).
In Table V-VII of Ref. [30] the list of secondary harmonics of the the complex signals hx = ˜x− i˜px and hy = ˜y − i˜py
generated by octupolar-like RDTs is presented. It can be seen how their spectral lines Hh(−1, 0) and Vh(0,−1), which
in the linear regime are excited only by focusing errors via the two quadrupolar RDTs f2000 and f0020, respectively,
receive a contribution from several octupolar-like RDTs too. To the ﬁrst order in the RDTs, these lines read

Hh(−1, 0) =(cid:20)−4ip2Ixf2000 − 6i(2Ix)f3100 − 4iq(2Ix)(2Iy)f2011 + O(f 2, I 2)(cid:21) e−τx
Vh(0,−1) =(cid:20)−4ip2Iyf0020 − 6i(2Iy)f0031 − 4iq(2Ix)(2Iy)f1120 + O(f 2, I 2)(cid:21) e−τy
− 2h1100 − 4h2200(2Ix) − 2h1111(2Iy) + O(I 2)i + φx + ψx0o
τx = in2πNhQ(mod)
− 2h0011 − 4h0022(2Iy) − 2h1111(2Ix) + O(I 2)i + φy + ψy0o
τy = in2πNhQ(mod)

x

y




.

(B1)

The above expressions are derived from the more general expression for the TBT complex signals [30]

2

r+t

r+t−1

2

p+q

p+q−1

(2Iy)

2 (2Iy)

rfpqrt(2Ix)

pfpqrt(2Ix)

2 ei[(1−p+q)(2πQxN +φx+ψx0)+(t−r)(2πQyN +φy+ψy0)]


hx(N ) =p2Ixei(2πQxN +φx+ψx0) − 2iXpqrt
hy(N ) =p2Iyei(2πQyN +φy+ψy0) − 2iXpqrt

(B2)
The harmonic Hh(−1, 0) (Vh(0,−1)) is the sum of all terms in the above summation such that 1 − p + q = −1 and
t− r = 0 (q − p = 0 and 1− r + t = −1), i.e. all those oscillating with the opposite betatron tune and phase. The ﬁrst
term, scaling with √2I, is then f2000, as 1 − 2 + 0 = −1 and 0 − 0 = 0 (f0020, since 0 − 0 = 0 and 1 − 2 + 0 = −1).
Following the same logic, the next terms in Hh(−1, 0) scaling with (2Ix) are f3100, (1 − 3 + 1 = −1 and 0 − 0 = 0)
and f2011 (1 − 2 + 0 = −1 and 1 − 1 = 0). The same rule applied to Vh(0,−1) selects f0031 and f1120. All last four
RDTs are normal octupolar-like (fpqrt, with p + q + r + t = 4), with f3100 and f0031 excited by the potential terms
∝ x4 and y4, respectively, whereas both f2011 and f1120 stem from the monomial ∝ x2y2. Detuning terms h are those
elements of the complex C-S Hamiltonian

ei[(q−p)(2πQxN +φx+ψx0)+(1−r+t)(2πνyN +φx+ψx0)]

.

n=p+q+r+t

hpqrt(2Ix)

p+q

2 (2Iy)

r+t

2 ei[(p−q)(φx+ψx0)+(r−t)(φy+ψy0)]

,

(B3)

˜H =Xn

Xpqrt

that do not depend on the betatron phase, i.e. p = q and r = t. In the above deﬁnition n represents the multipole
order (normal and skew): n = 2 for quadrupoles, n = 3 for sextupoles, n = 4 for octupole, etc. The explicit formula
for hpqrt reads

hpqrt = −(cid:2)Kn−1Ω(r + t) + iJn−1Ω(r + t + 1)(cid:3)

r! 2p+q+r+t

Ω(i) = 1 if i is even, Ω(i) = 0 if i is odd

p!

q!

r!

ir+t(cid:0)βx(cid:1)

.

p+q

2 (cid:0)βy(cid:1)

r+t

2 ,

(B4)

Ω(i) is introduced to select either the normal or the skew multipoles. Kn−1 and Jn−1 are the integrated magnet
strengths of Eq. (7). If several sources are to be included in the above Hamiltonian, a further summation taking into
account the relative phase advances between magnets and observation point needs to be included in Eq. (B3), see
Appendix A of Ref. [23].

The RDT fpqrt and the detuning terms hpprr introducing a dependence on the initial amplitude (2I) in Eq. (B1)
are proportional to the octupolar strengths (∝ K3, generated either by physical octupole magnets or by octupolar
components of other magnets) and to quadratic functions of sextupole strengths (∝ K 2
2 ).
Nonlinear terms aﬀect the tune lines (of the complex signals). According to Eqs.(C29)-(C30) of Ref. [23] these read

( Hh(1, 0) =p2Ix(cid:2)1 + THx(2Ix) + THy (2Iy) + O((2Ix,y)2)(cid:3) eτx
Vh(0, 1) =p2Iy(cid:2)1 + TVx (2Ix) + TVy (2Iy) + O((2Ix,y)2)(cid:3) eτy

,

(B5)

where the complex functions T are quadratic functions of the sextupole strengths (∝ K 2
truncated to the ﬁrst non-zero terms of the invariants. These four spectral lines can be conveniently rewritten as

2 ) and the expansion is




Hh(1, 0) =p2Ix(cid:2)1 + TH(K 2
Vh(0, 1) =p2Iy(cid:2)1 + TV (K 2
Hh(−1, 0) = −ip2Ix(cid:2)4f2000 + F ∗
Vh(0,−1) = −ip2Iy(cid:2)4f0020 + F ∗

2 , Ix,y)(cid:3) eτx
2 , Ix,y)(cid:3) eτy

xx(K 2
yy(K 2

2 , K3, Ix,y)(cid:3) e−τx
2 , K3, Ix,y)(cid:3) e−τy

,

(B6)

where the reminders O(f 2, I 2) have been ignored. The dependence of the complex and longitudinally varying functions
T and F on the magnetic strengths K2,3 is indicated in the parenthesis. Since the harmonic analysis is performed
here on the real signals ˜x and ˜y, the observable tune lines read

H(1, 0) =

V (0, 1) =

1
2
1
2

[Hh(1, 0) + H ∗

[ Vh(0, 1) + V ∗

√2Ix
h(−1, 0)] =
2
h (0,−1)] = p2Iy

2

(cid:2)1 + 4if ∗
(cid:2)1 + 4if ∗




2000 + iFxx(K 2

2 , K3, Ix,y) + TH (K 2

0020 + iFyy(K 2

2 , K3, Ix,y) + TV (K 2

2 , Ix,y)(cid:3) eτx
2 , Ix,y)(cid:3) eτy

.

(B7)

The generalization of the tune line amplitude and phase of Eq. (11) at a BPM j in the nonlinear (amplitude dependent)
regime are then

|Bx,j|

, ΦH(1,0),j = φ(mod)

x,j + ψx0 + arg{Bx,j} − 2h1100,j − 4h2200,j(2Ix) − 2h1111,j(2Iy)

, ΦV (0,1),j = φ(mod)

y,j + ψy0 + arg{By,j} − 2h0011,j − 2h1111,j(2Ix) − 4h0022,j(2Iy)

.(B8)

√2Ix
|H(1, 0)j| =
2
|V (0, 1)j| = p2Iy

|By,j|

2
2000,j + iFxx,j(K 2
Bx,j = 1 + i4f ∗
0020,j + iFyy,j(K 2
By,j = 1 + 4if ∗




2 , K3, Ix,y) + TH,j(K 2
2 , K3, Ix,y) + TV,j(K 2

2 , Ix,y)
2 , Ix,y)

The linear regime may be then deﬁned as the range of initial oscillation amplitudes, i.e. of 2Ix,y, such that the
functions F , T may be ignored along with the amplitude dependent detuning terms h2200,j, h1111,j and h0022,j. These
are deﬁned as the summation of all octupolar-like sources from the beginning of the ring up to the BPM j, in the
same way h1100,j and h0011,j were deﬁned in Eq. (A14) and are non-zero even if the global detuning with amplitude
is zero or negligible. The generalization of observable BPM phase advance of Eq. (14) eventually reads

∆ΦH,ij = ∆φ(mod)
∆ΦV,ij = ∆φ(mod)

x,ij + arg{Bx,i − Bx,j} − 2h1100,ij − 4h2200,ij(2Ix) − 2h1111,ij(2Iy)
y,ij + arg{By,i − By,j} − 2h0011,ij − 2h1111,ij(2Ix) − 4h0022,ij(2Iy)

,

(B9)

where the the subscript ij in the detuning terms hpqrt,ij means that only the summation of detuning sources between
the two BPMs i and j is to be taken into account, as in Eq. (A18) for the linear case.

In conclusion, if the initial oscillation amplitude (2I) is too large, the betatron BPM phase advance ∆φij is no
longer measurable from the diﬀerence of the tune line phases ∆Φij, since amplitude dependent focusing, octupolar-
like, resonant and detuning terms corrupt the tune line. The same is true for the invariant itself (2I), which is no
longer measurable from the tune line amplitude. The latter is no longer constant along the ring and its modulation
depends on the invariant itself via the functions F and T of Eq. (B8).

Appendix C: Impact of octupolar-like terms on the coupling lines: an amplitude dependent coupling

Octupolar-like RDTs do not contribute to the tunes lines only, but to several other harmonics of the complex TBT
signals, including the coupling lines. By applying the same procedure presented in Appendix B, the contributions to
the harmonic Hh(0,±1) (Vh(±1, 0)) are all terms in the summation of Eq. (B2) such that 1− p + q = 0 and t− r = ±1
(q − p = ±1 and 1 − r + t = 0). The result is

( Hh(0, 1) = −2i(cid:2)f1001 + 2(2Ix)f2101 + (2Iy)f1012 + O(f 2, I 2)(cid:3)p2Iyeτy
Hh(0,−1) = −2i(cid:2)f1010 + 2(2Ix)f2110 + (2Iy)f1021 + O(f 2, I 2)(cid:3)p2Iye−τy
1012 + O(f 2, I 2)(cid:3)p2Ixeτx
( Vh( 1, 0) = −2i(cid:2)f ∗
Vh(−1, 0) = −2i(cid:2)f1010 + (2Ix)f2110 + 2(2Iy)f1021 + O(f 2, I 2)(cid:3)p2Ixe−τx

2101 + 2(2Iy)f ∗

1001 + (2Ix)f ∗

,

.

(C1)

The amplitude dependent coupling is then generated by skew octupolar-like RDTs, with f2101 and f2110 excited by
the x3y potential term, while f1012 and f1021 originate from the xy3 monomial. Note that in the above equations the
relation fpqrt = f ∗
qptr is used here for simplicity, though it is not strictly true when second order terms are to be taken
into account: See Appendix A of Ref. [23]. The coupling lines of the real signals ˜x and ˜y, then read




H(0, 1) =

V (1, 0) =

[Hh(0, 1) + H ∗

1
2
1
[ Vh(1, 0) + V ∗
2

Fxy = f1001 − f ∗
1001 − f ∗
Fyx = f ∗

1010

1010

h(0,−1)] = −i(cid:2)Fxy(J1) + Txy(J3, K3, K 2
h (−1, 0)] = −i(cid:2)Fyx(J1) + Tyx(J3, K3, K 2

2 , J1, Ix,y)(cid:3)p2Iyeτy
2 , J1, Ix,y)(cid:3)p2Ixeτx
2110)(2Ix) + (f1012 − f ∗
1012 − f ∗
2110)(2Ix) + 2(f ∗

Txy = 2(f2101 − f ∗
2101 − f ∗
Tyx = (f ∗

1021)(2Iy)
1021)(2Iy)

,
,

,

(C2)

where the reminders O(f 2, I 2) have been ignored. Fxy and Fyx are the same of Eq. (16) and generate betatron
coupling, which is amplitude independent. Txy and Tyx are instead responsible for the amplitude dependent coupling
and can be excited by several sources. To the ﬁrst order they are generated by skew octupole ﬁelds J3, and by cross
terms ∝ K3 ⊗ J1 (i.e. between normal octupole and skew quadrupole) to the second order. J3 in turn can stem from
the cross product ∝ K2 ⊗ J2 (i.e. between normal and skew sextupole), with J2 originating from another cross term
∝ K2⊗ J1. K3 is also created by a last cross term ∝ K2 ⊗ K2. In summary, the following scaling laws may be drafted:
(C3)
(C4)

J3 ↔ (K3) ⊗ J1 , K2 ⊗ [J2] ↔ (K2 ⊗ K2) ⊗ J1 , K2 ⊗ [K2 ⊗ J1] ↔ K2 ⊗ K2 ⊗ J1 ,

K3 ⊗ J1 ↔ K2 ⊗ K2 ⊗ J1 .

Hence, Txy and Tyx are nonzero even in the absence of physical normal or skew octupoles and scale quadratically with
the sextupole strength K2 and linearly with the skew quadrupole ﬁeld J1. Since the betatron coupling terms Fxy and
Fyx scale linearly with J1, the overall amplitude dependent modulation of the coupling lines scales quadratically with
the sextupole ﬁelds, i.e. with the same order of magnitude of the tune line modulation of Eq. (B8).

Amplitude and phase of the coupling lines at a generic BPM j are eventually derived from Eq. (C2), resulting in

|H(0, 1)j| =(cid:12)(cid:12)Fxy,j(J1) + Txy,j(J3, K3, K 2
|V (1, 0)j| =(cid:12)(cid:12)Fyx,j(J1) + Tyx,j(J3, K3, K 2

arg{H(0, 1)j} = φx,j + ψx0 + arg{Fxy,j + Txy,j} −
arg{V (1, 0)j} = φy,j + ψy0 + arg{Fyx,j + Tyx,j} −

2 , J1, Ix,y)(cid:12)(cid:12)p2Iy
2 , J1, Ix,y)(cid:12)(cid:12)p2Ix

π
2
π
2




.

(C5)

[1] M. Minty and F. Zimmermann, Measurement and Con-
trol of Charged Particle Beams, Springer, Berlin, 2003
(ISBN 3-540-44197-5).

[3] P. Castro Garc´ıa, PhD thesis, p.49, CERN-SL-96-070-BI

(1996).

[4] P. Castro Garc´ıa, J. Borer, A. Burns,G. Morpurgo, R.

[2] J. Borer, A. Hofmann, J.-P. Koutchouk, T. Risselada, B.

Schmidt, Proceedings of PAC 1993, p 2103 (1993).

Zotter, CERN/LEP/ISR/83-12 (1983).

[5] Y.T. Yan, Y. Cai, W. Colocho, F.-J. Decker, J. Seeman,
M. Sullivan, J. Turner, U. Wienands, M. Woodley, G.

Yocky, SLAC-PUB-11925 (2006).

Beams, vol. 14, 034002, (2011).

[6] D. Sagan, R. Meller, R. Littauer, and D. Rubin, Phys.

Rev. ST Accel. Beams 3, 092801 (2000)

[7] Akio Morita, Haruyo Koiso, Yukiyoshi Ohnishi, Kat-
sunobu Oide, Phys. Rev. ST Accel. Beams 10, 072801
(2007)

[23] A. Franchi, L. Farvacque, F. Ewald, G. Le Bec and K.
B. Scheidt, http://arxiv.org/abs/1402.1461. A. Franchi,
L. Farvacque, F. Ewald, G. Le Bec and K. B. Scheidt,
Phys. Rev. ST Accel. Beams, vol. 17, 074001, (2013).

[24] R. Bartolini, A. Bazzani,M. Giovannozzi, W. Scandale

[8] J. Safranek, Nucl. Instr. and Meth. A, vol. 388, pp. 27-36

and E. Todesco, CERN SL/95-84 (AP) (1995).

(1996).

[25] R. Tom´as Garc´ıa, Ph.D. thesis, University of Valencia,

[9] ICFA BD Newsletter, edited by A. Ghodke (ICFA Beam

(Report No. CERN-THESIS-2003-010, 2003)

Dynamics Panel, 2007), No. 44 .

[26] C. X. Wang, Stanford Ph.D. dissertation (1999), also

[10] J. Irwin, C. X. Wang, Y. T. Yan, K. L. F. Bane, Y. Cai,
F.-J. Decker, M. G. Minty, G. V. Stupakov, F. Zimmer-
mann, Phys. Rev. Lett. 82, 1684 (1999).

[11] X. Huang, S.Y. Lee, E. Prebys, R. Tomlin, Phys. Rev.

ST Accel. Beams 8, 064001 (2005)

[12] M. Carl´a, Z. Mart´ı, G. Benedetti, L. Nadolski, Proceed-
ings of the International Particle Accelerator Conference,
IPAC2015, Richmond, VA, USA, 2015, p. 1686.

[13] A. Langner, G. Benedetti, M. Carl´a, J. Coello de Por-
tugal, U. Iriso, Z. Mart´ı, R. Tom´as, Proceedings of
IPAC2015, Richmond, VA, USA, p. 430 (2015).

[14] Z. Mart´ı, CELLS ALBA note, ACDIV-2013-17 (2013)
[15] M. Aiba, M. B¨oge, J. Chrin, N. Milas, T. Schilcher,
and A. Streun, Phys. Rev. ST Accel. Beams 16, 012802
(2013).

[16] G. Rehm, M.G. Abbott, A.F. D. Morgan, J. Rowland, I.
Uzun, Proceedings of Beam and Instrumentation Work-
shop BIW2010, Santa Fe, New Mexico USA, 2010.

[17] W. Herr, F. Schmidt, CERN AB Note, CERN-AB-2004-

027-ABP (2004).

SLAC-R-547

[27] C. X. Wang, V. Sajaev, and C. Y. Yao, Phys. Rev. ST

Accel. Beams, vol. 6, 104001,(2003).

[28] X. Shen, S. Y. Lee, M. Bai, S. White, G. Robert-
Demolaize, Y. Luo, A. Marusic, and R. Tom´as, Phys.
Rev. ST Accel. Beams 16, 111001 (2013) and references
therein.

[29] D. D. Caussyn, M. Ball, B. Brabson, J. Collins, S. A.
Curtis, V. Derenchuck, D. DuPlantis, G. East, M. Elli-
son, T. Ellison, D. Friesel, B. Hamilton, W. P. Jones, W.
Lamble, S. Y. Lee, D. Li, M. G. Minty, T. Sloan, G. Xu,
A. W. Chao, K. Y. Ng, and S. Tepikian, Phys. Rev. A
46, 7942 (1992).

[30] R. Bartolini and F. Schmidt, LHC Project note 132 (re-
vised 3rd revision May 2005), Part. Accelerators. 59, pp.
93-106, (1998).

[31] A. Franchi, PhD thesis, GSI DISS 2006-07 (2006). Ph.D.
thesis, J.W. Goethe University (Report No. GSI DISS
2006-07, 2006).

[32] G. Rehm, Proceedings of the European Particle Acceler-

[18] A. Terebilo, Proceedings of PAC01, p 3203, Chicago, Illi-

ator Conference EPAC08, Genoa, Italy, 2008, p. 1016.

nois, USA (2001).

[19] A. Langner and R. Tom´as, Phys. Rev. ST Accel.

Beams,18, 031002 (2015).

[20] T. Persson and R. Tom´as, Phys. Rev. ST Accel.

Beams,17, 051004 (2014).

[21] A. Franchi, E. M´etral, and R. Tom´as Garc´ıa, Phys. Rev.

ST Accel. Beams, vol. 10, 064003 (2007).

[22] A. Franchi, L. Farvacque, J. Chavanne, F. Ewald, B.
Nash, K. Scheidt and R. Tom´as, Phys. Rev. ST Accel.

[33] S. Xu, G. Decker, H. Bui, H. Shang, F.R. Lenkszus, R.
Laird, C. Yao, Proceedings of the International Particle
Accelerator Conference, IPAC10, Kyoto, Japan, 2010, p.
1176

[34] R.E. Meller, A.W. Chao, J.M. Peterson, S.G. Peggs, M.

Furman, Technical Report SSC-N-360, SSCL, 1987.
[35] S.Y. Lee, Technical Report SSC-N-749, SSCL, 1991.
[36] A. Sargsyan, Nucl. Instr. and Meth. A, vol. 638, pp. 15-

18 (2011).

