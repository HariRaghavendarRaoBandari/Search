6
1
0
2

 
r
a

 

M
5
1

 
 
]

POROSITY, DIFFERENTIABILITY AND PANSU’S

THEOREM

ANDREA PINAMONTI AND GARETH SPEIGHT

Abstract. We use porosity to study diﬀerentiability of Lipschitz maps
on Carnot groups. Our ﬁrst result states that directional derivatives of a
Lipschitz function act linearly outside a σ-porous set. The second result
states that irregular points of a Lipschitz function form a σ-porous set.
We use these observations to give a new proof of Pansu’s theorem for
Lipschitz maps from a general Carnot group to a Euclidean space.

.

G
M
h
t
a
m

[
 
 

1
v
8
1
8
4
0

.

3
0
6
1
:
v
i
X
r
a

1. Introduction

A Carnot group (Deﬁnition 2.1) is a connected and simpy connected Lie
group whose Lie algebra admits a stratiﬁcation. Carnot groups have transla-
tions, dilations, Haar measure and points are connected by horizontal curves
(Deﬁnition 2.2), which are used to deﬁne the Carnot-Carath´eodory distance.
With so much structure, the study of analysis and geometry in Carnot groups
is an active and interesting research area [1, 2, 4, 8, 13, 19, 25, 27].

The geometry of Carnot groups is highly non-trivial. For instance, any
Carnot group (except for Euclidean spaces themselves) contains no subset
of positive measure that is bi-Lipschitz equivalent to a subset of a Euclidean
space [24]. This follows from Pansu’s theorem (Theorem 2.6), a generaliza-
tion of Rademacher’s theorem, which asserts that Lipschitz maps between
Carnot groups are diﬀerentiable almost everywhere [20, 17]. Diﬀerentiabil-
ity of maps between Carnot groups is deﬁned like that of maps between
Euclidean spaces, but Euclidean translations, dilations and distances are
replaced by their analogues in Carnot groups.

Many interesting geometric and analytic problems have been studied in
the context of Carnot groups. For example, a geometric notion of intrinsic
Lipschitz function between subgroups of a general Carnot group was intro-
duced in [11] to study rectiﬁable sets [12, 18] and minimal surfaces [5, 6, 26].
Moreover, Carnot groups have been applied to study degenerate equations,
control theory and potential theory [4]. More recently, they were also con-
sidered in applied mathematics, such as mathematical ﬁnance, theoretical
computer science and mathematical models for neurosciences [7].

Date: March 15, 2016.
2010 Mathematics Subject Classiﬁcation. 28A75, 43A80, 49Q15, 53C17.
Key words and phrases. Pansu’s theorem, Porous set, Carnot group.

1

2

ANDREA PINAMONTI AND GARETH SPEIGHT

In this paper, we generalize to Carnot groups two statements assert-
ing that a set of exceptional points concerning directional derivatives is
σ-porous, and use them to give a new proof of Pansu’s theorem for Lips-
chitz maps from a general Carnot group to a Euclidean space.

A set in a metric space is (upper) porous (Deﬁnition 2.7) if each of its
points sees nearby relatively large holes in the set on arbitrarily small scales.
A set is σ-porous if it is a countable union of porous sets. Porous sets have
applications to topics like cluster set theory and diﬀerentiability of Lipschitz
or convex mappings. Note there are several other types of porosity with their
own applications. Properties and applications of porous sets are thoroughly
discussed in the survey articles [28, 29].

Stating that an exceptional set is σ-porous is useful because σ-porous sets
in metric spaces are of ﬁrst category, and σ-porous sets in Euclidean spaces
have Lebesgue measure zero. Proving that a set is σ-porous usually gives
a stronger result than showing it is of ﬁrst category or has measure zero:
any topologically complete metric space without isolated points contains a
closed nowhere dense set which is not σ-porous, and Rn contains a closed
nowhere dense set of Lebesgue measure zero which is not σ-porous [28].

Porosity has been used to study diﬀerentiability of Lipschitz mappings,
even very recently. Indeed, [15] gives a version of Rademacher’s theorem for
Frech´et diﬀerentiability of Lipschitz mappings on Banach spaces in which
porous sets are Γ-null. Roughly, a set is Γ-null if it meets typical inﬁnite
dimensional C 1 surfaces in measure zero. Applications of porosity to study
diﬀerentiability in inﬁnite dimensional Banach spaces are thoroughly dis-
cussed in the recent book [16]. In the ﬁnite dimensional setting, porosity
and construction of large directional derivatives were recently used in [21]
to obtain the following result: for any n > 1, there exists a Lebesgue null
set in Rn containing a point of diﬀerentiability for every Lipschitz mapping
from Rn to Rn−1. Directional derivatives also played a key role in the proof
of the following result in a Carnot group: there exists a measure zero set N
in the Heisenberg group Hn such that every Lipschitz map f : Hn → R is
Pansu diﬀerentiable at a point of N [22].

We now brieﬂy describe the results of this paper.
For a Lipschitz function f : Rn → R, directional derivatives need not act
linearly: f ′(x, u + v) may not agree with f ′(x, u) + f ′(x, v) (see Example 3.1
for a simple example). However, [23, Theorem 2] asserts that such an impli-
cation does hold at points x outside a σ porous (even σ-directionally porous)
set depending on f , even for Lipschitz maps on separable Banach spaces.
We prove a similar statement in Carnot groups: directional derivatives (in
horizontal directions) for Lipschitz maps act linearly outside a σ-porous set
(Theorem 3.8). Note that in Carnot groups it only makes sense to consider
directional derivatives in horizontal derivatives, since the composition of a
Lipschitz function with a non-horizontal curve may not be Lipschitz, and
consequently may fail to be diﬀerentiable. To relate directional derivatives
in the diﬀerent directions and hence prove Theorem 3.8, we prove and apply

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

3

Lemma 3.5 which shows how to move in a direction U + V by repeatedly
moving in horizontal directions U and V . Such a statement is non-trivial,
since U and V are left-invariant vector ﬁelds whose direction depends upon
the point where they are evaluated. Roughly, the porous sets appearing in
Theorem 3.8 are sets of points at which (on some scale and to some speciﬁed
accuracy) a Lipschitz function is approximated by directional derivatives in
directions U and V , but is not well approximated by the sum of the direc-
tional derivatives in the direction U + V .

If a Lipschitz map f : Rn → R has all directional derivatives at a point
x ∈ Rn and directional derivatives at x act linearly, then by deﬁnition f is
diﬀerentiable at x. In Carnot groups we observe that existence and linear
action of only directional derivatives in horizontal directions does not imply
Pansu diﬀerentiability (Example 4.1). To pass from directional derivatives
to Pansu diﬀerentiability, we ﬁrst give another application of porosity.

A point x is a regular point of a Lipschitz function f if whenever a direc-
tional derivative of f at x in some direction exists, then that same directional
derivative also controls changes in f along parallel lines with the same di-
rection close to x (Deﬁnition 4.2). Proposition 4.3 adapts [15, Proposition
3.3] to Carnot groups, showing that the set of points at which a Lipschitz
function is not regular is σ-porous.

We next prove Theorem 4.6. This states that if f : G → R is Lipschitz and
x is a regular point at which directional derivatives exist and act linearly,
then f is Pansu diﬀerentiable at x. To prove this we use Lemma 4.5, which
provides a relatively short horizontal path from x to any nearby point which
is a concatenation of lines in directions of a basis of V1. We use regularity
of the point x to estimate changes along these lines using the directional
derivatives at x, then linear action of directional derivatives to show that
the derivative is indeed a group linear map.

As a consequence of Theorem 3.8, Proposition 4.3 and Theorem 4.6, we
obtain Corollary 4.8. This asserts that existence of directional derivatives
implies Pansu diﬀerentiability outside a σ-porous set. Since it is not hard
to show that directional derivatives of a Lipschitz function exist almost
everywhere (Lemma 4.10) and porous sets have measure zero, we obtain a
new proof of Pansu’s Theorem (Corollary 4.11) for mappings from Carnot
groups to Euclidean spaces.

2. Preliminaries

We now brieﬂy describe the main notions and results used in the paper;

the reader can consult [4] for more details.

2.1. Carnot groups. Recall that a Lie group is a smooth manifold which
is also a group for which multiplication and inversion are smooth. The Lie
algebra associated to a Lie group is the space of left invariant vector ﬁelds
equipped with the Lie bracket [·, ·] deﬁned on smooth functions by

[X, Y ](f ) = X(Y (f )) − Y (X(f )).

4

ANDREA PINAMONTI AND GARETH SPEIGHT

We also denote the direct sum of vector spaces V and W by V ⊕ W .

Deﬁnition 2.1. A simply connected ﬁnite dimensional Lie group G is said
to be a Carnot group of step s if its Lie algebra G is stratiﬁed of step s, this
means that there exist linear subspaces V1, ..., Vs of G such that

G = V1 ⊕ · · · ⊕ Vs

with

[V1, Vi] = Vi+1 if 1 ≤ i ≤ s − 1, and [V1, Vs] = {0}.

Here [V1, Vi] := span{[a, b] : a ∈ V1, b ∈ Vi}.

It can be shown that Deﬁnition 2.1 implies [Vi, Vj] ⊂ Vi+j if i + j ≤ r and

[Vi, Vj] = {0} if i + j > r [4, Proposition 1.1.7].

Let mi := dim(Vi), hi := m1 + · · · + mi for 1 ≤ i ≤ s, and h0 := 0. A
basis X1, . . . , Xn of G is adapted to the stratiﬁcation if Xhi−1+1, . . . , Xhi is a
basis of Vi for 1 ≤ i ≤ s. We deﬁne m := m1 = dim(V1) and note n = hs.
The basis X1, . . . , Xm of V1 induces an inner product ω(·, ·) on V1 for which
X1, . . . , Xm is orthonormal. We denote by ω(·) the norm on V1 induced by
this inner product.

We recall the exponential map exp : G → G is deﬁned by exp(X) = γ(1)
where γ : [0, 1] → G is the unique solution to γ′(t) = X(γ(t)) and γ(0) = 0.
The exponential map is a diﬀeomorphism between G and G. Using the
basis X1, . . . , Xn to identify G with Rn, we can identify G with Rn by the
correspondence:

exp(a1X1 + . . . + anXn) ∈ G ←→ (x1, . . . , xn) ∈ Rn.

Using this identiﬁcation of G with Rn, [4, Corollary 1.3.19] states that if
hl−1 < j ≤ hl for some 1 ≤ l ≤ s then:

Xj(x) = ∂j +

nXi>hl

qi,j(x)∂i

i = 1, . . . , m,

(2.1)

i>hl

ej +Pn

where qi,j are suitable homogeneous polynomials completely determined by
the group law in G. Using (2.1) we can identify Xj(x) with the vector
qi,j(x)ei where ej is the j’th element of the canonical basis of
Rn. Denote by p : Rn → Rm the projection onto the ﬁrst m coordinates,
given by p(x) = (x1, . . . , xm). Then p(Xj(x)) is independent of x ∈ G, so
we can unambiguously deﬁne p(Xj) = p(Xj(x)) = ej for every x ∈ G and
j = 1, . . . , m. We extend this deﬁnition by linearity to all V1, in particular
p(U (x)) = p(U (y)) for every x, y ∈ Rn, U ∈ V1.

To compute the group law in coordinates, it is possible to deﬁne a mapping
⋄ : G × G → G for which (G, ⋄) is a Lie group and exp : (G, ⋄) → (G, ·) is a
group isomorphism [4, Theorem 2.2.13], in particular:

exp(X) exp(Y ) = exp(X ⋄ Y )

for all X, Y ∈ G.

(2.2)

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

5

The Baker-Campbell-Hausdorf formula gives a formula for ⋄:

X ⋄ Y = X + Y +

1
2

[X, Y ] +

1
12

([X, [X, Y ]] + [Y, [Y, X]]) + . . . ,

(2.3)

where the higher order terms are nested commutators of X and Y .

Denoting points of G by (x1, . . . , xn) ∈ Rn, the homogeneity di ∈ N of the

variable xi is deﬁned by

dj = i whenever hi−1 + 1 ≤ j ≤ hi.

For any λ > 0, the dilation δλ : G → G, is deﬁned in coordinates by

δλ(x1, ..., xn) = (λd1 x1, ..., λdn xn)

and satisﬁes δλ(xy) = δλ(x)δλ(y). Using the exponential map, dilations
satisfying exp ◦δλ = δλ ◦exp can be deﬁned on G. These satisfy δλ(E) = λiE
if E ∈ Vi for some 1 ≤ i ≤ s.

A Haar measure on G is a non-trivial Borel measure µ on G satisfying
µ(gE) = µ(E) for any g ∈ G and Borel set E ⊂ G. Such a measure is
unique up to scaling by a positive constant, so sets of measure zero are
Identifying G with Rn, any Haar measure is
deﬁned without ambiguity.
simply a constant multiple of n dimensional Lebesgue measure Ln.

2.2. Carnot-Carath´eodory distance. Recall that a curve γ : [a, b] → Rn
is absolutely continuous if it is diﬀerentiable almost everywhere, γ′ ∈ L1[a, b]
and

γ(t2) = γ(t1) +Z t2

t1

γ′(t) dt

whenever t1, t2 ∈ [a, b].

Deﬁnition 2.2. An absolutely continuous curve γ : [a, b] → G is horizontal
if there exist u1, . . . , um ∈ L1[a, b] such that

γ′(t) =

mXj=1

uj(t)Xj(γ(t))

for almost every t ∈ [a, b]. We deﬁne the horizontal length of such a curve
γ by:

L(γ) =Z b

a

|u(t)| dt,

where u = (u1, . . . , um) and | · | denotes the Euclidean norm on Rm.

The Chow-Rashevskii Theorem asserts that any two points of G can be

connected by horizontal curves [4, Theorem 9.1.3].

Deﬁnition 2.3. The Carnot-Carath´eodory distance d on G is deﬁned by:

d(x, y) = inf{L(γ) : γ : [0, 1] → G horizontal joining x to y}

for x, y ∈ G.

6

ANDREA PINAMONTI AND GARETH SPEIGHT

It is well-known that the Carnot-Carath´eodory distance satisﬁes the re-
lations d(zx, zy) = d(x, y) and d(δr(x), δr(y)) = rd(x, y) for x, y, z ∈ G and
r > 0. It induces on G the same topology as the Euclidean distance but is
not bi-Lipschitz equivalent to the Euclidean distance. It follows from the
deﬁnition of the exponential map that d(exp(tE)) ≤ |t|ω(E) whenever t ∈ R
and E ∈ V1.

A homogeneous norm on G is a continuous function D : G → [0, ∞) such
that D(δλ(x)) = λD(x) for every λ > 0 and x ∈ G, and D(x) > 0 if and
only if x 6= 0. We will mostly use the homogeneous norm d(x) := d(x, 0),
but it is also useful to consider the homogeneous norm given by the explicit
formula:

kxk :=  sXi=1

2s!

|xi|2r!/i! 1

(2.4)

where x = (x1, . . . , xs) ∈ Rm×· · ·×Rms = Rn and |xi| denotes the Euclidean
norm on Rmi. By [4, Proposition 5.1.4] there exists c > 0 such that

c−1kxk ≤ d(x) ≤ ckxk

for every x ∈ G.

(2.5)

2.3. Directional derivatives and Pansu diﬀerentiability. If x ∈ G and
E ∈ V1 is horizontal then the map t 7→ x exp(tE) is Lipschitz. Consequently
if f : G → R is Lipschitz then the composition t 7→ f (x exp(tE)) is a Lips-
chitz mapping from R to itself, hence diﬀerentiable almost everywhere. Thus
it makes sense to deﬁne directional derivatives of Lipschitz maps f : G → R
in horizontal directions. Note, however, that if E ∈ G \ V1 then the composi-
tion t 7→ f (x exp(tE)) may not be Lipschitz. In this paper we only consider
directional derivatives in horizontal directions, as in [22].

Deﬁnition 2.4. Suppose f : G → R, x ∈ G and E ∈ V1. We say that f is
diﬀerentiable at x in direction E if the limit

Ef (x) = lim
t→0

f (x exp(tE)) − f (x)

t

exists.

Suppose f : G → R, x ∈ G and Xjf (x) exists for every 1 ≤ j ≤ m. Then

we deﬁne the horizontal gradient of f at x by

∇Hf (x) :=

(Xif (x))Xi(x),

mXi=1

which can be represented in coordinates by (X1f (x), ..., Xmf (x)) ∈ Rm.

Let eG be a Carnot group with distance ed and dilationseδr.
Deﬁnition 2.5. A map L : G → eG is group linear if L(xy) = L(x)L(y) and
L(δr(x)) =eδr(L(x)) whenever x, y ∈ G and r > 0.

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

7

A map f : G → eG is Pansu diﬀerentiable at x0 ∈ G if there exists a group
linear map L : G → eG such that

= 0.

lim

h→0 ed(f (x)−1f (xh), L(h))

d(h)

If such a map L exists then it is unique and we denote it by df .

The following fundamental result generalizes Rademacher’s theorem to

Carnot groups and is due to Pansu [20].

f is Pansu diﬀerentiable almost everywhere.

Theorem 2.6 (Pansu’s Theorem). Let f : G → eG be a Lipschitz map. Then

We ﬁx a Carnot group G and an adapted basis X1, . . . , Xn of G, with

corresponding inner product norm ω, throughout this paper.

2.4. Porous sets. We now deﬁne porous sets and σ-porous sets; for more
information see the extensive survey articles [28, 29]. Intuitively, a set is
porous if every point of the set sees relatively large holes in the set on
arbitrarily small scales. We denote by B(x, r) the open ball of centre x and
radius r > 0 in a metric space.

Deﬁnition 2.7. Let (M, ρ) be a metric space, E ⊂ M and a ∈ M . We say
that E is porous at a if there exist λ > 0 and a sequence xn → a such that

B(xn, λρ(a, xn)) ∩ E = ∅

for every n ∈ N.

A set E is porous if it is porous at each point a ∈ E with λ independent

of a. A set is σ-porous if it is a countable union of porous sets.

Porous sets in Carnot groups have measure zero. This follows from the
fact that Haar measure on Carnot groups is Ahlfors regular, hence doubling,
so the Lebesgue diﬀerentiation theorem applies [14, Theorem 1.8].
If a
porous set had positive measure then it would have a Lebesgue density point,
which is impossible due to the presence of relatively large holes, which have
relatively large measure, on arbitrarily small scales.

3. Directional derivatives acting linearly

Even for a Lipschitz function f : R2 → R with all directional derivatives
f ′(x, v) at a point x ∈ R2, directional derivatives need not act linearly:
f ′(x, a1v1 + a2v2) 6= a1f ′(x, v1) + a2f ′(x, v2) in general. Consequently, ex-
istence of directional derivatives alone does not suﬃce for diﬀerentiability.
We illustrate this with a simple example.
Example 3.1. Deﬁne f : R2 → R by f (x, y) = min(x, y). Then f is a Lip-
schitz function with all directional derivatives at (0, 0). However, f is not
diﬀerentiable at (0, 0), since:

f ′((0, 0), (1, 1)) = 1 6= 0 =

∂f
∂x

(0, 0) +

∂f
∂y

(0, 0).

8

ANDREA PINAMONTI AND GARETH SPEIGHT

If x lies outside a σ-porous set depending on f , then directional derivatives
do act linearly: if f ′(x, v1) and f ′(x, v2) exist then f ′(x, a1v1 + a2v2) exists
and is equal to a1f ′(x, v1) + a2f ′(x, v2). Such a statement holds even for
Lipschitz maps from a separable Banach space X to a Banach space Y [23,
Theorem 2]. In this section we prove an analogue in Carnot groups, showing
that directional derivatives act linearly outside a σ-porous set (Theorem 3.8).

3.1. Geometric lemmas. We now give several results describing the ge-
ometry of Carnot groups, essential for our study of porosity and diﬀeren-
tiability. Before proving the ﬁrst geometric lemma, we state an estimate
for the norm of a commutator of group elements [10, Lemma 2.13]. Recall
that G is a Carnot group of step s, hs := n and the homogeneous norm
k · k was deﬁned in (2.4). The following lemma is stated using a diﬀer-
ent homogeneous norm in [10]. However the desired statement follows from
[10, Lemma 2.13] because any two homogeneous norms diﬀer by a constant
multiplicative factor.

Lemma 3.2. There is a constant C > 0 such that

kx−1yxk ≤ C(cid:16)kyk + kxk

1
s kyk

s−1
s + kxk

s−1
s kyk

1

s(cid:17) for x, y ∈ G.

The ﬁrst geometric lemma bounds the Carnot-Carath´eodory distance be-
tween points obtained by ﬂowing from two nearby points in the direction of
the same horizontal vector ﬁeld.

Lemma 3.3. Suppose λ ∈ (0, 1) and t ∈ (−1, 1). Let x, y ∈ G satisfy
d(x, y) ≤ λ|t| and U ∈ V1. Then, there exists C = C1 > 0 such that

d(x exp(tU ), y exp(tU )) ≤ Cλ1/s|t| max(1, ω(U )).

Proof. Throughout the proof C will denote a positive constant depending
only on G and possibly diﬀerent from line to line. Using equation (2.5), we
can estimate with the equivalent homogeneous norm k · k instead of d(·).
Without loss of generality assume y = 0 and s ≥ 2. Indeed, if s = 1 then
G ≡ Rn and

k exp(tU )−1x exp(tU )k = kxk ≤ Cλ|t|

so the statement follows. Now suppose s ≥ 2. Using Lemma 3.2 and the
bound kxk ≤ Cλ|t| we have:

k exp(tU )−1x exp(tU )k ≤ C(cid:16)kxk + kxk
= C(cid:16)kxk + kxk
≤ C|t|(cid:16)λ + λ
s(cid:16)1 + ω(U )

≤ C|t|λ

1
s ω(U )

1
s |t|

1

1
s k exp(tU )k

s−1
s + kxk

s−1
s k exp(tU )k

s−1
s ω(U )

s−1
s + kxk

s−1
s |t|

1
s ω(U )

1

s(cid:17)
s(cid:17)

1

s−1
s + λ

s−1
s ω(U )

s−1
s + ω(U )

1

s(cid:17)

1

s(cid:17),

where in the last inequality we used λ ∈ (0, 1) and s ≥ 2. The conclusion
easily follows.
(cid:3)

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

9

We next recall [4, Lemma 19.1.4], as summarized in [4, page 717]. Keeping
in mind (2.2), the lemma describes how to move in the direction of a Lie
bracket of many directions, by moving repeatedly backwards and forwards
in the individual directions. Recall that an iterated bracket is of length k
with entries Y1, . . . , Yq if it is of the form [Yj1, . . . [Yjk−1, Yjk ] . . .] for some
multi-index (j1, . . . , jk) ∈ {1, . . . , q}k.

Lemma 3.4. Suppose Y1, . . . , Yq ∈ G. Then we can write

[Yq, . . . [Y2, Y1] . . .] = Yj1 ⋄ · · · ⋄ Yjc(q) + R(Y1, . . . , Yq),

where c(q) is an integer depending only on q, and

Yj1, . . . , Yjc(q) ∈ {±Y1, . . . , ±Yq}.

The remainder term R(Y1, . . . , Yq) is a linear combination of brackets of
length ≥ q + 1 of the vector ﬁelds Y1, . . . , Yq.

The next lemma shows how to move in a direction U + V by repeat-
edly making increments in directions U and V . Such a statement will be
useful when we want to relate directional derivatives in direction U + V to
directional derivatives in direction U and in direction V .

Lemma 3.5. There is a constant C = C2 > 0 for which the following holds.
For any pair U, V ∈ V1, there exist U1, . . . , UN ∈ {U, V } and ρ1, . . . , ρN ∈ R
with |ρi| ≤ C and N ≤ C such that

exp(U + V ) = exp(ρ1U1) exp(ρ2U2) · · · exp(ρN UN ).

Proof. We prove the lemma by induction on the step of G. Throughout the
proof, C denotes a constant depending only on G, which may vary from line
to line. If G has step one the statement is clear: simply take N = 2, U1 = U ,
U2 = V and use the equality:

exp(U + V ) = exp(U ) exp(V ),

which follows from the Baker-Campbell-Hausdorﬀ formula (2.2) and (2.3).
Suppose s > 1 and the lemma holds for Carnot groups of step s − 1.
Let G be a Carnot group of step s with Lie algebra G = V1 ⊕ · · · ⊕ Vs and
adapted basis X1, . . . , Xn of G. Let q = hs−1, then X1, . . . , Xq is a basis of
V1 ⊕ · · · ⊕ Vs−1 and Xq+1, . . . , Xn is a basis of Vs.

Claim 3.6. There exists a Carnot group H of step s − 1 whose Lie algebra
H = W1 ⊕ · · · ⊕ Ws−1 is spanned by an adapted basis Y1, . . . , Yq, with Lie
bracket deﬁned as follows:

akYk

if

[Xi, Xj]G =

akXk.

(3.1)

[Yi, Yj]H =

qXk=1

nXk=1

Proof. Fix a q-dimensional vector space H and a basis Y1, . . . , Yq of H. For
1 ≤ i ≤ s − 1 deﬁne:

Wi = span{Yj : Xj ∈ Vi}.

10

ANDREA PINAMONTI AND GARETH SPEIGHT

Then H = W1 ⊕ · · · ⊕ Ws−1 and Ws−1 6= 0. Deﬁne [·, ·]H : H × H → H
using (3.1) and bilinearity. The vector space H equipped with [·, ·]H is a Lie
algebra, so there exists a simply connected Lie group H with Lie algebra H
[4, Theorem 2.2.14]. Using (3.1), one can check:

[W1, Wi]H = Wi+1 for 1 ≤ i ≤ s − 2, and [W1, Ws−1]H = {0}.

Hence H is a Carnot group of step s − 1.

(cid:3)

Using (3.1), we can choose a Lie algebra homomorphism ϕ : G → H sat-
isfying ϕ(Xi) = Yi for 1 ≤ i ≤ q and ϕ(Xi) = 0 if q < i ≤ n. The kernel of
ϕ is Vs. We may choose a Lie group homomorphism F : G → H satisfying
dF = ϕ [4, Remark 2.1.60].

Suppose U, V ∈ V1. Then dF (U ), dF (V ) ∈ W1. Since H has step s − 1, we
may apply our inductive hypothesis to H and use linearity of dF to write:

expH(dF (U + V )) = expH(ρ1dF (U1)) · · · expH(ρN dF (UN )),

(3.2)

with Ui ∈ {U, V }, |ρi| ≤ C and N ≤ C. Here C is a constant depending only
on H, hence C is determined by G. Since F is a Lie group homomorphism,
the equality expH ◦ dF = F ◦ expG holds. Hence (3.2) implies:

F (expG(U + V )) = F (expG(ρ1U1)) · · · F (expG(ρN UN ))

= F (expG(ρ1U1) · · · expG(ρN UN )).

(3.3)

Claim 3.7. There exists Z ∈ Vs such that

expG(U + V + Z) = expG(ρ1U1) · · · expG(ρN UN ).

(3.4)

Furthermore, Z = η1Z1 + . . . + ηpZp with |ηi| ≤ C and p ≤ C for a constant
C determined by G. Each term Zi is a Lie bracket of length s of U and V .

Proof. The map expG is a diﬀeomorphism, so necessarily there exists Z ∈ G
such that (3.4) holds. Combining (3.3) and (3.4) gives:

F (expG(U + V + Z)) = F (expG(U + V )).

Hence:

expH(dF (U ) + dF (V ) + dF (Z)) = expH(dF (U ) + dF (V )).

Since expH is a diﬀeomorphism this implies

dF (U ) + dF (V ) + dF (Z) = dF (U ) + dF (V ),

so dF (Z) = 0. The kernel of dF is Vs, so Z ∈ Vs. By (3.4), the fact that
expG is invertible and (2.2) we obtain:

Z = exp−1

G (expG(ρ1U1) · · · expG(ρN UN )) − U − V

(3.5)

= (ρ1U1) ⋄ · · · ⋄ (ρN UN ) − U − V.

Using the Baker-Campbell-Hausdorﬀ formula (2.3) we can write:

Z = J1 + . . . + Js,

(3.6)

where each Ji is a linear combination of Lie brackets of length i of U and V .
The number of terms in each linear combination is bounded by a constant

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

11

depending on G. The scalars in these linear combinations are polynomials in
the numbers ρi, with bounded degree and coeﬃcients. Since the numbers ρi
are uniformly bounded, the scalars are also bounded by a constant depending
on G. Note Z ∈ Vs implies Ji = 0 for every 1 ≤ i ≤ s − 1. Hence Z = Js is
of the desired form.
(cid:3)

Any of the Zi in Claim 3.7 can be written in the form:

[Es, . . . [E2, E1] . . .]G ∈ Vs,

Ei ∈ {U, V }.

(3.7)

Given such a Lie bracket, use Lemma 3.4 to ﬁnd j1, . . . , jc(s) such that

[Es, . . . [E2, E1] . . .]G = Ej1 ⋄ · · · ⋄ Ejc(s) + R(E1, . . . , Es),

where c(s) is an integer depending only on s, and

Ej1, . . . , Ejc(s) ∈ {±U, ±V }.

The remainder term R(E1, . . . , Es) is a linear combination of brackets of
height ≥ s + 1 of the vector ﬁelds E1, . . . , Es. Since G has step s, this
implies R = 0. Consequently:

[Es, . . . [E2, E1] . . .]G = Ej1 ⋄ · · · ⋄ Ejc(s).

Using (2.2), this implies:

expG([Es, . . . [E2, E1] . . .]G) = expG(Ej1) · · · expG(Ejc(s)),

(3.8)

where c(s) ≤ C.

Claim 3.7 states that Z = η1Z1 +. . .+ηpZp with |ηi| ≤ C, p ≤ C and each
Zi of the form in (3.7). Since Zi ∈ Vs for 1 ≤ i ≤ p we have [Zi, Zj]G = 0,
so:

expG(Z) = expG(η1Z1) · · · expG(ηpZp).

Hence we may use (3.8) for each Zi and combine the resulting expressions
to write:

expG(Z) = expG(δ1Q1) · · · exp(δM QM ),

(3.9)

with M ≤ C, |δi| ≤ C and Qi ∈ {U, V }. Combining (3.4) and (3.9), we
deduce:

expG(ρ1U1) · · · expG(ρN UN ) expG(−δM QM ) · · · expG(−δ1Q1)

= expG(U + V + Z) expG(−Z)
= expG(U + V ).

(3.10)

The second equality follows from the fact Z ∈ Vs so [U + V + Z, −Z]G = 0
and the Baker-Campbell-Hausdorﬀ formula (2.3) simpliﬁes. Notice that
|ρi|, |δi|, N, M ≤ C and Ui, Qi ∈ {U, V }, so (3.10) gives the required repre-
sentation holds for exp(U + V ). Hence the lemma holds for G which has
step s. This completes the inductive step, proving the lemma.
(cid:3)

12

ANDREA PINAMONTI AND GARETH SPEIGHT

3.2. Geometry to diﬀerentiability. We now use Lemma 3.3 and Lemma
3.5 to show directional derivatives act linearly outside a σ-porous set.

Theorem 3.8. Suppose f : G → R is Lipschitz. Then there is a σ-porous set
A ⊂ G such that directional derivatives act linearly at every point x ∈ G \ A,
namely the following implication holds: if E1f (x) and E2f (x) exist for some
E1, E2 ∈ V1, then (a1E1 + a2E2)f (x) exists and

(a1E1 + a2E2)f (x) = a1E1f (x) + a2E2f (x)

for all a1, a2 ∈ R.

It follows directly from the deﬁnition that if a directional derivative Ef (x)
exists then (sE)f (x) exists and is equal to s(E(f (x))) for any s ∈ R. Hence
to prove Theorem 3.8 we may assume a1 = a2 = 1.

Recall the constant C2 from Lemma 3.5. Given U, V ∈ V1 \ {0}, y, z ∈ R
and ε, δ > 0, let A(U, V, y, z, ε, δ) be the set of x ∈ G such that for all |t| < δ:

|f (x exp(tU )) − f (x) − ty| ≤ ε|t|,

|f (x exp(tV )) − f (x) − tz| ≤ ε|t|,

(3.11)

(3.12)

and there exist arbitrarily small t for which:

|f (x exp(tU + tV )) − f (x) − t(y + z)| > 2εC2|t|.

(3.13)

Fix x ∈ A(U, V, y, z, ε, δ). Use Lemma 3.5 to choose U1, . . . , UN ∈ {U, V }

and ρ1, . . . , ρN ∈ R with |ρi| ≤ C2 and N ≤ C2 such that

exp(U + V ) = exp(ρ1U1) · · · exp(ρN UN ).

(3.14)

Choose

|t| < min(cid:18)δ,

(1 + ω(U ) + ω(V ))C2(cid:19)

1

(3.15)

satisfying (3.13). Dilating both sides of (3.14) by the factor t gives:

exp(tU + tV ) = exp(tρ1U1) · · · exp(tρN UN ).

(3.16)

Let x0 = x. For 1 ≤ i ≤ N let xi = xi−1 exp(tρiUi), yi = y if Ui = U and

yi = z if Ui = V . Note that xN = x exp(tU + tV ) by (3.16).

Claim 3.9. If U and V are linearly independent then the following state-
ments hold:

i=1 ρiyi = y + z,

(2) there exists 0 ≤ i ≤ N − 1 such that

(1) PN

|f (xi+1) − f (xi) − tρi+1yi+1| > 2ε|t|.

Proof. We ﬁrst verify (1). Deﬁne:

IU = {i : Ui = U } and IV = {i : Ui = V }.

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

13

Recall that p : G → Rm is the projection onto the ﬁrst m coordinates. The
equality (3.14) implies

p(U ) + p(V ) = ρ1p(U1) + . . . + ρN p(UN )

Since U, V ∈ V1 and are linearly independent, p(U ) and p(V ) are linearly
independent. Hence:

ρi(cid:17)p(V ).

ρi(cid:17)p(U ) +(cid:16)Xi∈IV
=(cid:16)Xi∈IU
Xi∈IU
ρi = Xi∈IV
ρiyi =(cid:16)Xi∈IU

ρi(cid:17)y +(cid:16)Xi∈IV

ρi = 1.

= y + z,

ρi(cid:17)z

Consequently:

NXi=1

which proves (1).

Next suppose (2) fails. Then:

|f (xi+1) − f (xi) − tρi+1yi+1| ≤ 2ε|t| for 0 ≤ i ≤ N − 1.

(3.17)

We estimate using (1), (3.17) and N ≤ C2:

f (xN ) − f (x) − t

ρiyi(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)
|f (x exp(tU + tV )) − f (x) − t(y + z)| =(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)
=(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)
(f (xi) − f (xi−1) − tρiyi)(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)
NXi=1
NXi=1

|f (xi) − f (xi−1) − tρiyi|

NXi=1

≤

≤ 2εC2|t|,

This estimate violates our choice of t satisfying (3.13). This proves (2). (cid:3)

Claim 3.10. The set A(U, V, y, z, ε, δ) is porous for each choice of the pa-
rameters U, V, y, z, ε, δ.

Proof. We may assume that U and V are linearly independent, otherwise
A(U, V, y, z, ε, δ) = ∅ and the claim is trivial. Use Claim 3.9(2) and the
equality xi+1 = xi exp(tρi+1Ui+1) to choose 0 ≤ i ≤ N − 1 satisfying:

|f (xi exp(tρi+1Ui+1)) − f (xi) − tρi+1yi+1| > 2ε|t|.

(3.18)

Recall the constant C1 > 0 deﬁned in Lemma 3.3. Let
Λ = 2Lip(f )C1C2 max(ω(U ), ω(V )),

λ = min(cid:18) εs

Λs ,

ε

2Lip(f )

, 1(cid:19) ,

(3.19)

14

and

ANDREA PINAMONTI AND GARETH SPEIGHT

Fix q ∈ B(xi, r). We will apply Lemma 3.3 with parameters:

r = min(λω(U ), λω(V ), λ)|t|.

(3.20)

• λ as deﬁned in (3.19),
• t replaced by tρi+1ω(Ui+1),
• x replaced by xi,
• y replaced by q,
• U replaced by Ui+1/ω(Ui+1).

To see the hypotheses of Lemma 3.3 are satisﬁed, notice:

• (3.15) and the bound |ρi+1| ≤ C2 implies |tρi+1ω(Ui+1)| < 1,
• 0 < λ < 1 is clear from the deﬁnition in (3.19),
• d(xi, q) ≤ λ|t| using q ∈ B(xi, r) and the deﬁnition of r in (3.20).

Also note ω(Ui+1/ω(Ui+1)) ≤ 1 and recall |ρi+1| ≤ C2. Applying Lemma
3.3 gives:

d(xi exp(tρi+1Ui+1), q exp(tρi+1Ui+1)) ≤ C1λ1/s|tρi+1|ω(Ui+1)

≤ C1C2|t|ω(Ui+1)λ1/s
≤ C1C2|t|ω(Ui+1)ε/Λ
≤ ε|t|/(2Lip(f )).

Hence:

|f (xi exp(tρi+1Ui+1)) − f (q exp(tρi+1Ui+1))| ≤ ε|t|/2.

(3.21)

Since q ∈ B(xi, r) we can also estimate:

|f (xi) − f (q)| ≤ Lip(f )r ≤ Lip(f )λ|t| ≤ ε|t|/2.

(3.22)

Applying (3.18) together with (3.21) and (3.22) gives:

|f (q exp(tρi+1Ui+1)) − f (q) − tρi+1yi+1| > ε|t|.

(3.23)

Recall that either Ui+1 = U and yi+1 = y or Ui+1 = V and yi+1 = z. Hence
(3.23) shows that (3.11) or (3.12) fails with x replaced by q. Consequently
q /∈ A(U, V, y, z, ε, δ). Since q was an arbitrary member of B(xi, r), we
deduce:

Since N ≤ C2 and |ρi| ≤ C2, we can estimate as follows:

B(xi, r) ∩ A(U, V, y, z, ε, δ) = ∅.

d(x, xi) ≤ d(x0, x1) + . . . + d(xi−1, xi)
≤ ω(tρ1U1) + . . . + ω(tρN UN )
≤ |t||ρ1|ω(U1) + . . . + |t||ρN |ω(UN )
≤ C 2

2 max(ω(U ), ω(V ))|t|.

Since r = min(λω(U ), λω(V ), λ)|t|, B(xi, r) is a relatively large hole in
A(U, V, y, z, ε, δ) close to x. Since t can be chosen arbitrarily small, it follows
that A(U, V, y, z, ε, δ) is porous at x. The point x was chosen arbitrarily from
A(U, V, y, z, ε, δ), so the claim is proven.
(cid:3)

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

15

Proof of Theorem 3.8. Fix a countable dense set W ⊂ V1. Let A be the
countable union of sets A(U, V, y, z, ε, δ), with U, V ∈ W and y, z, ε, δ ∈ Q
such that ε, δ > 0. Clearly A is σ-porous.

Suppose x ∈ G \ A and E1f (x), E2f (x) exist. Choose rational ε > 0 and

rational δ > 0 such that for all |t| < δ:

|f (x exp(tE1)) − f (x) − tE1f (x)| ≤ ε|t|/2

and

|f (x exp(tE2)) − f (x) − tE2f (x)| ≤ ε|t|/2.

Fix y, z ∈ Q such that |y − E1f (x)| < ε/4 and |z − E2f (x)| < ε/4. Choose
F1, F2 ∈ W such that

and

d(exp(E1), exp(F1)) < ε/4Lip(f ),
d(exp(E2), exp(F2)) < ε/4Lip(f ),

d(exp(E1 + E2), exp(F1 + F2)) ≤ ε.

Analogues of (3.11) and (3.12) hold with E1 replaced by F1 and E2 re-

placed by F2. For the ﬁrst one notice that for any |t| < δ:

|f (x exp tF1) − f (x) − ty| ≤ |f (x exp tE1) − f (x) − tE1f (x)|
+ |f (x exp tE1) − f (x exp tF1)|
+ |ty − tE1f (x)|

≤ ε|t|/2 + Lip(f )|t|d(exp(E1), exp(F1))

+ |t||y − E1f (x)|

≤ ε|t|.

The second estimate is similar. Since x ∈ G\A, necessarily x /∈ A(F1, F2, y, z, ε, δ).
However, (3.11) and (3.12) hold, so necessarily (3.13) fails. Hence, for all
suﬃciently small t,

|f (x exp(tF1 + tF2)) − f (x) − t(y + z)| ≤ 2εC1|t|.

This implies that for suﬃciently small t:

|f (x exp(tE1 + tE2)) − f (x) − t(E1f (x) + E2f (x))|
≤ |f (x exp(tF1 + tF2)) − f (x) − t(y + z)|

+ |t|Lip(f )d(exp(E1 + E2), exp(F1 + F2))
+ |t||E1f (x) − y| + |t||E2f (x) − z|

≤ 2εC1|t| + |t|Lip(f )ε + |t|ε/2
≤ (2C1 + Lip(f ) + 1/2)ε|t|.

This implies that (E1 + E2)f (x) exists and is equal to E1f (x) + E2f (x),
which proves the theorem.
(cid:3)

16

ANDREA PINAMONTI AND GARETH SPEIGHT

4. Regularity and differentiability

For Lipschitz maps between Euclidean spaces, existence and linear action
of directional derivatives implies diﬀerentiability (by deﬁnition). The fol-
lowing example shows that for a Lipschitz map f : G → R, existence and
linear action of directional derivatives (in only horizontal directions) does
not suﬃce for Pansu diﬀerentiability.

Example 4.1. Let H1 ≡ R3 be the ﬁrst Heisenberg group. The Heisenberg
group is the simplest example of non trivial Carnot group of step 2. The
group law has the form

(x, y, t)(x′, y′, t′) =(cid:16)x + x′, y + y′, t + t′ +

The homogeneous norm deﬁned in (2.4) reads as

1
2

(xy′ − x′y)(cid:17).

k(x, y, t)k = ((x2 + y2)2 + t2)1/4,

(x, y, t) ∈ H1

and ˜d(a, b) = ka−1bk deﬁnes a metric on H1. Let

A = (R2 × {0}) ∪ ({(0, 0)} × R) ⊂ H1,

equipped with the restriction of the metric d on H1. Deﬁne f : A → R by

f (x, y, 0) = 0 and f (0, 0, t) =p|t|. We claim that f is Lipschitz with respect

to restriction of the metric ˜d. Clearly, it suﬃces to prove that there exists
C > 0 such that

|f (x, y, 0) − f (0, 0, t)| ≤ C ˜d((x, y, 0), (0, 0, t))

for all x, y, t ∈ R (4.1)

and

|f (0, 0, t) − f (0, 0, s)| ≤ C ˜d((0, 0, t), (0, 0, s))

for all t, s ∈ R

(4.2)

Using the deﬁnition of the group law and ˜d:

and

˜d((x, y, 0), (0, 0, t)) = k(−x, −y, t)k ≥ c(cid:0)k(x, y)kR2 +p|t|(cid:1)
|f (x, y, 0) − f (0, 0, t)| =p|t| ≤

˜d((x, y, 0), (0, 0, t))

1
c

so (4.1) follows. Moreover,

|f (0, 0, t) − f (0, 0, s)| =(cid:12)(cid:12)(cid:12)p|t| −p|s|(cid:12)(cid:12)(cid:12) ≤p|t − s| = ˜d((0, 0, t), (0, 0, s)).

By the classical McShane extension theorem (see for example [14, Theorem
6.2]), f admits an extension to a Lipschitz function f : H1 → R, note that by
(2.5), f is Lipschitz also with respect to the Carnot-Carath´eodory distance
d. Clearly Ef (0, 0, 0) = 0 for all E ∈ V1, so f has all directional derivatives
and they act linearly at (0, 0, 0). Indeed, recalling that exp(tE) ∈ R2 × {0},
we have:

Ef (0, 0, 0) = lim
t→0

f (exp(tE)) − f (0, 0, 0)

t

= 0.

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

17

However, f is not Pansu diﬀerentiable at (0, 0, 0). Indeed:

|f (0, 0, t2) − f (0, 0, 0)|

d((0, 0, t2), (0, 0, 0))

=

|t|
|t|

lim
t→0

= 1 > 0.

In this section we adapt [15] to deﬁne regular points of Lipschitz functions
on Carnot groups and show that the set of irregular points of a Lipschitz
function is σ-porous (Proposition 4.3). We then show that outside another
σ-porous set, existence of directional derivatives (in horizontal directions)
implies Pansu diﬀerentiability (Theorem 4.6 and Corollary 4.8). This then
yields a new proof of Pansu’s theorem (Corollary 4.11).

4.1. Regular points. We adapt [15, Deﬁnition 3.1] from Banach spaces to
deﬁne regular points for Lipschitz maps on Carnot groups. Intuitively, x
is a regular point of f if whenever E ∈ V1 and Ef (x) exists, then Ef (x)
controls changes in f along all lines close to x in direction E.

Deﬁnition 4.2. Suppose f : G → R. We say that x ∈ G is a regular point
of f if for every E ∈ V1 for which Ef (x) exists,

lim
t→0

f (xδt(u) exp(tE)) − f (xδt(u))

t

= Ef (x)

uniformly for d(u) ≤ 1. A point is irregular if it is not regular.

We adapt [15, Proposition 3.3] from Banach spaces to show that irregular

points of a Lipschitz function form a σ-porous set.

Proposition 4.3. Let f : G → R be Lipschitz. Then the set of irregular
points of f is σ-porous.

Proof. Let J be a countable dense subset of V1. For p, q ∈ N, E ∈ J and
w ∈ Q, let Ap,q,E,w be the set of x ∈ G such that

|f (x exp tE) − f (x) − tw| ≤ |t|/p for |t| < 1/q

(4.3)

and

lim sup

t→0

sup

d(u)≤1(cid:12)(cid:12)(cid:12)(cid:12)

f (xδt(u) exp(tE)) − f (xδt(u))

t

− w(cid:12)(cid:12)(cid:12)(cid:12) > 2/p.

Fix p, q, E, w and x ∈ Ap,q,E,w. Then there are arbitrarily small |t| < 1/q
such that for some u ∈ G with d(u) ≤ 1, depending on t,

|f (xδt(u) exp(tE)) − f (xδt(u)) − tw| > 2|t|/p.

(4.4)

Let

λ = min(cid:18)

1

(2C1pLip(f )(1 + ω(E)))s ,

1

2pLip(f )

, 1(cid:19) ,

where C1 is the constant from Lemma 3.3. Fix |t| < 1/q and u ∈ G with
d(u) ≤ 1 satisfying (4.4). Suppose y ∈ B(xδt(u), λ|t|). We may apply

18

ANDREA PINAMONTI AND GARETH SPEIGHT

Lemma 3.3, with U replaced by E and x replaced by xδt(u), to obtain:

|f (y exp(tE)) − f (xδt(u) exp(tE))| ≤ Lip(f )d(y exp(tE), xδt(u) exp(tE))

≤ Lip(f )C1λ1/s|t| max(1, ω(E))
≤ |t|/2p.

Hence, using also (4.4) and the assumption d(y, xδt(u)) < λ|t|,

|f (y exp(tE)) − f (y) − tw| ≥ |f (xδt(u) exp(tE)) − f (xδt(u)) − tw|

− |f (y exp(tE)) − f (xδt(u) exp(tE))|

− |f (xδt(u)) − f (y)|

> |t|/p.

Since |t| < 1/q the previous estimate contradicts (4.3), so y /∈ Ap,q,E,w. To
summarise:

and we have shown:

d(x, xδt(u)) = d(δt(u)) ≤ |t|

B(xδt(u), λ|t|) ∩ Ap,q,E,w = ∅.

Since |t| could be chosen arbitrarily small, this shows Ap,q,E,w is porous.
Every irregular point of f belongs to one of the countable collection of
porous sets Ap,q,E,w, where p, q ∈ N, E ∈ J and w ∈ Q. Hence the set of
irregular points of f is σ-porous, as desired.
(cid:3)

4.2. Diﬀerentiability and Pansu’s theorem. To pass from directional
derivatives to Pansu’s theorem, we use a lemma showing how to join ar-
bitrary points by following directions from our chosen basis X1, . . . , Xm of
V1. To prove our desired statement we ﬁrst quote the following lemma [4,
Theorem 19.2.1].

Lemma 4.4. Let Z = {Z1, . . . , Zm} be a basis for V1 and ﬁx a homogeneous
norm ρ on G. Then there exist constants M ∈ N (depending only on G)
and c0 > 0 (depending on G, ρ and Z) for which the following holds.

For every x ∈ G, there exist x1, . . . , xM ∈ exp(V1) with the following

properties:

• x = x1 · · · xM ,
• ρ(xj) ≤ c0ρ(x) for all j = 1, . . . , M ,
• for every j = 1, . . . , M , there exist tj ∈ R and ij ∈ {1, . . . , m} such

that xj = exp(tjZij ).

Lemma 4.5. There are constants M ∈ N and Q > 0 such that the following
holds for every point h ∈ G. For 1 ≤ j ≤ M , there exist tj ≥ 0 and
Ej ∈ {±X1, . . . , ±Xm} such that:

(1) PM

j=1 tj ≤ Qd(h),

(2) h = exp(t1E1) · · · exp(tM EM ).

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

19

Proof. Apply Lemma 4.4 with the basis Z = {X1, . . . , Xm} of V1 and homo-
geneous norm x 7→ d(x) on G. We obtain M ∈ N such that for every h ∈ G,
there exist tj ∈ R and ij ∈ {1, . . . , m} for 1 ≤ j ≤ M , such that

and

h = exp(t1Xi1) · · · exp(tM XiM ),

d(exp tjXij ) ≤ c0d(h).

(4.5)

(4.6)

Since ω(Xij ) = 1 for every j, (4.6) implies |tj| ≤ c0d(h) for 1 ≤ j ≤ M .
Hence:

|tj| ≤ M c0d(h).

(4.7)

MXj=1

For each 1 ≤ j ≤ M choose Ej = Xij if tj ≥ 0, or choose Ej = −Xij and
replace tj by −tj if tj < 0. After such a replacement we have tj ≥ 0 for every
j, (4.5) still holds giving the desired equality (2), and (4.7) gives (1).
(cid:3)

We now prove a pointwise diﬀerentiability result, whose hypotheses com-

bine the various conditions we have investigated so far.

Theorem 4.6. Suppose f : G → R is Lipschitz and x ∈ G has the following
properties:

• X1f (x), . . . , Xmf (x) exist,
• directional derivatives act linearly at x,
• x is a regular point of f .

Then f is Pansu diﬀerentiable at the point x with group linear derivative
L(·) = hp(·), ∇H f (x)i, where p : G → Rm is projection onto the ﬁrst m
coordinates.

Proof. First we remark that h 7→ hp(h), ∇H f (x)i is group linear. Indeed,
the group operation is Euclidean in the ﬁrst m coordinates so:

hp(h1h2), ∇H f (x)i = hp(h1) + p(h2), ∇H f (x)i

= hp(h1), ∇H f (x)i + hp(h2), ∇H f (x)i,

and

hp(δr(h)), ∇H f (x)i = hrp(h), ∇H f (x)i = rhp(h), ∇H f (x)i

for any h1, h2 ∈ G and r > 0.

We may assume x = 0. Fix M and Q as in Lemma 4.5 and let ε > 0.
Since X1f (x), . . . , Xmf (x) exist and directional derivatives act linearly at
x, necessarily Ef (x) exists for every E ∈ V1. Since 0 is a regular point of
f , for each E ∈ V1 we can ﬁnd δ > 0 such that if 0 < |t| < δ and d(u) ≤ 1
then:

|f (δt(u) exp(tE)) − f (δt(u)) − tEf (0)| ≤ ε|t|.

(4.8)

Since J := {E ∈ V1 : ω(E) ≤ 1} is compact, we may additionally choose
δ > 0 so that (4.8) holds uniformly if 0 < |t| < δ, d(u) ≤ 1 and E ∈ J .

20

ANDREA PINAMONTI AND GARETH SPEIGHT

Fix h ∈ G \ {0} with d(h) ≤ δ/Q. Use Lemma 4.5 to choose ti ≥ 0 and

Ei ∈ {±X1, . . . , ±Xm} for 1 ≤ i ≤ M such that

tj ≤ Qd(h)

(4.9)

MXj=1

and

h = exp(t1E1) · · · exp(tM EM ).

(4.10)

Let x1 = 0 and xi+1 = xi exp(tiEi) for 1 ≤ i ≤ M . Notice xM +1 = h

follows from (4.10).

Claim 4.7. For each 1 ≤ i ≤ M :

|f (xi+1) − f (xi) − tiEif (0)| ≤ Qεd(h).

Proof. Fix 1 ≤ i ≤ M and let t = Qd(h). We check that there exist u ∈ G
with d(u) ≤ 1 and E ∈ V1 with ω(E) ≤ 1 such that xi = δt(u) and tiEi = tE.

We begin by solving xi = δt(u). Notice

xi = exp(t1E1) · · · exp(ti−1Ei−1).

Using the deﬁnition of xi, ω(Ej) ≤ 1 and (4.9), we can estimate d(xi) as
follows:

d(xi) ≤

i−1Xj=1

d(xj, xj+1) =

≤

≤ Qd(h),

d(exp(tjEj))

tjω(Ej)

i−1Xj=1
i−1Xj=1

Since t = Qd(h), we can choose u ∈ G with d(u) ≤ 1 such that xi = δt(u).

Since h 6= 0, we have t 6= 0. Let E = (ti/t)E. Since ω(Ei) = 1 and (4.9)

implies ti ≤ Qd(h), we have

ω(E) = ti/t = ti/Qd(h) ≤ 1.

Hence E ∈ V1 solves tE = tiEi with ω(E) ≤ 1 as desired.

Since:

• xi+1 = xi exp(tiEi),
• xi = δt(u) and tiEi = tE,
• t = Qd(h) < δ,

we may apply inequality (4.8) to obtain:

|f (xi+1) − f (xi) − tiEif (0)| ≤ Qεd(h).

This proves the claim.

(cid:3)

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

21

The group operation in the ﬁrst m coordinates is Euclidean, (4.10) states
exp(t1E1) · · · exp(tM EM ) = h, and exp(θE) = θE(0) whenever θ ∈ R and
E ∈ V1. Hence:

(t1E1(0)) · · · (tM EM (0)) = h.

Since p(Xi(0)) is the i’th standard basis vector of Rm in coordinates, we
deduce:

tiEi(0)! = p  mXi=1

hiXi(0)! .

i=1 hiXi are two horizontal vectors whose projections

Since directional derivatives act linearly at 0, we deduce:

p  MXi=1
i=1 tiEi andPm

HencePM

in Rm are equal at 0. Consequently:

We then estimate as follows:

MXi=1

MXi=1

mXi=1
mXi=1
|f (h) − f (0) − hp(h), ∇H f (0)i| =(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)
MXi=1
=(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)
MXi=1
MXi=1

≤

tiEi =

hiXi.

tiEif (0) =

hiXif (0).

(f (xi+1) − f (xi)) −

(f (xi+1) − f (xi)) −

mXi=1
MXi=1

hiXif (0)(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)
tiEif (0)(cid:12)(cid:12)(cid:12)(cid:12)(cid:12)

|f (xi+1) − f (xi) − tiEif (0))|

≤ M Qεd(h).

Hence for d(h) ≤ δ/Q we have:

|f (h) − f (0) − hp(h), ∇H f (0)i| ≤ M Qεd(h).

This proves that f is Pansu diﬀerentiable at x with the desired derivative.
(cid:3)

We can combine Theorem 4.6 with Theorem 3.8 and Proposition 4.3 to

obtain the following application of porous sets.

Corollary 4.8. Let f : G → R be Lipschitz. Then there exists a σ-porous
set P for which the following implication holds at all points x /∈ P : if Xif (x)
exists for every 1 ≤ i ≤ m, then f is Pansu diﬀerentiable at x.

Proof. Use Theorem 3.8 to choose a σ-porous set A, outside which direc-
tional derivatives act linearly. Let B be the set of irregular points of f
deﬁned in Deﬁnition 4.2, which Proposition 4.3 states is σ-porous. Clearly
the set A ∪ B is σ-porous. Suppose Xif (x) exists for all 1 ≤ i ≤ m and

22

ANDREA PINAMONTI AND GARETH SPEIGHT

x /∈ A ∪ B. Then Theorem 4.6 asserts that f is Pansu diﬀerentiable at x,
proving the desired implication.
(cid:3)

We will use existence of directional derivatives and Corollary 4.8 to prove
Pansu’s theorem. To construct many directional derivatives we ﬁrst need
the following well-known fact, for example see [17, Lemma 3.3].

Lemma 4.9. Let Z1, Z2 be two subspaces of G with Z1 ⊕ Z2 = G and
dim(Z1) = 1. Then there are open neighborhoods of the origin Ω1 ⊂ Z1,
Ω2 ⊂ Z2 and an open neighborhood of the identity U ⊂ G such that the map

deﬁned by

is a diﬀeomorphism.

φ : Ω2 × Ω1 → U

φ(a, z) = exp(a) exp(z)

Lemma 4.10. Suppose f : G → R is Lipschitz and E ∈ V1. Then the
directional derivative Ef (x) exists for almost every x ∈ G.

Proof. Let Z1 ⊂ G be the subspace spanned by E and let Z2 be the subspace
of G for which G = Z1 ⊕ Z2. Let Ω1, Ω2, U and φ be given by Lemma 4.9.
Choose δ > 0 so that if |t| < δ then tE ∈ Ω1. Notice that all these quantities
are independent of the map f .

For each ﬁxed a ∈ Ω2, Fa : (−δ, δ) → R deﬁned by Fa(t) = f (φ(a, tE)) is
a composition of Lipschitz functions, hence Lipschitz and therefore diﬀer-
entiable almost everywhere. Note exp((t + h)E) = exp(tE) exp(hE) follows
from (2.3) and [E, E] = 0. Hence for t ∈ (−δ, δ):

|Fa(t + h) − Fa(t)|

h

=

=

f (φ(a, (t + h)E)) − f (φ(a, tE))

h

f (φ(a, tE) exp(hE)) − f (φ(a, tE))

h

.

Using Deﬁnition 2.4 and existence of F ′
we deduce that Ef (φ(a, tE)) exists and is equal to F ′
t ∈ (−δ, δ).

a(t) for almost every t ∈ (−δ, δ),
a(t) for almost every

Using the basis X1, . . . , Xn of G, G is identiﬁed with Rn so equipped with
Lebesgue measure. Viewing φ as a map between subsets of Rn, Fubini’s
theorem implies that Ef (φ(Z)) exists for almost every Z ∈ Ω2 × Ω1. Since
φ is a diﬀeomorphism, it preserves sets of measure zero. Hence Ef (x) exists
for almost every x ∈ φ(Ω2 × Ω1) = U . This holds for every Lipschitz map
f , with the set U independent of f .

For any R > 0, let gR(x) = f (δR(x)). It is easy to show that EgR(x) exists
if and only if Ef (δR(x)) exists, in which case EgR(x) = R(Ef (δR(x))).
Since dilations preserve sets of measure zero, Ef (x) exists if and only if
(x)) exists. Suppose f is a Lipschitz function for which Ef (x) fails
EgR(δ 1
to exist at points x in a set of positive measure. Then we can ﬁnd a compact
set K of positive measure such that Ef (x) does not exist for any x ∈ K.

R

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

23

(K) ⊂ U . Then gR is a Lipschitz function and
Now ﬁx R > 0 such that δ 1
EgR(y) does not exist for points y ∈ δ 1
(K) has positive
measure. This contradicts what we showed above with f replaced by gR.
Hence Ef (x) exists for almost every x ∈ G, for any Lipschitz function f . (cid:3)

(K) ⊂ U and δ 1

R

R

R

We now use Lemma 4.10 and Corollary 4.8 to obtain Pansu’s theorem for

mappings from G to a Euclidean space.

Corollary 4.11 (Pansu’s Theorem). Suppose f : G → RN is Lipschitz.
Then f is Pansu diﬀerentiable almost everywhere.

Proof. First assume N = 1. Using Lemma 4.10, we can ﬁnd a measure
zero set A ⊂ G such that Xif (x) exists for 1 ≤ i ≤ m and x ∈ G \ A.
Using Corollary 4.8, choose a σ-porous set P such that x /∈ P and existence
of Xif (x) for 1 ≤ i ≤ m together imply that f is Pansu diﬀerentiable at
x. Since porous sets have measure zero, the set A ∪ P has measure zero.
The function f is Pansu diﬀerentiable outside A ∪ P , consequently Pansu
diﬀerentiable almost everywhere.

Now assume N > 1 and let f = (f1, . . . , fN ) : G → RN be Lipschitz.
Clearly fi : G → R is Lipschitz for all 1 ≤ i ≤ N , therefore there exists a
null set B ⊂ G so that every component fi is Pansu diﬀerentiable in G \ B.
Let L : G → RN be the group linear map deﬁned by L = (L1, . . . , LN ) where
Li is the Pansu derivative of fi. For every x ∈ G \ B we have:

lim
h→0

|f (xh) − f (x) − L(h)|

d(h)

=(cid:16) NXi=1

lim
h→0

(fi(xh) − fi(x) − Li(h))2

d(h)2

Hence f is Pansu diﬀerentiable almost everywhere.

2 = 0.

(cid:17) 1

(cid:3)

References

[1] Agrachev, A., Barilari, D., Boscain, U.:

Introduction to Rie-
mannian and sub-Riemannian geometry (from hamiltonian viewpoint),
notes available at http://webusers.imj-prg.fr/∼davide.barilari/.

[2] Bellaiche, A.: The tangent space in sub-Riemannian geometry, Jour-

nal of Mathematical Sciences, 83(4) (1994), 461–476.

[3] Bate, D., Speight, G.: Diﬀerentiability, porosity and doubling in
metric measure spaces, Proceedings of the American Mathematical So-
ciety 141 (2013), 971–985.

[4] Bonfiglioli, A., Lanconelli, E., Uguzzoni, F.: Stratiﬁed Lie
groups and potential theory for their sub-laplacians, Springer Mono-
graphs in Mathematics 26, New York, Springer-Verlag (2007).

[5] Citti, C., Manfredini, M., Pinamonti, A., Serra Cassano,

F.: Smooth approximation for intrinsic Lipschitz functions in the
Heisenberg group, Calc. Var. Partial Diﬀerential Equations 49(3–4)
(2014), 1279–1308.

24

ANDREA PINAMONTI AND GARETH SPEIGHT

[6] Citti, C., Manfredini, M., Pinamonti, A., Serra Cassano,

F.: Poincar´e-type inequality for Lipschitz continuous vector ﬁelds, J.
Math. Pures Appl. (9) 105(3) (2016), 265–292.

[7] Sarti, A., Citti, G., Petitot, J.: The symplectic structure of

the primary visual cortex, Biol. Cybernet. 98(1) (2008), 33–48.

[8] Capogna, L., Danielli, D., Pauls, S., Tyson, J.: An introduc-
tion to the Heisenberg group and the sub-Riemannian isoperimetric
problem, Birkhauser, Progress in Mathematics, 259 (2007).

[9] Folland, G.B., Stein, E.: Hardy spaces on homogeneous groups,

Princeton University Press (1982).

[10] Franchi, B., Serapioni, R.:

Intrinsic Lipschitz graphs within
Carnot groups, Journal of Geometric Analysis, DOI: 10.1007/s12220-
015-9615-5.

[11] Franchi, B., Serapioni, R., Serra Cassano, F.: Diﬀerentiabil-
ity of intrinsic Lipschitz functions within Heisenberg groups, J. Geom.
Anal. 21(4) (2011), 1044–1084.

[12] Franchi, B., Serapioni, R., Serra Cassano, F.:

Rectiﬁability
and perimeter in the Heisenberg group, Math. Ann. 321 (2001), 479–
531.

[13] Gromov, M.: Carnot-Caratheodory spaces seen from within, Progress in

Mathematics, 144 (1996), 79–323.

[14] Heinonen, J.: Lectures on analysis on metric spaces, Universitext.

Springer-Verlag, New York (2001).

[15] Lindenstrauss, J., Preiss, D.: On Fr´echet diﬀerentiability of Lip-
schitz maps between Banach spaces, Annals of Mathematics 157 (2003),
257–288.

[16] Lindenstrauss, J., Preiss, D., Tiser, J.: Fr´echet diﬀerentia-
bility of Lipschitz functions and porous sets in Banach spaces, Annals
of Mathematics Studies 179, Princeton University Press (2012).

[17] Magnani, V.: Diﬀerentiability and area formula on stratiﬁed Lie

groups, Houston J. Math. 27(2) (2001), 297–323.

[18] Magnani, V.: Towards diﬀerential calculus in stratiﬁed groups, J. Aust.

Math. Soc. 95(1) (2013), 76–128.

[19] Montgomery, R.: A tour of subriemannian geometries, their geodesics
and applications, American Mathematical Society, Mathematical Sur-
veys and Monographs, 91 (2006).

[20] Pansu, P.: Metriques de Carnot-Carath´eodory et quasiisometries des
espaces symetriques de rang un, Annals of Mathematics 129(1) (1989),
1–60.

[21] Preiss, D., Speight, G.: Diﬀerentiability of Lipschitz functions in
Lebesgue null sets, Inventiones Mathematicae 199(2) (2015), 517–559.
[22] Pinamonti, A., Speight, G.: A measure zero universal diﬀer-
preprint available at

in the Heisenberg

entiability set
arXiv:1505.07986.

group,

POROSITY, DIFFERENTIABILITY AND PANSU’S THEOREM

25

[23] Preiss, D., Zajicek, L.: Directional derivatives of Lipschitz func-

tions, Israel Journal of Mathematics 125 (2001), 1–27.

[24] Semmes, S.: On the nonexistence of bi-Lipschitz parameterizations and
geometric problems about A∞-weights, Revista Matematica Iberoamer-
icana, 12(2) (1996), 337–410.

[25] Serra Cassano, F.: Some topics of geometric measure theory in
Carnot groups, Volume I, EMS Series of Lectures in Mathematics. Eu-
ropean Mathematical Society (EMS), Z¨urich, to appear.

[26] Serra Cassano, F., Vittone, D.: Graphs of bounded variation, ex-
istence and local boundedness of non-parametric minimal surfaces in
the Heisenberg group, Adv. Calc. Var. 7(4) (2014), 409–492.

[27] Vittone, D.: The regularity problem for sub-Riemannian geodesics,
CRM Series, 17, Ed. Norm., Pisa (2014), 193–226. Notes available online
at http://cvgmt.sns.it/paper/2416/.

[28] Zajicek, L.: Porosity and σ-porosity, Real Analysis Exchange 13(2)

(1987/1988), 314–350.

[29] Zajicek, L.: On σ-porous sets in abstract spaces, Abstract and Ap-

plied Analysis 2005(5), 509–534.

(Andrea Pinamonti) University of Bologna, Italy
E-mail address: Andrea.Pinamonti@gmail.com

(Gareth Speight) University of Cincinnati, United States
E-mail address: Gareth.Speight@uc.edu

