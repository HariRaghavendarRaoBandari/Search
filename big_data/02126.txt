6
1
0
2

 
r
a

 

M
0
3

 
 
]

M

I
.

h
p
-
o
r
t
s
a
[
 
 

2
v
6
2
1
2
0

.

3
0
6
1
:
v
i
X
r
a

MNRAS 000, 1–10 (2016)

Preprint 31 March 2016

Compiled using MNRAS LATEX style ﬁle v3.0

An Eﬃcient Feedback Calibration Algorithm for Direct
Imaging Radio Telescopes

Adam P. Beardsley,1(cid:63) Nithyanandan Thyagarajan,1 Judd D. Bowman1
and Miguel F. Morales2
1Arizona State University, School of Earth and Space Exploration, Tempe, AZ 85287, USA
2University of Washington, Department of Physics, Seattle, WA 98195, USA

Accepted XXX. Received YYY; in original form ZZZ

ABSTRACT
We present the E-ﬁeld Parallel Imaging Calibration (EPICal) algorithm, which ad-
dresses the need for a real-time calibration method for direct imaging radio as-
tronomy correlators. Direct imaging involves a spatial fast Fourier transform of an-
tenna voltages, alleviating the harsh O(N 2
a ) computational scaling to a more gentle
O(Na log2 Na), which can save orders of magnitude in computation cost for next gen-
eration arrays consisting of hundreds to thousands of antennas. However, because
signals are mixed in the correlator, gain correction must be applied on the front end.
We develop the EPICal algorithm to form gain solutions in real time without ever
forming visibilities. This method scales as the number of antennas, and produces re-
sults comparable to those from visibilities. Through simulations and application to
Long Wavelength Array data we show this algorithm is a promising solution for next
generation instruments.

Key words:
niques: interferometric

instrumentation: interferometers – techniques: image processing – tech-

1 INTRODUCTION

In order to satisfy the survey speeds required for precision
cosmology as well as searches for fast radio transients, ra-
dio astronomy is undergoing a paradigm shift toward in-
terferometers consisting of hundreds to thousands of small,
wideﬁeld antennas. Many arrays with this design are al-
ready built or under construction including the Hydro-
gen Epoch of Reionization Array1 (HERA), the Murchison
Wideﬁeld Array (MWA; Tingay et al. 2013; Bowman et al.
2013), the Donald C. Backer Precision Array for Probing
the Epoch of Reionization (PAPER; Parsons et al. 2010),
the LOw Frequency ARray (LOFAR; van Haarlem et al.
2013), the Canadian Hydrogen Intensity Mapping Experi-
ment (CHIME,Bandura et al. 2014), the Long Wavelength
Array (LWA, Ellingson et al. 2013), and the low frequency
Square Kilometer Array (SKA1-Low Mellema et al. 2013).
Traditional radio correlators cross-multiply the voltage
signals from all pairs of antennas, and the computation
scales as the number of antennas squared, O(N 2
a ) (Bunton
2004). As the number of elements in future arrays grows, the
computational cost will become prohibitively expensive, and

(cid:63) E-mail: Adam.Beardsley@asu.edu
1 http://reionization.org

c(cid:13) 2016 The Authors

exploring eﬃcient correlator schemes is essential to enable
next generation instruments (Lonsdale et al. 2000). Mean-
while, radio transient monitoring requires access to high
time and frequency resolution data to identify and char-
acterize events such as fast radio bursts (FRBs, Lorimer
et al. 2007), or to follow up gravitational wave candidates
with radio observations (Abbott et al. 2016b; Abbott et al.
2016a). FRBs are highly unexplored at low frequencies (< 1
GHz), but are expected to occur on timescales ∆t ∼ 1–10 ms
(Thornton et al. 2013). Recording the full visibility matrix
for Na (cid:38) 103 arrays at this timescale leads to extremely high
data write rates.

Direct imaging correlators are a new variety of radio
correlator which aim to alleviate both the computational
strain of forming N 2
a correlations and the high data through-
put associated with short timescale science. This is done by
performing a spatial fast Fourier transform (FFT) to image
the antenna voltages, then squaring and averaging in time.
This process scales as O(Ng log2 Ng), where Ng is the num-
ber of grid points in the FFT (Morales 2011; Tegmark &
Zaldarriaga 2009; Tegmark & Zaldarriaga 2010). For certain
classes of telescopes, signiﬁcantly those envisioned for next
generation cosmology experiments, this scaling is a large im-
provement over the N 2
a scaling of traditional methods. Fur-

2

Beardsley et al.

thermore, because images are generated online, the native
output bandwidth will be lowered (assuming Ng < N 2
a ),
and has the potential to be lowered even further with online
transient processing.

A handful of prototype direct imaging correlators have
been tested on arrays including the Basic Element for SKA
Training II (BEST-2) array (Foster et al. 2014), the Omnis-
cope (Zheng et al. 2014), and an earlier pulsar timing exper-
iment at GHz frequencies (Otobe et al. 1994; Daishido et al.
2000). Each of these are examples of so-called FFT correla-
tors – a subclass of direct imaging correlators which rely on
identical antennas with restricted placement, which allows
the FFT to be performed without gridding. We recently re-
leased the E-ﬁeld Parallel Imaging Correlator (EPIC; Thya-
garajan et al. 2015a), which is a software implementation of
the Modular Optimal Frequency Fourier (MOFF; Morales
2011) imaging algorithm. This architecture leverages the
software holography/A-transpose framework to grid electric
ﬁeld data streams before performing the spatial FFT, allow-
ing for an optimal map without placing constraints on array
layout or requiring identical antennas (Morales & Matejek
2009; Bhatnagar, S. et al. 2008; Tegmark 1997b).

A challenge common to all direct imaging algorithms
is calibration of the antenna gains. With a traditional FX
or XF correlator, pair-wise visibilities are written to disk
and used to calibrate oﬄine before further processing such
as imaging. However, a direct imaging correlator mixes the
signals from all antennas before averaging and writing to
disk, making calibration a requirement at the front end,
before imaging and averaging. Previous solutions have in-
volved applying calibration solutions generated from a par-
allel FX correlator (Zheng et al. 2014; Foster et al. 2014),
or integrating a dedicated FX correlator which periodically
formed the full visibility matrix to solve for gains (Wijn-
holds & van der Veen 2009; de Vos et al. 2009). While these
solutions were suﬃcient to enable the exploration of FFT
correlators and beamformers, they will not scale to future
arrays with Na (cid:38) 103.

Here we present the E-ﬁeld Parallel Imaging Calibra-
tion (EPICal) algorithm – a novel solution to the calibration
problem, which can be integrated into direct imaging corre-
lators and scales only as the number of antennas, O(Na).
This method uses a correlation of the uncalibrated antenna
signal stream with an output image pixel from the back-
end of the correlator to solve for the complex gains of the
antennas. Because the calibration must be applied before
gridding and imaging, our solution requires an iterative ap-
proach where the data from one time series is used to update
the gains which are applied to the following time series. An
example implementation of the algorithm is available with
the EPIC software package2.
We review the MOFF algorithm and derive the calibra-
tion algorithm in §2. We then demonstrate the algorithm in
simulations in §3, and apply to a sample LWA data set in
§4. Then we discuss errors and noise properties of the re-
sulting gain solutions in §5. Finally we conclude and discuss
potential extensions to the algorithm in §6.

2 http://github.com/nithyanandan/EPIC

Figure 1. Data ﬂow for the MOFF algorithm, reproduced from
Thyagarajan et al. 2015a. The time ordered electric ﬁelds are
collected by the antenna elements then frequency transformed in
the F-engine. The calibration is applied, then the electric ﬁeld
measurements are gridded using the antenna voltage patterns.
The imager performs a spatial 2D FFT on the gridded data before
squaring and averaging. The accumulated images are then written
to disk.

2 MATHEMATICAL FRAMEWORK

2.1 Review of the MOFF algorithm

We begin by reviewing the data ﬂow of the MOFF algo-
rithm, highlighting aspects relevant to the calibration. The
interested reader is encouraged to refer to Morales 2011 for
a more thorough discussion. Figure 1 is reproduced from
Thyagarajan et al. 2015a to illustrate the various steps of
the algorithm.

The electric ﬁeld incident on the ground, (cid:101)E(r, t), is re-

lated to the sky electric ﬁeld, E(ˆs, t), through a Fourier
transform.

E(ˆs, t)e

−2πir·ˆs d2ˆs

(1)

(cid:90)

(cid:101)E(r, t) =

Here ˆs denotes the sine-projected unit vector for the sky
angle, r is the observer’s location (measured in wavelengths
relative to an arbitrary origin). We will encounter several
quantities which we attempt to estimate. We distinguish the
“true” values with a superscript T , while the estimated quan-
tities are denoted with a prime. We deﬁne the true antenna

signal as a convolution of the antenna voltage pattern, (cid:102)W ,
(cid:101)ET

with the electric ﬁeld on the ground.
a (t) ≡

(cid:90) (cid:102)Wa(r − ra)(cid:101)E(r, t) d2r

(2)

The subscript a labels the antenna, and ra is the location of
antenna a.

(cid:101)ET

The ﬁrst step of the MOFF algorithm is identical to
the F-engine of a traditional FX correlator where the elec-
tric ﬁelds are Fourier transformed to frequency channels,
a (f, t). Even after transforming along the time axis, we re-
tain the time dependence of the signal to represent a stream
of spectra.

Thus far we have assumed the antennas deliver the true
electric ﬁeld signals. Here we introduce a multiplicative com-

MNRAS 000, 1–10 (2016)

I(f)2DFFTSquareImagerF−engineCalibrationGridding2DFFTSquareImagerF−engineCalibrationGriddingANA1A1ANPropagated E−fields  at TMPropagated E−fields  at T1E  (t)1E  (t)NNE  (f)1E  (f)1E  (f)NE  (f)E  (t)1E  (t)N1E  (f)NE  (f)NE  (f)1E  (f)2DFFTSquareImagerF−engineCalibrationGriddingE  (f)gE  (f)gI  (f)1I  (f)MAccumulatorplex gain as well as an additive noise term which corrupt the
measured signals.

(cid:101)Ea(f, t) = gT

a (f, t)(cid:101)ET

a (f, t) +(cid:101)na(f, t)

(3)

Note that this quantity is neither a true or estimated value,
but rather the raw electric ﬁeld signal corrupted by the com-
plex gain before we attempt to estimate the true value. The
noise term is strictly receiver noise – noise introduced by
the instrument. Any sky noise is implicitly included in the
time dependence of the sky electric ﬁeld. We will neglect

(cid:101)na for now, but will inspect its eﬀects at the end of this

section. Each subsequent step treats each frequency channel
independently, so we will drop the f to simplify notation.

The MOFF algorithm next calls for a calibration. The
goal of our new calibration method will be to form an es-
timate of the gains, g(cid:48)
a. For now we will assume we have
formed an estimate to proceed with the MOFF pipeline. We
correct the incoming electric ﬁeld data stream using our cur-
rent estimate of the gains.

(cid:101)E
a(t) = (cid:101)Ea(t)/g

(cid:48)

(cid:48)
a

(4)

The next step is to grid the antenna signals. MOFF
uses the antenna patterns as the gridding kernel according
to the software holography/A-transpose technique (Morales
& Matejek 2009; Bhatnagar, S. et al. 2008). This achieves
both an optimal map (Tegmark 1997a) and places the data
on a regular grid. Unlike traditional correlators which grid
visibilities, the MOFF grids the electric ﬁelds directly. This
operation must be performed for every time step, before any
averaging of the data.

After gridding, the imaging portion of the MOFF per-
forms a 2D spatial FFT to form instantaneous electric ﬁeld
images of the sky. The pipeline up to this point can be sum-
marized through the following equation.

(cid:88)
(cid:123)(cid:122)

i

2D FFT

e2πiri·ˆsi

(cid:88)
(cid:124)

a

(cid:125)

(cid:102)Wa(ri − ra)
(cid:123)(cid:122)
(cid:125)

Gridding

(cid:101)ET
(cid:123)(cid:122)

gT
a
g(cid:48)

a

(cid:124)

Calibration

(cid:125)

a (t)

(5)

(cid:48)

E

(ˆsi, t) =

1
Na

(cid:124)

The sum over antennas uses the voltage pattern to grid the
calibrated electric ﬁelds onto regular gridpoint, i. The sum
over i denotes the 2D FFT to sky coordinates, resulting in an
estimate for the instantaneous electric ﬁeld image. We can
simplify this expression by exchanging the sums to transform
the beam term into sky coordinates.

(cid:48)

E

(ˆsi, t) =

=

1
Na

(cid:88)
×(cid:88)
(cid:88)

a

i

1
Na

gT
a
g(cid:48)

a

a

a

gT
a
g(cid:48)

a (t)e2πiˆsi·ra

(cid:101)ET
(cid:102)Wb(ri − ra)e2πiˆsi·(ri−ra)
(cid:101)ET

a (t)e2πiˆsi·ra Wa(ˆsi)

(6)

In this form we see that the eﬀect of gridding with the an-
tenna voltage pattern is to attenuate the image by a factor
of the antenna sky response, Wa(ˆsi).

Finally, the images are squared and averaged in time to
reduce output bandwidth, then written to disk. While op-
erations have been reordered, the resulting image is equiv-
alent to one produced by gridding and imaging visibilities.
By shifting from cross-correlation of all pairs of antennas to

MNRAS 000, 1–10 (2016)

EPICal

3

a spatial FFT, the computational cost is signiﬁcantly low-
ered for certain classes of compact arrays. The output band-
width is also greatly reduced as visibilities are exchanged
for gridded images. A full exploration of these scalings was
presented in Thyagarajan et al. 2015a.

2.2 Derivation of calibration

We saw above that the MOFF algorithm (in general any di-
rect imaging architecture) mixes the signal from all antennas
coherently, and thus requires the calibration to be applied
in real time at the front end of the correlator. Furthermore,
visibilities are never formed, which are traditionally the ba-
sic measurement used to form calibration solutions. Here we
derive an alternative method to estimate the antenna gains
in real time, using the data products of the MOFF.

Because the gains must be estimated in real time, we
will need to use a ﬁnite stream of data to form and es-
timate which will be applied to the subsequent stream of
data. Therefore the process of ﬁnding a solution is an iter-
ative one. We will use parenthetical superscripts to denote
the calibration loop number. For example, we will assume
we have already formed an estimate from n loops, g(n)
a . We
will use these estimates to calibrate the next stream of data
in order to form an updated estimate, g(n+1)

.

a

As a starting point, we consider the feedback calibration
outlined in Morales 2011. There it was suggested to form a
correlation of the uncalibrated antenna measurements with
an image pixel from the output of the correlator. This is a
statistically stationary quantity, which can be related to the
sum of visibilities involving the antenna used in the correla-
tion – exactly the sum needed to calibrate a simple sky of a
single point source. However, we aim for a more generalized
solution for arbitrarily complex sky models. We therefore
study the full expression for the antenna-pixel correlation,
C(n)

≡(cid:68)(cid:101)Ea(t)E

(ˆs0, t)

(cid:69)

(7)

(cid:48)∗

,

a,ˆs0

t

where the superscript n again represents the quantity formed
in the nth calibration loop, and ˆs0 is the pixel center nearest
a bright calibrator of interest. The following will hold for any
chosen pixel, ˆs0, though it is advantageous to choose a pixel
which contains a bright source to achieve a high signal to
noise.

Plugging equation 6 into equation 7, we ﬁnd,

gT

a (t)

(cid:42)

a (cid:101)ET
(cid:88)
(cid:88)

b

b

gT
a
Na

gT
a
Na

1
Na
gT∗
b
∗(n)
g
b
gT∗
b
∗(n)
g
b

C(n)

a,ˆs0

=

=

=

(cid:88)

(cid:101)ET∗

gT∗
b
∗(n)
g
b

(cid:69)

∗T
b

b (t)e

−2πiˆs0·rb

(cid:68)(cid:101)ET
a (cid:101)E
−2πiˆs0·rb(cid:101)V T

ab

b
∗
b (ˆs0)e

W

∗
b (ˆs0)e

W

t

t

(8)

(cid:43)

−2πiˆs0·rb W

∗
b (ˆs0)

where in the second step we group time-dependent terms,
and in the third we deﬁne the true visibilities as the corre-
lation between true antenna electric ﬁeld measurements. It
is easy to see from here that the net eﬀect of including the

receiver noise term, (cid:101)na(f, t), will result in added noise on

the true visibilities, including a bias on the auto-correlation
terms. In principle a bias can result on any visibility from
any noise correlations between antennas, but the implemen-
tation included in the EPIC software package restricts the

An important feature to note is that, like the MOFF-
generated images themselves, equation 9 includes the an-
tenna auto-correlations (the sum is over all b, not excluding
a). It can be diﬃcult to perfectly model the noise bias from
auto-correlations, which can often times be far brighter than
the visibilities themselves. It can therefore be beneﬁcial to
subtract this term directly from C(n)
, and exclude the b = a
term in the sum.
C(n)
−

−2πiˆs0·ra(cid:68)|(cid:101)Ea|2(cid:69)

→ C(n)

∗
a (ˆs0)e

(11)

a,ˆs0

W

a,ˆs0

a,ˆs0

1
∗(n)
Na g
a

t

We have absorbed gT
a into the electric ﬁeld so that the corre-
lation is now simply the autocorrelation of the uncalibrated
antenna measurement. This requires generating these corre-
lations, which again only scale as O(Na), and are generally
useful for array diagnostics.

We conclude this section by connecting our calibration
expression to that found in a visibility framework. In the
limit of a single bright calibrating source at phase center, we
can greatly simplify equations 8 and 9. We will assume the
beams are normalized such that W (0) = 1. We can further
drop the exponential phase terms because ˆs0 = 0. We then
absorb the true gains into the true visibilities in equation 8
to express as a sum of measured, uncalibrated, visibilities.
a,0 → 1
C(n)
Na

(cid:88)

(cid:101)Vab

(12)

1
∗(n)
g
b

b

We next plug this expression into equation 9 to ﬁnd
our simpliﬁed calibration solution for a single bright point
source. Because our sky is a single bright point source, the
model visibilities are simply the ﬂux of the source, Ssrc.

(9)

(cid:48)(n+1)
g
a

→

(cid:80)
b(cid:101)Vab/g

∗(n)
b
NaSsrc

4

Beardsley et al.

Figure 2. The general data ﬂow of the MOFF correlator, with
a feedback calibration loop. A pixel from the (unsquared) image
is tapped out and correlated against the input antenna electric
ﬁeld signals to form C(n)
coeﬃcients (equation 7). These coef-
a,ˆs0
ﬁcients are then shipped oﬀ-chip to apply equations 9 and 10,
and any other processing to arrive at an updated estimate of the
gains, g(n)
a . The gray box shows operations which must be done
at high speed (before averaging in time), which white boxes show
operations which can be performed “oﬀ-chip”.

noise term to include only the auto-correlation noise bias,
and assumes baseline dependent noise has zero mean.

The next step is to use this antenna-pixel correlation
to update our gain solution. We will model the right hand
side of equation 8 by assuming our current gain estimates
are approximately correct, g(n)
b , and replacing the true
ab. These model
visibilities rely an knowledge of the sky, and should be pre-
computed oﬄine. We can then solve equation 8 for gT
a to
achieve an updated estimate.

visibilities with a set of model visibilities, (cid:101)V (cid:48)
(cid:35)−1

b ≈ gT

(cid:34)(cid:88)

(cid:48)(n+1)
g
a

= C(n)

a,ˆs0

Na

∗
b (ˆs0)e

W

−2πiˆs0·rb(cid:101)V

(cid:48)
ab

b

a,ˆs0

This equation is our prescription for estimating the antenna
gains of a direct imaging array. The online computation com-
plexity scales as O(Na) as we form a C(n)
for each antenna.
We show schematically the process of calibrating a di-
rect imaging correlator in ﬁgure 2. Computationally expen-
sive steps that must be performed “on-chip” are shown inside
the gray box. The uncalibrated antenna signals are tapped
out after the F-engine and correlated against the output
image pixel of interest (i.e., equation 7 is “on-chip”). The
correlated values are then passed oﬀ-chip to estimate the
gains using equation 9, and additional ﬁtting if desired. The
gains are then passed back to the correlator to update the
calibration for subsequent integration intervals.

While testing we found equation 9 resulted in oscilla-
tory gain solutions as it was iterated, as is often the case in
iterative minimization methods. To mitigate this we intro-
duce a damping factor, 0 ≤ γ < 1, which is used to attenuate
the gain update, eﬀectively giving the solutions memory of
previous iterations.
= (1 − γ)g

+ γg(n)

(10)

(cid:48)(n+1)
a

g(n+1)
a

a

We found that while equation 9 does indeed converge on
good solutions, the process is made faster by tuning the
(cid:48)(n+1)
damping factor. While g
is the best estimate of the
a
gains after the nth iteration, the damped version, g(n+1)
,
is actually used in the iterative calibration loop. Once the
loop converges the damped version is essentially a weighted
average over the past several iterations, giving it a longer
eﬀective integration time.

a

(13)

This is simply a gain-weighted sum of the measured visi-
bilities over the ﬂux of the source, which is indeed the lim-
iting result from a visibility approach, for example seen in
Mitchell et al. 2008. The ability to recover the equivalent
expression despite not actually forming the visibilities is a
result of the fact that only sums over visibilities come into
the FX solution, as was described in Morales 2011. We have
conﬁrmed the limiting case equivalence here, and will ex-
plore the more general case in more detail in § 5.

3 SIMULATION

We ﬁrst demonstrate our calibration method through a con-
trolled simulation. A complex gain is created for each an-
tenna with random phase and amplitude, which is used to
corrupt the simulated data stream, then we attempt to re-
cover the gains using our calibration routine. The simulation
software used is included in the EPIC package.
Our simulated signal consists of 10 random point
sources with ﬂux densities 0.5 Jy (cid:46) S (cid:46) 1 Jy. For an an-
tenna array we use the inner 51 antennas of the MWA layout
(Beardsley et al. 2012), within a bounding box of 150 m. The
antenna voltage pattern used is a 4.4 m square tophat on the
ground. Because our algorithm treats frequency channels in-
dependently, we simulate only one channel. For context we
treat this channel as a single 40 kHz, meaning each subse-
quent timestep is separated by 25 µs.

MNRAS 000, 1–10 (2016)

F-engineApply CalGrid and imageSquare and averageWrite to diskAnt-pixel correlationEstimate gainsEa(t)Ea(f)E'a(f)E'(, f)a(n)ga(n)I'(, f)EPICal

5

Figure 3. Phase error of gain estimates as a function of iteration
for simulated calibration. The gains were initialized with random
phases, but the calibration loop was able to recover the correct
phases after about 15 iterations. Each line represents an antenna
in our 51 MWA antenna sample.

Figure 4. Gain estimate amplitudes as a function of iteration for
simulated calibration. Again, each line represents an antenna in
the 51 MWA antenna sample. The gain estimates were initialized
randomly, while the true values were unity. After about 15 iter-
ations we see the calibration loop has settled around the correct
values, with only noise remaining.

For our unknown gains, we create a set of random com-
plex numbers where the amplitude is drawn from approxi-
mately gaussian distribution centered around 1 with width
0.25, and completely random phase. These are our “true
gains”, and we apply them to the frequency-domain sim-
ulated antenna electric ﬁelds as in equation 3. Our anal-
ysis is blind to these values until the end of the process to
check accuracy. The gain estimates are initialized with unity,
g(0)
a = 1.
We next process and image 400 time steps (10 ms).
We also form the correlations, C(0)
, used in our calibra-
tion loop. The pixel used for the correlation is the source
with the largest apparent ﬂux (intrinsic ﬂux attenuated by
the primary beam). These correlation values are used to up-
date the gain estimates, which in turn are used to calibrate
the following 400 time steps. Through experimentation we
found a damping factor of γ = 0.35 resulted in the quickest
convergence in this simulation.

a,ˆs0

The calibration loop continues by updating the gain es-
timates every 400 time steps. The phases of our gain esti-
mates are shown in ﬁgure 3 for 20 such iterations. The phase
error plotted is the phase relative to the true gain for each
antenna (various colored lines). One antenna was used as a
reference to ﬁx the absolute phase, so has zero phase error.
The other 50 antennas are shown to have error spanning 2π
initially, and after about 10 iterations lock into a solution,
settling down to noise levels around iteration 15 (0.15 s).
We stop the simulation when the updated gains trace the
thermal noise of the simulated sources, which can be seen
by the coherence of the 50 antenna gains after iteration 15.
The estimated gain amplitudes for the simulations are
shown in ﬁgure 4. The quantity plotted is the magnitude
of the estimated gains over the true gains,
places all antennas on the same scale. We can see the am-
plitudes converge toward their true values around the same
time as the phases (iteration ∼15). At the beginning of cali-

(cid:12)(cid:12)(cid:12), which

(cid:12)(cid:12)(cid:12)g(n)

a /gT
a

MNRAS 000, 1–10 (2016)

bration we can see the value of the damping factor. At n = 0,
a couple of gains are shown to have abnormally high ampli-
tude estimates, notably one about 3.3 times its true value
(red line). These unbalanced high estimates caused the en-
tire set of gains to be under estimated at n = 1, even with
a damping factor of 0.35. By n = 5 the unbalanced ampli-
tudes have been damped out and the calibration continues.
Without the damping factor, the oscillation seen in the ﬁrst
couple iterations would have been signiﬁcantly larger and
taken much longer to fade out.

After the gains have converged, we see both the phases
and amplitudes to continue to ﬂuctuate coherently. This is
due to the stochastic ﬂuctuations of the simulated sources
themselves, and is limited by the sky noise. For this simu-
lation we restricted each calibration iteration to only 10 ms
integration time. In principle a calibration implementation
could use short integration times to allow the gains to con-
verge, then increase the integration time to reduce this noise.
Images created at the beginning of calibration and at
the end are shown in ﬁgure 5. Each image is obtained over
10 ms integration, corresponding to all snapshot images cre-
ated with a given set of gain estimates. The top panel shows
the image produced with our initialized unity gains. Because
the phases are completely random, the image is essentially
noise with the primary beam evident. After 20 iterations, the
image is far more clear, shown in the bottom panel. Each of
the ten simulated sources are clearly visible, indicated with
red circles.

4 APPLICATION TO LWA DATA

We next demonstrate our calibration algorithm using an ob-
servation from the LWA station in New Mexico. The data
is from the LWA narrow-band transient buﬀer (TBN), with
time ordered voltage data from 255 antennas within a core

05101520Calibration Iteration−3−2−101233hase error (rad)05101520CalibratiRn IteratiRn0.00.51.01.52.02.53.03.55elative amplitude6

Beardsley et al.

Figure 5. Images formed during simulated calibration. Top: An
image generated from a single frequency channel and 10 ms inte-
gration after the gain estimates are randomized. As expected with
random phases, the image is completely noisy, with the shape of
the primary beam evident. Bottom: An image formed after cali-
bration, again with a single frequency channel and 10 ms integra-
tion. The ten simulated (and modeled) point sources are easily
visible, and highlighted with red circles.

radius of 100 m. The central frequency is 74.03 MHz, with a
bandwidth of 100 kHz and writeout timescale of 5.12 ms (fre-
quency channel resolution of 195.3125 Hz). For this demon-
stration we limit ourselves to a single polarization.

After correcting for geometric cable delays, the instru-
ment is naturally well calibrated, as was seen in the demon-
stration of the EPIC imager in Thyagarajan et al. 2015a.

However, we will aim to further improve on this calibration
using our algorithm.

We proceed by forming model visibilities. We model
only two bright objects as point sources: Cyg A with ﬂux
16611.68 Jy (Cohen et al. 2007); and Cas A with ﬂux 17693.9
Jy (Kassim et al. 2007). Because the raw data is attenuated
by the primary beam of the instrument, we also account for
this in our model using beam values consistent with Hicks
et al. (2012).

We made several choices while studying the behavior
of the LWA data to improve our calibration. Through our
previous imaging work, we noted that the ﬂux scale of un-
calibrated images was consistent with average gain ampli-
tudes of 0.25. To allow the calibration to converge quickly
we initialized our gain estimates at this level. We also found
a boost in signal to noise is achieved easily by averaging
frequency channels and assuming the gains are constant
within a sub-band. Here we average solutions across 150
channels, or about 29 kHz. With a fractional bandwidth
B/f0 = 3.9 × 10−4 (cid:28) 1, we assume a smooth bandpass
across the band. A damping factor of γ = 0.7 was adopted.
Finally, we found that seven antennas3 produced unsta-
ble gain solutions, and in fact corrupted the entire array. We
therefore ﬂagged these antennas in our analysis, resulting in
a total of 248 antennas to calibrate. In each calibration loop,
we form Ci,ˆs0 , i = 1, 2, . . . Na and update our gain estimates
over 10 timestamps (51.2 ms). We iterate the loop 30 times
for a total of 1.536 seconds. The results of this calibration
experiment are shown in ﬁgures 6 – 8.

Figure 6 shows the phase of our gain estimates over
30 calibration iterations, again with each colored line repre-
senting a diﬀerent antenna. Given the quality of uncalibrated
image demonstrated in Thyagarajan et al. (2015a), it is a bit
surprising to see the phase variation in our solutions. How-
ever, the phases are relatively ﬂat after about 15 iterations
(modulo noise), and exhibit a central “trunk” where the ma-
jority of phases are congregated. This behavior is suggestive
that while the uncalibrated voltages were able to produce a
viable image, the minor changes from our solutions will focus
the image and improve the quality. The actual location of
the “trunk” (slightly negative) is simply determined by the
reference antenna chosen to have identically zero phase, but
happens to be slightly more positive than the bulk of anten-
nas. For plotting clarity, we unwrapped phases resulting in
phases that appear to exceed ±π.

The gain amplitudes as a function of calibration itera-
tion are shown in ﬁgure 7. There is a fairly wide range in
gain amplitudes (from 0.12 to 0.59). However, this is not
surprising due to the non-uniformity in the cables from the
antennas to the receivers. Again, the amplitudes are noisy
but relatively ﬂat.

Figure 8 shows the improvement in the images due to
our calibration. The left panel shows the uncalibrated image
integrated over 51.2 ms, 29 kHz. Cyg A is prominent near
the center of the image, and Cas A is also clearly visible in
the upper right. The middle panel shows the image produced
after calibration with identical integration time and band-
width. The sidelobes throughout the image are signiﬁcantly

3 LWA antenna IDs 48, 85, 124, 148, 203, 217, and 244 were
ﬂagged.

MNRAS 000, 1–10 (2016)

−0.3−0.2−0.10.00.10.20.3l−0.3−0.2−0.10.00.10.20.3mBefore Calibration−0.3−0.2−0.10.00.10.20.3l−0.3−0.2−0.10.00.10.20.3mAfter CalibrationEPICal

7

pute the dynamic range, deﬁned as the peak of the image
over the noise level. We estimate the noise level as the me-
dian of the absolute deviation of the image, a robust statis-
tic. With this metric we ﬁnd the calibrated image to have
a 55% dynamic range improvement over the uncalibrated
image.

5 NOISE TRENDS AND ERROR ANALYSIS

Now we return to simulations to study the eﬀect of noise
in our system, and the consequences of an incomplete sky
model. We run a suite of simulations varying the receiver
noise and integration times, while forming antenna-pixel cor-
relations, C(n)
, for EPICal gain solutions, and simultane-
ously forming visibilities from the same E-ﬁeld streams to
ﬁnd visibility-based gain solutions for comparison.

a,ˆs0

We use a simulated sky consisting of a 5 Jy calibrator
source, and 49 other random sources with apparent ﬂux den-
sities 0.2 to 0.5 Jy (total sky power ≈ 23 Jy). We generated
these sources randomly, but kept them ﬁxed for each run. As
in section 3, we use the MWA core layout (51 antennas), and
a 4.4 m square tophat antenna voltage pattern. We simulate
64 frequency channels each of width 40 kHz. Because our cal-
ibration loop treats frequency channels independently, each
channel can be treated as a separate trial of the simulation,
and is used to better estimate the statistics.

To simulate receiver noise, we add a gaussian dis-
tributed complex random number to each antenna electric
ﬁeld measurement at each time stamp according to equa-

tion 3. The level of the receiver noise, σr =(cid:10)|(cid:101)na(f, t)|2(cid:11), is

varied in diﬀerent simulation runs. We include two limiting
cases, where the receiver noise power is subdominant to the
sky power (σr = 10.0 Jy), and where the receiver dominates
the noise (σr = 100.0 Jy).

For each simulation run we ﬁnd gain solutions using

four methods:

i. EPICal, using a full sky model
ii. EPICal, using a single point source model
iii. Visibility-based, using a full sky model
iv. Visibility-based, using a single point source model.

visibilities, (cid:101)V (cid:48)

In the cases where we use the full sky model, the model
ab used in the calibration loop are created using
all point sources in the simulated sky. For the single point
source model, we only allow the calibration loop to be privy
to the bright calibrator source. While we vary the model
used for calibration, the simulated “true sky” remains ﬁxed
with all 50 point sources.

a = gT

For the EPICal calibration loops, we initialize our gain
estimates with the true values (g(0)
a = 1), and allow the
estimate to be corrupted by the noise through ten iterations
of the calibration loop. We adopt a damping factor γ = 0.35.
Because EPICal updates the gain estimate at each calibra-
tion loop, tcal, but retains a memory of previous iterations
through the damping factor, the total integration time is not
straightforward. We deﬁne an eﬀective integration time by
considering the relative weights of each previous C(n)
con-
tributing to the current g(n)
estimate, each with integration
time tcal. In the limit n → ∞, the geometric series converges

a,ˆs0

a

Figure 6. Gain phase solutions as a function of calibration iter-
ation for an LWA TBN observation. The gain estimates are ini-
tialized with zero phase, but quickly span a 2π range, and settle
into relatively ﬂat, albeit noisy, solutions. The majority of phases
congregate near zero, which is not surprising given the fairly good
quality image produced from uncalibrated data.

Figure 7. Gain amplitudes as a function of calibration iteration
for an LWA TBN observation. The gains estimates were initialized
with amplitude 0.25 after inspection of the electric ﬁeld values
compared to our model sky. The solutions are noisy, but ﬂat.
The range in amplitudes is due to the non-uniformity of cables
between the LWA antennas and receivers.

suppressed, and the galactic plane is much more evident,
despite only modeling Cyg A and Cas A. We also note that
the feature just to the right of Cyg A is dimmer in the cal-
ibrated image, better matching the expected ﬂux from the
global sky model (GSM, de Oliveira-Costa et al. 2008). We
show the GSM (Price 2016) modulated by two factors of
the LWA power pattern in the right panel of ﬁgure 8 for
reference.

To compare the image qualities quantitatively we com-

MNRAS 000, 1–10 (2016)

8

Beardsley et al.

Figure 8. Images produced before (left) and after (middle) calibrating LWA data. These images were produces with 29 kHz bandwidth
and 51.2 ms integration. The calibrated image shows signiﬁcant reduction in sidelobe rumble throughout, while retaining the prominent
Cyg A and Cas A sources. The galactic plane is also substantially more evident after calibration. For reference, the GSM is shown in
the same coordinates and weighted by two factors of the LWA primary beam in the right panel. While much of the GSM is visible in the
calibrated image, we note that the model used to calibrate was only the two bright sources, Cyg A and Cas A.

.

to an eﬀective integration time of
teﬀ = tcal × 1 + γ
1 − γ
(14)
With the damping factor we adopted here, teﬀ ≈ 2.1 × tcal.
We simultaneously form simulated visibilities by corre-
lating all pairs of antenna E-ﬁeld measurements (including
the receiver noise). The E-ﬁelds are correlated for a duration
equal to the eﬀective integration time of the EPICal loop for
comparison. We then ﬁnd the visibility-based gain estimates
by minimizing

(cid:88)

(cid:88)

b(cid:54)=a

a

(cid:12)(cid:12)(cid:12)(cid:101)Vab − gag
b(cid:101)V

∗

(cid:48)
ab

(cid:12)(cid:12)(cid:12)2

χ2 =

,

(15)

using both versions of the model visibilities described above.
For each version of calibration, we observe the error in
the gain estimates averaging over both antennas and fre-
quency channels.

 1

(cid:88)

(cid:88)

(cid:12)(cid:12)g(cid:48)

a (f )(cid:12)(cid:12)2

1/2

a(f ) − gT
|gT
a (f )|2

σg =

Nf Na

f

a

(16)

The results of our simulations are shown in ﬁgure 9.
The gain errors from our EPICal method is shown with
solid lines, while the dashed lines represent the visibility-
based calibration. The thick lines represent the results of
using a full sky model, and the thin lines are from the sin-
gle point source model. In the case of the full sky model, we
see the errors trend downward with longer integration times,
as expected. The EPICal errors are slightly higher than the
visibility-based errors, on average about 23% diﬀerence. This
is not surprising as EPICal only uses the information in a
single pixel, while the visibilities use all information from
the full sky model. However, we see that with this perfect
model the errors do behave like noise, and the same level
of noise can be achieved with a longer integration time (or
larger damping factor).

The exact ratio of EPICal gain noise to visibility-based
gain noise depends on the fraction of the total sky power
contained in our calibrator source. In the example here, our

Figure 9. Gain estimate errors as a function of integration time,
receiver noise (line color), and calibration method. The solid lines
represent the error on the EPICal derived gain estimates, while
the dashed lines represent the error on the visibility based esti-
mates. The thicker lines were derived using a full sky model in the
calibration loops, and the thinner lines used only a single point
source model. In the full sky model case we see all methods trend
down with longer integration time as expected. For a given in-
tegration time, EPICal derived errors are on average 23% higher
than those of visibility based calibration. In the case of a single
source model, the errors bottom out due to the ﬂux in the mea-
surements that is not modeled. In this regime the EPICal method
performs slightly better than the visibility-based method due to
eﬀectively beamforming to the sky pixel where the incomplete
model is most accurate. On average EPICal errors are 5% lower
in this regime.

calibrator accounted for 22% of the total sky power. We re-
peated the experiment in the regime where the calibrator
dominated the sky and found that the diﬀerence in EPICal
and visibility-based error goes to zero, as expected. For a
typical HERA observation, the sky temperature is expected

MNRAS 000, 1–10 (2016)

to by about 180 K (Jacobs et al. 2015), and a bright calibra-
tor source could be about 10% of this power. In this regime
we found that EPICal gain noise was about 60% higher than
visibility-based gain noise for the same eﬀective integration
time.

When using the single point source model, all calibra-
tion methods in ﬁgure 9 trend downward until they reach
an error ﬂoor due to the confusion sources that were not
modeled. The EPICal and visibility-based solutions reach a
similar ﬂoor, but EPICal achieves a marginally lower level
(on average 5% lower). This can be attributed to the same
reason EPICal underperformed with the full sky model: EPI-
Cal only used a single pixel in the sky to form its solutions.
When using the full sky model, it was down weighting the
information in the rest of the sky. But when the sky model
only contains the bright point source, the single pixel used
in EPICal is the location where this model is most accu-
rate, eﬀectively down weighting the pixels with incomplete
sky model. In the regime typical of HERA discussed above,
EPICal’s error ﬂoor was 10% lower than that of visibility-
based solutions.

Any realistic sky model will lie somewhere between the
two extremes explored here. In the case where the sky is
modeled by a single source, as is often the case for an ini-
tial calibration, EPICal actually achieves smaller gain errors
compared to the traditional visibility-based calibration. As
the sky model improves, both visibility-based and EPICal
gains improve, though the former quicker than the latter. In
the limit of a perfect model, both calibration methods pro-
duce noise-like errors in their gains which scale down with
more integration time.

6 DISCUSSION

Through simulations and application to real data, we have
shown that the EPICal algorithm is a viable solution for cal-
ibrating direct imaging arrays in real time. The computation
necessary only scales with the number of antenna elements,
making it a sub-dominant cost factor when designing the
correlator. This strategy will enable fast read-out for arrays
with many thousands of antennas, which will be necessary
for future radio transient and cosmology experiments.

EPICal can be further improved through several exten-
sions. Here we name a few potential considerations for fur-
ther study. These topics can be thought of as extensions to
the white “estimate gains” box in ﬁgure 2, which can be per-
formed at a much lower cadence than the actual correlations.
Multiple pixel correlations. As was seen in section 5,
the single pixel correlation demonstrated in this paper can
underperform in the presence of a complex sky, when com-
pared to visibility-based gains with perfect knowledge of the
sky. These errors can be mitigated by using correlations of
multiple image pixels to incorporate a higher fraction of the
total sky power into the calibration loop. Of course this in-
creases the computational cost to a scaling of O(NaNpix),
which will typically be much lower than the O(Ng log2 Ng)
of the correlator itself. These additional correlations would
also enable direction dependent gain solutions. Each corre-
lation could be used to independently solve for gains in each
pixel direction, then ﬁt to a beam model on the sky. This up-
dated beam pattern would then feed into the gridding step

MNRAS 000, 1–10 (2016)

EPICal

9

of the correlator, allowing the imager to convolve the signals
with the eﬀective beam pattern in the ground plane.

Fitting gain models. With some knowledge of the in-
strumental bandpass, the noise of the gain solutions can be
greatly reduced by ﬁtting a model to the per-frequency so-
lutions derived here. We used this method at a rudimentary
level in our demonstration to LWA data by assuming the
gains were constant over a narrow bandwidth. One could
easily improve on this by extending the bandwidth and ﬁt-
ting for a low order polynomial in phase and amplitude. Ad-
ditionally, with knowledge of the poly-phase ﬁlters applied
to the data stream, we could include channels closer to the
edge of the band.

Improving sky model. In this work we used a perfect
sky model (for simulation), or a very simple sky model (for
LWA data). In principle the images produced by the EPIC
correlator can be used to improve the sky model used in cal-
ibration – similar to a major loop in self-calibration. This
can be especially useful for compact, wideﬁeld arrays which
require a model of both compact and diﬀuse sources over a
large patch of sky. In addition to requiring the sky model,
the calibration also requires this model to be attenuated by
the primary beam, which can be diﬃcult to measure at the
precision necessary (e.g. Neben et al. 2015; Virone et al.
2014; Thyagarajan et al. 2015b). However, the direct imag-
ing correlator provides exactly the model necessary in real
time, and can be iterated over to improve the images and
gain solutions.

Dynamic parameters. In our controlled experiments
we ﬁne-tuned a number of parameters based on our test-
ing (e.g. damping factor, integration time, frequency aver-
aging). A deployed system will require robust determination
of these parameters to operate continuously. The speciﬁcs
will be heavily dependent on the stability of the instrument,
the frequency of observation, and the sky. For example, a
stable instrument may be able to use short integrations to
determine a rough estimate of the gains before switching to
much longer integration (on order seconds to minutes) to
highly increase signal to noise. At low frequencies or high
imaging resolution, the dynamics of the ionosphere are im-
portant, and will likely drive the limit of time integration
allowed.

The work here will serve as a foundation for further
development. We have shown that the EPICal algorithm
produces reliable calibration solutions, and have identiﬁed
several aspects to increase the scope. With next generation
instruments in the planning and development stages, EPI-
Cal is poised to greatly contribute to their success. The soft-
ware is integrated into the EPIC package and freely available
to use in simulations or oﬄine processing of data. Work is
underway to port the code to real-time GPU systems for
deployment.

ACKNOWLEDGEMENTS

This work has been supported by the National Science Foun-
dation through award AST-1206552. We thank Danny Ja-
cobs for his valuable inputs, and Greg Taylor for provid-
ing us with LWA data. Construction of the LWA has been
supported by the Oﬃce of Naval Research under Contract
N00014-07-C-0147. Support for operations and continuing

10

Beardsley et al.

development of the LWA1 is provided by the National Sci-
ence Foundation under grant AST-1139974 of the University
Radio Observatory program.

This paper has been typeset from a TEX/LATEX ﬁle prepared by
the author.

REFERENCES

Abbott B. P., et al., 2016a, preprint, (arXiv:1602.08492)
Abbott B. P., et al., 2016b, Phys. Rev. Lett., 116, 061102
Bandura K., et al., 2014,

In-
strumentation Engineers (SPIE) Conference Series. p. 22
(arXiv:1406.2288), doi:10.1117/12.2054950

in Society of Photo-Optical

Beardsley A. P., et al., 2012, MNRAS, 425, 1781
Bhatnagar, S. Cornwell, T. J. Golap, K. Uson, J. M. 2008, A&A,

487, 419

Bowman J. D., et al., 2013, Publ. Astron. Soc. Australia, 30, 31
Bunton J. D., 2004, Experimental Astronomy, 17, 251
Cohen A. S., Lane W. M., Cotton W. D., Kassim N. E., Lazio
T. J. W., Perley R. A., Condon J. J., Erickson W. C., 2007,
AJ, 134, 1245

Daishido T., et al., 2000, Proc. SPIE, 4015, 73
Ellingson S. W., et al., 2013, IEEE Transactions on Antennas and

Propagation, 61, 2540

Foster G., Hickish J., Magro A., Price D., Zarb Adami K., 2014,
Monthly Notices of the Royal Astronomical Society, 439, 3180
Hicks B. C., et al., 2012, Publications of the Astronomical Society

of the Paciﬁc, 124, pp. 1090

Jacobs D. C., Beardsley A. P., Hazelton B. J., Thyagarajan N.,
Trott C., 2015, HERA Memo 10, System Temperatures of
21cm Arrays

Kassim N. E., et al., 2007, ApJS, 172, 686
Lonsdale C. J., Doeleman S. S., Cappallo R. J., Hewitt J. N.,
Whitney A. R., 2000, in Butcher H. R., ed., Society of Photo-
Optical Instrumentation Engineers (SPIE) Conference Series
Vol. 4015, Radio Telescopes. pp 126–134

Lorimer D. R., Bailes M., McLaughlin M. A., Narkevic D. J.,

Crawford F., 2007, Science, 318, 777

Mellema G., et al., 2013, Experimental Astronomy, 36, 235
Mitchell D., Greenhill L., Wayth R., Sault R., Lonsdale C., Cap-
pallo R., Morales M., Ord S., 2008, Selected Topics in Signal
Processing, IEEE Journal of, 2, 707

Morales M. F., 2011, PASP, 123, 1265
Morales M. F., Matejek M., 2009, MNRAS, 400, 1814
Neben A. R., et al., 2015, Radio Science, 50, 614
Otobe E., et al., 1994, PASJ, 46, 503
Parsons A. R., et al., 2010, The Astronomical Journal, 139, 1468
Price D. C.,
2016, Astrophysics Source Code Library,

ascl:1603.013

Tegmark M., 1997a, Phys. Rev. D, 55, 5895
Tegmark M., 1997b, ApJ, 480, L87
Tegmark M., Zaldarriaga M., 2009, Phys. Rev. D, 79, 083530
Tegmark M., Zaldarriaga M., 2010, Phys. Rev. D, 82, 103501
Thornton D., et al., 2013, Science, 341, 53
Thyagarajan N., Beardsley A. P., Bowman J. D., Morales M. F.,

2015a, arXiv:1510.08318

Thyagarajan N., et al., 2015b, ApJ, 807, L28
Tingay S. J., et al., 2013, PASA - Publications of the Astronomical

Society of Australia, 30

Virone G., et al., 2014, Antennas and Wireless Propagation Let-

ters, IEEE, 13, 169

Wijnholds S., van der Veen A.-J., 2009, Signal Processing, IEEE

Transactions on, 57, 3512

Zheng H., et al., 2014, MNRAS, 445, 1084
de Oliveira-Costa A., Tegmark M., Gaensler B. M., Jonas J., Lan-

decker T. L., Reich P., 2008, MNRAS, 388, 247

de Vos M., Gunst A., Nijboer R., 2009, Proceedings of the IEEE,

97, 1431

van Haarlem M. P., et al., 2013, A&A, 556, A2

MNRAS 000, 1–10 (2016)

