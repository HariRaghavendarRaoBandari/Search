6
1
0
2

 
r
a

 

M
0
1
 
 
]
r
e
h
t
o
.
t
a
m
-
d
n
o
c
[
 
 

1
v
8
2
4
3
0

.

3
0
6
1
:
v
i
X
r
a

Optimization of constrained density functional theory

David D. O’Regan1, ∗ and Gilberto Teobaldi2, 3, †

1School of Physics, CRANN and AMBER, Trinity College Dublin, Dublin 2, Ireland

2Stephenson Institute for Renewable Energy and Department of Chemistry,

The University of Liverpool, L69 3BX Liverpool, United Kingdom

3Beijing Computational Science Research Center, Beijing 100094, China

(Dated: March 14, 2016)

Constrained density functional theory (cDFT) is a versatile electronic structure method enabling
ground-state calculations to be performed subject to physical constraints, broadening their ap-
plicability and utility. Automated optimisation of Lagrange multipliers is necessary for multiple
constraints to be applied eﬃciently in cDFT, and for it to be applied in tandem with geometry
optimization or molecular dynamics. In order to facilitate this, we provide a detailed treatment of
the possible character and uniqueness of cDFT stationary points. We calculate the relevant deriva-
tives with a new emphasis on the roles played by Kohn Sham orbital orthonormality, electronic
interactions and screening described by the microscopic dielectric function. New, generally appli-
cable expressions are derived, which relate the second-derivatives of the total-energy, its constraint
and constraint-free components, to integrated response and inverse response functions. Formulae are
constructed for building gradient preconditioners for cDFT, and for use with root-ﬁnding algorithms
related to Newton’s method, while circumventing explicit summation over unoccupied states.

PACS numbers: 71.15.-m, 31.15.E-, 71.15.Qe, 71.15.Dx

I.

INTRODUCTION

Constrained density functional theory (cDFT)1 is a
generalization of density functional theory (DFT)2,3 in
which external constraints are applied in order to simu-
late an excitation process, to calculate a response prop-
erty, or to impose a physical condition that is not met
by the unconstrained approximate exchange-correlation
functional. Such constraints may be applied to physi-
cal expectation values of the charge or spin density, their
sums, diﬀerences, and moments within pre-deﬁned spa-
tial regions4–16. They are chosen on the basis of phys-
ical intuition and experience. Constraining potentials
that are non-local or orbital-dependent may also be in-
troduced, moving beyond formal DFT4. cDFT enables
individual excited states to be studied within the well-
established framework of ground-state DFT4–7,17–19, but
only those excited states which may be represented as the
ground-state for some potential. While these excitations
are not guaranteed to match the neutral excitations of
the system, yielded for example by time-dependent DFT,
their description may nonetheless beneﬁt from physical
conditions such as charge transfer, which are introduced
by cDFT yet absent in the approximate functional. As
such, cDFT oﬀers important insights that are challenging
to obtain otherwise5,11,17,20,21.

In practice, cDFT has proven to be a very eﬃcient
approach for simulating neutral excitations in molecu-
lar systems, particularly in cases where a clear spatial
delineation may be made between charge (or spin) donor
and acceptor regions4–7,17–23. cDFT is a signiﬁcant asset,
therefore, in the simulation of exciton formation, where
the incorrect long-ranged behaviour of conventional lo-
cal or semi-local exchange-correlation functionals may be
partially corrected by using appropriately constructed

constraints19,22–25.
It has also been used to calculate
electron transfer11,26–35, excitation energy transfer36,37,
and exchange coupling parameters14,15,38 for use in model
Hamiltonians, as well as Coulomb interaction parameters
for methods such as DFT+U 39–44.
cDFT has, more-
over, been shown to be an eﬀective corrector for self-
interaction error in approximate functionals, when calcu-
lating diabatic free-energy surfaces for electron-transfer
reactions11. As a promising antidote to static correlation
error in approximate functionals, cDFT has been used to
generate small, eﬃcient basis sets for conﬁguration inter-
action calculations, by breaking degeneracies to sample
the most relevant charge and spin states21,45–48. For a
recent comprehensive review, see Ref. 1.

In order for the great utility and potential of the cDFT
approach to be fully realized in the routine simulation
of charge-transfer excitations, degenerate, or strongly-
interacting systems, however, it must be eﬃciently au-
tomated and user accessible. For this, robust optimi-
sation algorithms for the Lagrange-multipliers enforc-
ing the constraint functionals of cDFT are desirable,
and indeed necessary in cases of multiple simultane-
ous constraints such as on charge and spin1,4,9,10,18.
Additionally, automated Lagrange multiplier optimisa-
tion for each ionic conﬁguration is practically obliga-
tory when performing geometry optimisation4–7,17,18 or
molecular dynamics10,11,29,32,49 in tandem with cDFT.
As we increasingly see materials databases constructed
using high-throughput DFT approaches50,51, cDFT may
have a role to play, for example in large-scale screening
for eﬃcient charge-transfer or energy-transfer materials,
but only if its Lagrange multiplier optimization is made
fully automated and numerically eﬃcient.

Critical to both the theoretical underpinning and nu-
merical practice of cDFT is the nature of the energy land-

scape with respect to the Lagrange multipliers that de-
termine the strength of the constraining potentials. Gra-
dients, curvatures, mixed and higher derivatives of this
landscape are related to physical response properties of
interest, and, in particular, certainty about the nature
and uniqueness of any stationary points at which the con-
straints are satisﬁed is prerequisite to eﬃciently locating
them numerically. Wu and Van Voorhis (W&VV)5 car-
ried out the pioneering and enabling work in this area,
analysing the relevant derivatives, and their principal re-
sults have been synopsized in numerous works1,4,18,23,52.
It was concluded by W&VV5 that a non-trivial station-
ary point arises only at a maximum of the total-energy
with respect to a cDFT Lagrange multiplier, implying
the uniqueness of any such point. This is a central result
in cDFT, which has been extended to the multivariate
case in Refs. 4 and 1.

The present work builds from this foundation, pro-
viding new analytical results for use in optimizing the
cDFT Lagrange multipliers eﬃciently, clarifying the re-
lationship between the relevant derivatives, and identi-
fying particular situations of physical relevance in which
numerical Lagrange multiplier optimization may be ex-
pected to present challenges. In particular, we show that
the necessity for Kohn-Sham orbital orthonormality and
electronic screening may alter, with respect to the expres-
sions provided by W&VV, the second energy derivatives
relevant to cDFT. Not only does this have some concep-
tual signiﬁcance, but it also changes these derivatives nu-
merically. Considering rapidly-converging optimization
algorithms such as Newton’s method, for example, we
show here that the second derivatives which it incorpo-
rates may be substantially altered by screening eﬀects.

The results presented in this work pertain not only
to cDFT, but generally to electronic structure methods
for screened response properties beyond the independent-
particle approximation, such as density-functional per-
turbation theory53. In principle, the Lagrange multiplier
could be generalized as a parameter in any perturbation
to the electronic system, such as the component of the
electromagnetic ﬁeld or a lattice displacement. Specif-
ically, we provide revised and in some cases new ex-
pressions for the gradient and curvature 54 of the total-
energy, its constraint and DFT contributions individu-
ally, both with respect to a cDFT Lagrange multiplier,
its screened analogue, and its corresponding target ex-
pectation value. We outline how these quantities may be
used to solve the cDFT-related optimization problems us-
ing rapidly-converging root-ﬁnding algorithms based on
Newton’s method, or by preconditioning gradient-based
algorithms. Electronic screening eﬀects may change the
nature of cDFT stationary points qualitatively, in princi-
ple, yet the guarantee of stationary point uniqueness at
maxima is nonetheless maintained for well-behaved sys-
tems in the convex region of their energy minima with
respect to the electronic density. We discuss the class of
systems where constraints are applied to excessively cou-
pled degrees of freedom, in which case the problem may

2

be expected to become ill-conditioned. Our formulae for
gradient preconditioners may be used to compensate for
this. Finally, we construct a simple cDFT optimization
problem which is ill-posed, that is one in which the sta-
tionary point is not unique.

II. CONSTRAINED DENSITY-FUNCTIONAL
THEORY AND ITS ENERGY DERIVATIVES:

ORBITAL ORTHONORMALITY AND

SCREENING EFFECTS

We begin by introducing the cDFT1 constraint func-
tional, following the deﬁnition and notation introduced
in the enabling article on cDFT automation, by W&VV5.
Thus, we consider an electronic system treated using
Kohn-Sham density-functional theory (DFT)2,3, subject
to an arbitrary constraint on its electron density (see
W&VV’s Eq. 1, Ref. 8 and footnote55) of the form
C [ρ] = N [ρ] − Nc; N [ρ] =

c (r) ρσ (r) dr. (1)

(cid:88)

(cid:90)

wσ

σ

Here, ρσ (r) is the electronic density of spin σ, wσ
c (r)
is an arbitrary local weight function describing a spatial
region of particular interest in the system, and Nc is the
target electron number to be enforced on that region. In
order to apply this constraint, a term is added to the
conventional DFT total-energy, EDFT [ρ], to build the
functional given by (c.f. W&VV’s Eq. 4)

W [ρ, Vc] = Ec [ρ, Vc] + EDFT [ρ] and
Ec [ρ, Vc] = VcC [ρ] ,

(2)
(3)

where Vc is the Lagrange multiplier. Minimizing W with
respect to the density via the Kohn-Sham orbitals φiσ,
for a given Vc, under the condition that these orbitals
are orthonormalized for each spin (as opposed to nor-
malized as stated by W&VV – the ostensibly pedantic
distinction being necessary as we now show) gives rise
to the Kohn-Sham equations3 including a constraining
potential Vcwσ
c (r). This minimization, i.e., solving the
constrained Kohn-Sham equations, does not correspond
to the free extremization expressed as δW/δφ∗
iσ = 0,
as stated by W&VV following their Eq. 6, since the
functional derivative alone cannot encode the orbital or-
thonormality constraint. Rather, solving the Kohn-Sham
equations instead corresponds to extremizing the La-
grangian given by

Ω [ρ, Vc] = W [ρ, Vc]

−(cid:88)

Nσ(cid:88)

εijσ

(cid:18)(cid:90)

(4)

(cid:19)

iσ (r) φjσ (r) dr − δij
φ∗

.

σ

ij

Here, we have assumed that the system is Kohn-Sham
insulating, for simplicity, with N σ electrons per spin σ.
Following the application of the condition δΩ/δφ∗
iσ = 0,
we may perform a unitary transformation among the re-
sulting equations. This of course also transforms the

iσ

orbitals, yet this presents no problem since Ω [ρ, Vc] is
invariant under such transformations for density func-
tionals. Diagonalising the matrix Lagrange multiplier
εijσ, thereby, returns the Kohn-Sham cDFT equations of
W&VV’s Eq. 5, with eigenvalues εiσ. Thus, we may suc-
cinctly write, at the physically relevant minimum of W,
the expression δW/δφ∗
iσ = ˆHσφiσ or indeed its complex
conjugate δW/δφiσ = φ∗
ˆHσ, where ˆHσ is the Kohn-
Sham cDFT Hamiltonian for spin σ. Returning to fol-
low W&VV, we next deﬁne the function W (Vc) as the
evaluation of W [ρ, Vc] using the density generated by
orbitals (orthonormal by construction) which solve the
Kohn-Sham equations including the constraining poten-
tial Vcwσ
c (r) or, for the avoidance of doubt concerning
Kohn-Sham excited states, the physical minimum of the
total-energy for a given Vc. As we go on to show, the non-
vanishing orbital derivative of W [ρ, Vc] has consequences
for the interpretation of the ﬁrst and second derivatives
of W (Vc).

A. Notation for derivatives including electronic

screening eﬀects

(cid:90)

(cid:88)

We brieﬂy clarify the distinction of total and partial
derivatives in this context. The total derivative includes
all orbital and density relaxation eﬀects, and it is this type
that determines the nature of cDFT stationary points. In
the multivariate case where a number of Lagrange mul-
tipliers are in simultaneous eﬀect, they should always be
considered as independent variables for the purposes of
calculating such derivatives. Then, the Hessian (impre-
cisely speaking) of interest is the matrix of mixed second
total derivatives within the present notation. The partial
and functional derivatives include only explicit depen-
dence, and thus no orbital or density relaxation eﬀects.
In certain cases, the dependence of the constrained ex-
pectation value on its Lagrange multiplier may be written
directly in terms of it, for example if the density responds
linearly with a constant response χc, as in

N [ρ] =

c (r) ρσ (r) dr = N0 − χcVc.
wσ

(5)

σ

Then, it is plausible but erroneous to write that

C [ρ, Vc] = N0 − χcVc − Nc
⇒ ∂W
∂Vc

∂ (VcC)

∂Vc

=

= C − χcVc,

(6)

implying the inconsistency of cDFT optimization since

= 0 ⇒ N = Nc − χcVc (cid:54)= Nc.

(7)

∂W
∂Vc

The resolution of this problem is in the realisation that,
even though the dependence of N on Vc may be known
or assumed to have a closed form as above, this does
not imply an explicit dependence of one on the other.

The dependence is instead implicit via the Hamiltonian
and then via the orbitals and density, and so, correctly,
∂W/∂Vc = C and the optimizibility of cDFT is restored.

3

B. The total-energy total derivative

The ﬁrst derivative of the cDFT total-energy with re-

spect to the Lagrange multiplier, Vc, is given by

dW
dVc

=

=

σ

(cid:88)
Nσ(cid:88)
(cid:88)
Nσ(cid:88)
(cid:32)(cid:88)

σ

i

i

+

σ

Tr

Tr

(cid:90)

(cid:21)

(cid:20) δW
(cid:20)(cid:16) ˆHσφiσ

δφ∗

iσ

dφ∗
iσ
dVc

(cid:17) dφ∗

iσ
dVc

+ c.c.

+

∂W
∂Vc

(cid:21)
(cid:33)

+ c.c.

c (r) ρσ (r) dr − Nc
wσ

,

(8)

where the trace symbol Tr in this instance denotes an
integral over space since the operators are all local, and
c.c. represents the complex conjugate of the preceding
term. For any value of Vc, the orbitals that generate the
density minimizing W [ρ, Vc] are unique up to unitary
transformations, and we are free to choose the set that
diagonalize the Hamiltonian for that particular value of
Vc. This, together with the fact that the change in an
eigenstate with respect to a small perturbation in the
Hamiltonian is always orthonormal to that eigenstate53,
allows us to simplify the latter expression, since then

(cid:20)(cid:16) ˆHσφiσ

(cid:21)

(cid:17) dφ∗

iσ
dVc

Tr

(cid:21)
(cid:88)

dφ∗
iσ
dVc

(cid:20)

(cid:90)
(cid:90) φ∗

= εiσTr

φiσ

= εiσ

×

φiσ (r)

φ∗
aσ (r) dr

aσ (r(cid:48))

a(cid:54)=i
dvKS

σ (r(cid:48))
dVc
εiσ − εaσ

φiσ (r(cid:48))

(9)

dr(cid:48)

evaluates to zero by virtue of the orthonormality of φiσ
and φaσ for a (cid:54)= i. This result is nothing but the appli-
cation of the Hellmann-Feynman theorem to the cDFT
problem. Here, vKS
is the Kohn-Sham potential, i.e., the
total eﬀective potential, that which is relevant to pertur-
bation theory involving Kohn-Sham states53,56.

σ

σ

= ˆwσ

σ = δˆvexternal

σ
c δVc, whence dvKS

In the absence of screening eﬀects, as implicitly as-
sumed to be the case by W&VV, the change in total
potential equals the external perturbation δˆvexternal
, and
then δˆvKS
σ (r) /dVc =
ˆwσ
c (r) in the above expression. More generally, however,
an account of electronic screening of the perturbation is
necessary in the context of DFT, and such eﬀects are en-
capsulated in the inverse microscopic dielectric function
deﬁned by −1
(r(cid:48)) (using a
lunate epsilon to distinguish from it from the Kohn-Sham

σσ(cid:48) (r, r(cid:48)) = δvKS

σ (r) /δvexternal

σ(cid:48)

=

σ(cid:48)

σ (r)

dvKS
σ (r)
dVc

(cid:90)
(cid:88)
dvKS
(cid:90)
(cid:88)
(r(cid:48))
dvexternal
σ(cid:48)
−1
σσ(cid:48) (r, r(cid:48)) wσ(cid:48)
≡ (cid:0)−1wc
(cid:1)σ
tized form(cid:0)−1/2wc−1/2(cid:1)σ

(r) .

σ(cid:48)

=

σ(cid:48)

dvexternal
dVc
c (r(cid:48)) dr(cid:48)

(r(cid:48))

dr(cid:48)

(10)

eigenvalues). In the context of pure cDFT, we may write

For cDFT with non-local potentials, we note, the Hermi-
(r, r(cid:48)) should be used here in

order to ensure the physicality of the potential.

C. Orbital orthonormality and the interpretation

of stationary points

Screening eﬀects notwithstanding, all cancels to zero
in the total derivative of W (Vc), excepting the ﬁnal, ex-
plicit constraint term on the ﬁnal line of Eq. 8. The value
of dW/dVc is thus, in practical calculations, precisely the
same as that given by W&VV’s Eq. 6, which is derived
by invoking δW/δφ∗
iσ = 0. The interpretation of that
equation is diﬀerent to that of the present Eq. 8, how-
ever. The condition δW/δφ∗
iσ = 0 implies that ﬁrst-order
changes in the ground-state total-energy due to changes
in the orbitals, and thus in the density, vanish entirely.

c (V S

Assuming momentarily that the latter condition holds,
we would be obliged to conclude that any non-zero com-
ponent of dW (Vc) /dVc is due explicitly to the constraint
contribution Ec = VcC [ρ] to the total-energy, since the
remaining DFT contribution EDFT is stationary. This
would then imply that the stationarity of W (Vc) at some
c (cid:54)= 0, since otherwise the constraint is re-
point V S
dundant) is equivalent to the stationarity of the con-
straint term, taken alone, at that point. The subsequent,
incorrect conclusion to be drawn from δW/δφ∗
iσ = 0 is
that the total-energy W and constraint term Ec have the
same curvature, in contrast to numerical results, an ex-
ample of which are shown in Fig. 1. This would present
a paradox, moreover, since if the curvature is non-zero
(true for any useful constraint) then since the constraint
term must pass through zero both at Vc = 0 and at
Vc = V S
c , it must have non-zero derivatives (i.e., not be
stationary) at both of those points. The ﬁrst and second
derivatives computed on the basis of δW/δφ∗
iσ = 0 are
eﬀectively inconsistent, then, for non-trivial constraints.
The resolution of this problem, recalling the present
Eq. 8, is that the vanishing trace in that equation may
be partitioned into two generally non-vanishing but can-
celling contributions whereby, at a stationary point,

=

δW
δEc
δφ∗
δφ∗
⇒ 0 = VcTr

iσ

iσ

δEDFT
δφ∗

+

(cid:20) δC

iσ

dφ∗
iσ
dVc

δφ∗

iσ

= Vc

(cid:21)

δC
δφ∗

δEDFT
δφ∗

+

(cid:20) δEDFT

iσ

+ Tr

iσ

dφ∗
iσ
dVc

δφ∗

iσ

(cid:21)

.

(11)

Thus, both the electronic energy EDFT and the con-
straint term may individually contribute substantially to

4

FIG. 1.
(Color online) The cDFT total-energy W , and its
constraint, Ec, and DFT, EDFT, components, as a function
of the Lagrange multiplier Vc, for a charge-constrained nitro-
gen molecule. The Vc values at which Ec and W attain max-
ima are shown, to the nearest 0.5 eV, with dashed vertical red
and green lines, respectively. Inset: the left-hand atom is con-
strained to lose charge with respect to its ground-state popu-
lation, using an on-atom population analysis combining s and
p orbitals. With respect to the ground-state density, charge
depleted regions are shown with a cyan charge-diﬀerence iso-
surface and the charge augmented region is shown with an or-
ange isosurface. The unconstrained right-hand atom exhibits
strong polarization, and depletion in the lone-pair region.

the derivatives of W (Vc), as shown in Fig. 1. As a result,
if the total-energy W is stationary at some value of the
Lagrange multiplier, this does not imply the stationarity
of its constraint contribution alone, and vice versa. These
electronic energy and constraint contributions to dW/dVc
then partially cancel, to leave only the term due to the
partial derivative ∂W/∂Vc, which in turn vanishes when
the constraint is satisﬁed. Our result for the ﬁrst deriva-
tive is numerically in perfect accordance with W&VV,
and so this technical distinction has no bearing on ex-
isting cDFT Lagrange multiplier optimisation based on
total-energy ﬁrst-derivatives alone. It may enable other
forms of optimisation, however, as we go on to describe.

III. ENERGY CURVATURE AND THE

NATURE OF CDFT STATIONARY POINTS

We next consider the second derivative, or “curvature”,
of W (Vc), which is required to classify the nature and
uniqueness of the stationary point or points at which
the constraint is satisﬁed. Here, our result diﬀers some-
what from that of W&VV, numerically and potentially
also qualitatively. Following from Eq. 8 and applying the
product rule for diﬀerentiation where necessary, we may

0123456789Vc (eV)-3-2-101234Energy (eV)WEcEDFTwrite that

d2W
dV 2
c

=

=

σ

d
dVc

(cid:88)
(cid:88)
Nσ(cid:88)
Nσ(cid:88)
(cid:88)
(cid:88)

+

σ

σ

i

i

Tr

i

Tr

φiσ

d ˆHσ
dVc

iσ
dVc
dφ∗
iσ
dVc

(cid:20)(cid:16) ˆHσφiσ
(cid:17) dφ∗
Nσ(cid:88)
(cid:34)(cid:32)
(cid:33)
(cid:20)(cid:18)
Nσ(cid:88)
(cid:88)

(cid:19) dφ∗
(cid:20)(cid:16) ˆHσφiσ
(cid:17) d2φ∗

dφiσ
dVc

dρσ (r)

iσ
dVc

(cid:90)

ˆHσ

Tr

Tr

i

+

iσ
dV 2
c

σ

+

σ

(cid:21)
(cid:35)

+ c.c.

+

dC
dVc

+ c.c.

(cid:21)

(cid:21)

+ c.c.

+ c.c.

wσ

c (r)

dVc

dr,

(12)

making explicit the contributions arising at second or-
der in perturbation theory. These may be circumvented
by noting that since the eigencondition ˆHσφiσ = εiσφiσ
holds continuously as we vary the parameter Vc, the ex-
pression in Eq. 9 vanishes for all Vc, and so we may write

(cid:20)(cid:16) ˆHσφiσ

(cid:21)

(cid:17) dφ∗

iσ
dVc

d
dVc

Tr

= 0.

(13)

Thus, all terms in Eq. 12 numerically cancel except for
the ﬁnal term, dC/dVc. This may then be re-written us-
ing non-degenerate (only where appropriate) ﬁrst-order
perturbation theory, after the present Eq. 9, since

wσ

c (r) ρσ (r) dr

5

use in accelerating cDFT Lagrange multiplier optimiza-
tion. Even by using a ﬁnite-diﬀerence method for Eq. 10,
the converged sum over unoccupied states required at
each cDFT Lagrange multiplier optimization step is typ-
ically computationally demanding. We will show, how-
ever, that the result of Eq. 14 may equivalently be calcu-
lated as a linear-response function. For this, simple ﬁnite-
diﬀerence estimates typically suﬃce, and these are very
eﬃcient to calculate in DFT by restarting from check-
point ﬁles.

(cid:1)σ

screened weight function(cid:0)ε−1wc
(cid:0)ε−1wc

With regards to the sign of the energy curvature
given by Eq. 14, the inverse dielectric function may
be expected to lead to a net attenuation of the exter-
nal perturbation. However, the necessarily real-valued
(r) may locally vary,
even in sign, with respect to wc (r) in a complex, system-
dependent manner. Even if we may assume that 0 <
(r) < wc (r) holds everywhere, for a particular
system, and that the orbitals are ﬁlled according to the
Aufbau principle in Eq. 14, the form of this sum oﬀers
no guarantee regarding the sign of d2W/dV 2
c .

(cid:1)σ

On the other hand, experience and extensive literature
(see recent review Ref. 1) show that d2W/dV 2
c is indeed
negative for density constraints applied to a wide variety
of systems, in which cases cDFT stationary points are
unique. As now we go on to numerically conﬁrm, Eq. 13
provides that this this curvature reduces, for ground-
states, to the interacting density response function of the
system, doubly integrated with wσ
c . This, we then show,
is always negative if the unconstrained system exhibits a
positive curvature with respect to the weighted density,
yet is not necessarily negative otherwise.

i

σ

σ

d
dVc

(cid:90)
(cid:88)
(cid:90)
(cid:88)
Nσ(cid:88)
(cid:90)
(cid:88)
Nσ(cid:88)
(cid:90) φ∗
(cid:88)
(cid:88)
Nσ(cid:88)
(cid:18)(cid:18)(cid:90)
(cid:18)(cid:90)

×

×

σ

σ

i

i

×

=

=

=

dVc

(cid:88)

a(cid:54)=i
φiσ (r(cid:48))

c (r(cid:48)) φ∗
wσ

iσ (r)

φaσ (r) dr

dr(cid:48) + c.c.

aσ (r(cid:48))

dvKS

σ (r(cid:48))
dVc
εiσ − εaσ

1

εiσ − εaσ

a(cid:54)=i
φ∗
aσ (r) wσ

(cid:19)
(r(cid:48)) φaσ (r(cid:48)) dr(cid:48)(cid:19)(cid:19)

c (r) φiσ (r) dr

iσ (r(cid:48))(cid:0)ε−1wc

(cid:1)σ

φ∗

c (r) φ∗
wσ

iσ (r)

dφiσ (r)

dr + c.c.

IV. RELATIONSHIPS BETWEEN RESPONSE

FUNCTIONS AND ENERGY CURVATURES

The curvature of the total-energy with respect to the
Lagrange multipliers is required for cDFT optimization
algorithms moving beyond those that operate on gradi-
ents only, whether they locate total-energy extrema or
the roots of the constraints. For multi-constraint prob-
lems with a vector Lagrange multiplier Vc, the curva-
ture may be helpful to build preconditionitioners even for
gradients-only optimisation, in the event that the prob-
lem at hand is ill-conditioned, i.e., if the positive-valued
condition number k deﬁned by

(cid:18)(cid:20) d2W

(cid:21)

(cid:88)

(cid:19)2(cid:88)

(cid:32)(cid:34)(cid:18) d2W

(cid:19)−1(cid:35)

(cid:33)2

(15)

IJ

dV2
c

IJ

KL

dV2
c

KL

(14)

+ c.c..

k2 =

This expression reduces to W&VV’s Eq. 7 only if screen-
ing eﬀects are neglected, that is if we make the approx-
σσ(cid:48) (r, r(cid:48)) = δσσ(cid:48)δ (r − r(cid:48)). Then, as noted by
imation ε−1
W&VV, the anti-symmetry of the summand implies that
contributions from a ≤ Nσ cancel to and may be omit-
ted. The presence of the inverse microscopic dielectric
function in Eq. 14 renders it somewhat impractical for

is signiﬁcantly larger than one. We refer the reader to
Ref. 57 for a more general discussion of condition num-
bers in the context of electronic structure methods.

In order to numerically test and illustrate our an-
alytical ﬁndings, we performed a cDFT study on the
simple nitrogen molecule shown in Fig. 1. For each
value of a charge-constraining Lagrange multiplier, well

6

A.

Identities related to the integrated screened

response function

Referring to Fig. 2, we note a very close numerical
correspondence between the total-energy curvature with
respect to the Lagrange multiplier and the screened in-
tegrated response function of the form dN/dVc, where N
is the weighted density subject to the constraint. The
numerical agreement

d2W
dV 2
c

=

dC
dVc

=

dN
dVc

(16)

serves to conﬁrm the validity of Eq. 13, which is to say
the simpliﬁcation of Eq. 12 to Eq. 14 for all values of Vc.
In the multivariate case, the condition number k may,
therefore, be expressed in a very computationally conve-
nient form, where N is the vector of weighted densities
under constraint, by means of

(cid:18)(cid:20) dN

(cid:21)

(cid:88)

(cid:19)2(cid:88)

(cid:32)(cid:34)(cid:18) dN

(cid:19)−1(cid:35)

(cid:33)2

. (17)

k2 =

IJ

dVc

IJ

KL

dVc

KL

Taking the constraint contribution alone, next, we may

also numerically conﬁrm, via Fig. 2, the new result

(cid:20)

(cid:21)

d2 (VcC)

d2Ec
dV 2
c

=

=

d
dVc

C + Vc

dC
dVc

dV 2
c
dC
dVc

= 2

+ Vc

d2C
dV 2
c

= 2

dN
dVc

+ Vc

d2N
dV 2
c

,

(18)

to which the linear-response approximation 2dN/dVc is
observed to be unreliable. On this basis, we may also
deduce a very general result for the DFT energy, i.e.,

d2EDFT

dV 2
c

=

d2 (W − Ec)

dV 2
c

= − dN
dVc

− Vc

d2N
dV 2
c

.

(19)

In order to check the validity of our approach to treat-
ing functional interdependence and derivatives, we also
calculated the unscreened sum-over-states perturbation
theory result for d2W/dV 2
c following W&VV, correspond-
ing to the neglect of screening in Eq. 14. For this, we
generated optimized conduction band states using the
method described in Ref. 63, with the conduction band
Wannier function cutoﬀ radii set to 14 a0. This enabled
us to numerically conﬁrm that unscreened perturbation
theory (solid circles in Fig. 2) does not generally recover
the total energy curvature, nor that of the constraint
or DFT energy contributions individually. The anti-
symmetry of the unscreened perturbation theory sum-
mand guarantees that the sum monotonically decreases
with an increasing number of conduction band states, so
that the discrepancy here between the measured energy
curvature and the unscreened sum-over-states also mono-
tonically increases.

FIG. 2. (Color online) The numerically evaluated curvatures
(second derivatives) of the cDFT total-energy W , and its con-
straint, Ec, and DFT, EDFT, components, with respect to
the Lagrange multiplier, Vc, for the system shown in Fig. 1.
Dashed vertical lines have the same signiﬁcance as in Fig. 1.
The Lagrange multiplier Vc derivatives of the constrained oc-
cupancy N , which correspond to the latter curvatures, are
shown, as well as the linear-response approximation to one of
them (crosses). Evaluated values of the unscreened sum-over-
states perturbation theory expression for d2W/dV 2
c following
W&VV are also shown (solid circles).

converged BLYP58,59 ground-state energies and densi-
ties, with pseudized 1s states, were calculated using the
ONETEP linear-scaling Kohn-Sham DFT code60. This
code solves for the ground-state by optimising a minimal
set of nonorthogonal generalized Wannier functions61 in
situ. Each of these functions is expanded in an underlying
variational plane-wave equivalent basis set and truncated
within a prescribed cut-oﬀ sphere, in this particular case
to a radius of 10 a0. This approach has been shown
to oﬀer ﬁnite-diﬀerence linear response properties with
an accuracy matching that of conventional plane-wave
DFT62.

The constrained population was deﬁned using the
four 2s and 2p valence pseudo-orbitals of the isolated
atom. Strictly speaking, the resulting constraint acts
on the Kohn-Sham orbitals (or density-matrix, equiva-
lently) rather than on the density. Our analytical ﬁnd-
ings extend to that case with minor notational changes
and it therefore suﬃced to treat it numerically for our
present purposes.
In the dimer, the resulting uncon-
strained ground state atomic occupancy was approxi-
mately 6.5 e, due to overlap between the two atoms. The
charge of one of the nitrogen atoms was constrained, with
the target occupancy set to Nc = 6.0 e. Fig. 1 serves to
illustrate that when the constraint energy Ec vanishes
for ﬁnite ﬁnite Lagrange multiplier Vc, the total-energy
W achieves a maximum with respect to the latter, and
that it is the only such stationary point. It is also clear
that W and Ec exhibit diﬀerent negative curvatures here,
and that the diﬀerence, the DFT component EDFT, nec-
essarily exhibits positive curvature in Vc away from its
unconstrained ground-state DFT value.

234567Vc (eV)-0.3-0.2-0.10.00.10.2Energy curvature (eV-1)d2W/dVc2dN/dVc2dN/dVcd2Ec/dVc22dN/dVc + Vcd2N/dVc2d2EDFT/dVc2-dN/dVc - Vcd2N/dVc2Perturbation Theory7

FIG. 3. (Color online) Results of the calculations shown in
Fig. 2, but where derivatives are taken instead with respect
to the change in Kohn-Sham potential averaged over the con-
strained region, that is the ∆V induced by a ﬁnite Vc, us-
ing the same weight function as used to calculate the con-
strained occupancy N . The derivative dN/dV corresponds
to the average unscreened charge response of the constrained
region, whereas dN/dVc is the screened response. The sum-
over-states perturbation theory data points are as previously
stated. Unlike the derivatives of Fig. 2, these unscreened (i.e.,
bare or non-interacting) derivatives are not equivalent.

FIG. 4. (Color online) Following from Fig. 3, the correspon-
dence between energy curvatures and averaged unscreened
response functions is recovered by using mixed screened-
unscreened second derivatives, ensuring that the screening
is consistent between them. The unscreened sum-over-states
perturbation theory (P.T.) data points following W&VV are
again shown (solid circles), together with the “Renormalized
P.T.” data points (open black circles) described in the main
text.

B.

Identities related to the integrated unscreened

response function

In Figs 3 and 4, we clarify the relationship between en-
ergy curvatures and integrated density response functions
with respect to the screened equivalent of the cDFT La-
grange multiplier, that is the average of the Kohn-Sham
potential over the constrained region. This serves as a
stringent numerical test of the relevance and magnitude
of screening eﬀects in the energy derivatives of cDFT.
The relevant weighted measure of the screened potential,
for pure density functionals and constraints, is given by

(cid:19)(cid:18)(cid:90)

c (r(cid:48)) dr(cid:48)(cid:19)−1

wσ

Then, whereas dN/dVc is the integrated interacting den-
sity response function, dN/dV is its non-interacting (also
known as independent-particle or unscreened) counter-
part. For local constraints on the density, we may ex-
press these functions in terms of the non-local density
response operators, ˆχσσ(cid:48)

, respectively, as

and ˆχσσ(cid:48)

0

(cid:18)(cid:90)

V σ =

wσ

c (r) vKS

σ (r) dr

c (r) χσσ(cid:48)
wσ
c (r) χσσ(cid:48)
wσ

0

(r, r(cid:48)) wσ(cid:48)

(r, r(cid:48)) wσ(cid:48)

c (r(cid:48)) dr dr(cid:48);
c (r(cid:48)) dr dr(cid:48).

(21)

(22)

(cid:90)(cid:90)
(cid:90)(cid:90)

=

dN σ
dV σ(cid:48)
c
dN σ
dV σ(cid:48) =

For constraints on more complex, non-local projections
of the density or density matrix, these expressions may
be generalised by replacing the local weighting functions
wσ

c (r) by the relevant non-local operators.
Fig. 3 shows that na¨ıvely replacing Vc by V does not
preserve any equivalence between energy curvatures and

response functions, nor need it do so. The screening-
consistent, mixed derivatives, with respect to Vc and V ,
are instead shown in Fig. 4. First, returning with the
result dW/dVc = C for Kohn-Sham states, we have that

d2W
dV dVc

=

dC
dV

=

dN
dV

,

(23)

which is numerically conﬁrmed via Fig. 4. Next, we have

(cid:21)

d2Ec
dV dVc

=

=

d2 (VcC)
dV dVc
dC
dV

+

dVc
dV

C + Vc

dC
dVc

+ Vc

d2C
dV dVc

(cid:20)

=

d
dV
dC
dVc
d2N
dV dVc

.

(20)

= 2

dN
dV

+ Vc

,

(24)

and, for the diﬀerence between the two, we ﬁnd that

d2EDFT
dV dVc

=

d2 (W − Ec)

dV dVc

= − dN
dV

− Vc

d2N
dV dVc

.

(25)

These mixed derivatives have been calculated simulta-
neously with the previously detailed curvatures with re-
spect to Vc, simply by monitoring the variation of the
weighted Kohn-Sham potential of Eq. 20 in the ground-
state, within self-consistent cDFT calculations.

C. The connection with unscreened perturbation

theory by explicit summation over states

The non-interacting response function dN/dV =
d2W/dV dVc and unscreened quantities related to it are
of no evident utility in cDFT optimisation. For com-
prehensiveness, notwithstanding, we investigate here how

123456∆V (eV)-0.6-0.4-0.20.00.20.4Energy curvature (eV-1)d2W/dV2dN/dV2dN/dVd2Ec/dV22dN/dV + ∆Vd2N/dV2d2EDFT/dV2-dN/dV - ∆Vd2N/dV2Perturbation Theory234567Vc (eV)-0.4-0.3-0.2-0.10.00.10.2Energy curvature (eV-1)d2W/dVdVcdN/dV2dN/dVd2Ec/dVdVc2dN/dV + Vcd2N/dVdVcd2EDFT/dVdVc-dN/dV - Vcd2N/dVdVcPerturbation TheoryRenormalized P.T.the unscreened sum-over-states perturbation theory ex-
pression given by Eq. 7 of Ref. 5 relates to cDFT within
the present framework. This corresponds to the replace-
ment of ε−1wc by wc in Eq. 14, and thus to the response
of the weighted density N to a change in the weighted
Kohn-Sham potential labelled V , with all other degrees
of freedom in the Kohn-Sham potential prevented from
relaxing self-consistently.

8

Its evaluation for two values of Vc, namely those at
which Ec and W assume maxima, to the nearest 0.5 eV,
is shown in Fig. 4 (solid circles). The proximity of these
data points to d2Ec/dV dVc is coincidental, and they
sit, moreover, rather far from their most closely related
quantity, dN/dV . The diﬀerence between the sum-over-
states expression and dN/dV is subtle, since both are un-
screened response functions with the same integration. It
arises due to the existence of complex, local ﬂuctuations
in vKS
σ (r) both within and without the weighted region
in the case of dN/dV , as opposed to their non-existence
in the sum-over-states, wherein δvKS

σ (r) = wσ

c (r) δV .

Referring to Eq. 14, the dN/dV calculated in cDFT
simpliﬁes to the unscreened sum-over-states expression
in the case that both dvKS
c (r) and the
change in the average weighted Kohn-Sham potential V σ
is the wholly responsible for the change in subspace oc-
cupancy N , with all other degrees of freedom irrelevant.
The ﬁrst condition and Eq. 20 together imply that

σ (r) /dV σ = wσ

(cid:90) (cid:18) dV σ
(cid:18)(cid:90)

(cid:19)(cid:18) dvKS
c (r(cid:48)) dr(cid:48)(cid:19)−1(cid:90)

σ (r)

dvKS

wσ

1 ≡

=

(cid:19)

σ (r)
dV σ

dr

(wσ

c (r))2 dr,

(26)

which would be readily satisﬁed only if wσ
abrupt three dimensional unit step function.

c (r) were an

The second condition is yet more unrealistic, since we
may directly vary the Lagrange multiplier Vc when con-
straining DFT, but not directly the average subspace
Kohn-Sham potential V σ. As Vc is varied, self-consistent
changes in vKS
σ (r) outside of the weighted region may
substantially mitigate the charge transfer due to changes
within it. Such eﬀects are absent in the sum-over-states
expression, and so this may be expected to typically over-
estimate the magnitude of the eﬀective unscreened re-
sponse dN/dV , a situation exempliﬁed in Fig. 4.

Since the diﬀerences in deﬁnition of the unscreened ef-
fective and sum-over-states response functions are related
to eﬀects outside of the weighted region (albeit not en-
tirely), they cannot be reconciled by renormalisation by
the ratio dV /dVc, since these potentials are already inte-
grated within that region. We have found that an approx-
imate reconciling renormalization may be made, however,
by down-scaling of one of the two functions wc (r) in the
unscreened analogue of Eq. 14 (one applies the pertur-
bation, the other measures the charge) by a factor of

(cid:0)(cid:82) wσ
c (r) dr(cid:1) /(cid:0)(cid:82) dr(cid:48)(cid:1). This scaling mimics the compen-

sating background changes in the Kohn-Sham potential
in the realistic cDFT calculation, by simply reducing,

FIG. 5. (Color online) Numerically evaluated second deriva-
tives of the cDFT total-energy W , constraint Ec and DFT
EDFT components, with respect to the constrained occupancy
N for the system shown in Fig. 1 and occupancy target
Nc = 6e. Dashed vertical lines show the occupancy at which
W (green) and Ec (red) are maximized. The corresponding
occupancy derivatives of the Lagrange multiplier (averaged in-
verse screened response functions) are shown, as well as their
non-corresponding linear-response approximations (crosses).

or “redistributing”, the change in potential wσ
c (r) δV in
proportion to the total system volume. The result of this
renormalization, suitably adapted for orbital-based pop-
ulation analysis, is shown in open black circles in Fig. 4,
and we ﬁnd that the unscreened sum-over-states expres-
sion is brought into fair, but not exact, agreement with
the eﬀective weighted unscreened response dN/dV . A
further downscaling by a factor of the integrated inverse
microscopic dielectric function, which may be calculated
simply by
σσ(cid:48) ≡
−1
≈

(cid:90)(cid:90)
d(cid:82) vKS
d(cid:82) ˆvexternal

c (r) −1
wσ
σ (r) wσ

σσ(cid:48) (r, r(cid:48)) wσ(cid:48)
c (r) dr
c (r(cid:48)) dr(cid:48) =

c (r(cid:48)) dr dr(cid:48)
dV σ
dV σ(cid:48)

(r(cid:48)) wσ(cid:48)

(27)

,

c

σ(cid:48)

is then required to approximately connect the un-
screened sum-over-states perturbation theory with the
cDFT total-energy curvature.

D.

Identities relating inverse response functions

and curvatures with respect to the occupancy target:

the nature of cDFT stationary points revisited

We have shown that the curvatures of the total-energy
and its components, with respect to the cDFT Lagrange
multiplier Vc, are equal to integrated density response
functions. Similarly, the curvatures with respect to the
cDFT occupancy N , for a ﬁxed target Nc, are equal to
integrated inverse density response functions. The oc-
cupancy N is not a free parameter, and so in order to
analyse these curvatures, it is convenient to take deriva-
tives with respect to a dummy cDFT target occupancy
N∗
c , subject to the constraint that N = N∗
c for a suit-
able Lagrange multiplier Vc (N∗
c ), leaving Nc indepen-

5.85.96.06.16.26.3N (e)-30-25-20-15-10-5051015Energy (eV)d2W/dN2dVc/dN + (N-Nc)d2Vc/dN2dVc/dN2dVc/dNd2Ec/dN22dVc/dN + (N-Nc)d2Vc/dN2d2EDFT/dN2-dVc/dNdent. Echoing Eq. 8, for ground-states we have that

The multivariate generalisation of this result, for mul-

9

(cid:88)
(cid:88)

σ

Nσ(cid:88)
Nσ(cid:88)

i

σ

i

dW
dN∗

c

=

=

= − Vc (N∗

Tr

+

+ c.c.

δφ∗

iσ

dN∗

c

dφ∗
iσ
dVc

(cid:21)
(cid:19) dVc
(cid:19) dVc

(cid:20)(cid:18) δW
(cid:20)(cid:18)(cid:16) ˆHσφiσ
(cid:17) dφ∗
c ) ⇒ d2W (N∗
dN∗2
c is satisﬁed for each N∗

= − dVc
dN∗

iσ
dVc

dN∗

+ c.c.

∂W
∂N∗

c

(cid:21)

c )

.

c

c

c

Tr

− Vc

(28)

Since the constraint N = N∗
c , so
the constraint energy always vanishes, and W = EDFT
along the curve. Thus, we may write, for the subspace
occupancy curvature of the DFT contribution, that

d2EDFT (N )

dN 2

d2W (N∗
c )
dN∗2

c

=

= − dVc
dN∗

c

= − dVc
dN

.

(29)

We may extend this to the more general cDFT total-
energy W , no longer subject the constraint that the tar-
get occupancy is attained, by considering an arbitrary
target occupancy Nc (cid:54)= N . For this, it is suﬃcient to
add the curvature of the now non-vanishing constraint
energy term Ec, which is given simply by

(cid:20)

(cid:21)

d2Ec
dN 2 =

d2 (VcC)

dN 2 =
dVc
dN

dC
dN

+ C

= 2

d
dN

Vc

dC
dN

+ C

d2Vc
dN 2 = 2

dVc
dN

dVc
dN
+ (N − Nc)

(30)

d2Vc
dN 2 .

The total-energy curvature is then given by the sum

d2W
dN 2 =

=

d2EDFT
dN 2 +
dVc
dN

d2Ec
dN 2
+ (N − Nc)

d2Vc
dN 2 ,

and so, at all cDFT stationary points, remarkably,

N = Nc ⇒ d2EDFT
dN 2
c

= − 1
2

d2Ec
dN 2
c

.

(31)

(32)

These identities are numerically conﬁrmed via Fig. 5,
where the inaccuracy, except at N = Nc, of linear-
response approximations (shown with crosses) is clear.

As established by W&VV on somewhat diﬀerent
grounds, for single constraints, the curvature of the total-
energy with respect to Lagrange multiplier is thus di-
rectly related to the curvature of the DFT energy with
respect to the weighted occupancy by the expression

(cid:18) dVc

(cid:19)−1

dN

(cid:18) d2EDFT

(cid:19)−1

dN 2

= −

.

(33)

d2W
dV 2
c

=

dN
dVc

=

An important consequence of our results is that this iden-
tity holds irrespective of whether the constraint is satis-
ﬁed, that is for all values of the Lagrange multiplier.

tiple constraints, is given straightforwardly by

(cid:20) d2W

(cid:21)

(cid:20) dN

(cid:21)

=

dV2
c

IJ

dVc

IJ

(cid:18) d2EDFT

(cid:19)−1

dN2

= −

,

(34)

where the negative exponent denotes matrix inversion.
We may also construct its unscreened analogue, for non-
interacting response functions, which takes the form

(cid:18) d∂EDFT

(cid:19)−1

dN2∂N2

,

(35)

d2W

dVdVc

=

dN
dV

= −

where the lattermost non-commuting mixed total and
partial second derivative would be impractical to com-
pute directly.
In cases where the response or inverse
response matrices are singular, the problem at hand is
ill-posed, by deﬁnition, and should be reconsidered.

E. The sign of the cDFT energy curvature, and the

implications of anomalous stationary points

We return now to the character of cDFT stationary
points, their uniqueness, and thus their eﬃcient and re-
liable numerical identiﬁcation. We recall that W&VV’s
result that non-degenerate perturbation theory ensures a
non-negative total-energy curvature5, with respect to the
Lagrange multiplier, breaks down due to the unavoidable
presence of the inverse dielectric function in Eq. 14. How-
ever, the invocation of perturbation theory is rendered
unnecessary by Eq. 34, which is a stronger, more gener-
ally applicable result. It shows that the cDFT curvature
is negative, even for systems with degenerate energy lev-
els and with strongly non-linear response, as long as the
density lies in the convex region of the basin of attrac-
tion of a DFT energy minimum, even if this minimum
is local but not global. In many practical calculations of
interest, the targeted stationary point should indeed lie
in the convex region of the global minimum.

However, Eq. 34 also permits a cDFT stationary point
to occur with positive curvature with respect to the La-
grange multiplier, for example if it lies in the concave
region surrounding a local maximum in the DFT energy
with respect to the weighted density targeted by the con-
straint. A cDFT stationary point may alternatively be
a saddle point, that is not an extremum, and in the fol-
lowing section we construct an idealized system where
this arises, i.e., where the stationary point is non-unique
(it forms a line). Saddle points are inﬂection points for
single-constraints, however, and there the vanishing in-
tegrated response function in Eq. 33 necessitates a di-
vergent curvature of the total-energy with respect to the
weighted density. This cannot occur at the ground-state
of physically reasonable density functionals.

A vanishing total-energy curvature with respect to the
weighted density is more physically reasonable, however,
and is associated with degeneracy of the highest occupied
states in a system. In multivariate cases, the vanishing

of this curvature along at least one vector in the space of
constrained densities is suﬃcient. This implies a diver-
gent integrated response matrix, via Eq. 34, and hence
a divergent curvature at the stationary point (or line, or
higher surface). The transition across such a divergence
in the space of Lagrange multipliers is thus the only fea-
sible mechanism by which the total-energy may change
the sign of its curvature. Such anomalous situations, if
indeed they are realizable numerically at all, are unlikely
to arise in the routine practice of cDFT.

V. LAGRANGE MULTIPLIER OPTIMIZATION,

ILL-CONDITIONED AND ILL-POSED

PROBLEMS, AND PRECONDITIONING

In order to solve for the stationary points of cDFT,
given an initial guess for the Lagrange multipliers, one
may work by either maximizing the ground-state energy
W , or equivalently by locating roots of the vector of
constraints, that is by solving for C = 0. The ﬁrst
approach is particularly convenient in DFT codes that
directly minimize the unconstrained total-energy EDFT
with respect to the density, since their existing implemen-
tations of algorithms of conjugate-gradients type may be
co-opted for optimizing the Lagrange multipliers. This
requires a degree of conﬁdence regarding the curvature
of W , or at least a detection scheme for anomalous cur-
vature. The second approach is attractive in that it
requires no assumptions regarding the sign of the cur-
vature, but then root-ﬁnding algorithms may converge
slowly for anomalous cases of multiple roots. It is nec-
essary that the density be suﬃciently well converged for
each iteration of Vc, however the reduction of compu-
tational eﬀort using adaptive convergence thresholds is
feasible.

In both cases, it is possible to optimize the Lagrange
multipliers using only the energy gradients C, either by
conjugate gradients or by quasi-Newton methods. For a
single cDFT multiplier, iterating the secant method

c = V n−1
V n
c N n−1 − V n−1
V n−2

c N n−2 −(cid:0)V n−2

− V n−2
C n−1 − C n−2

C n−1

−

c

c

c

c

(36)

(cid:1) Nc

− V n−1

c

=

N n−1 − N n−2

(cid:18) V n−1

(cid:19)

may prove adequate for well-behaved systems subject
to physically reasonable constraints. The quasi-Newton
methods that generalize this to multiple constraints may
encounter diﬃculties, however, if the condition number
given by Eq. 17 takes a value that is signiﬁcantly larger
than one. A large condition number indicates that the
curvature of the energy landscape surrounding the cDFT
stationary point is highly anisotropic, in which case the
problem is said to be ill-conditioned. Such optimization
problems require preconditioning for rapid convergence.

10

A. A physically plausible but ill-posed cDFT

optimization problem

If the cDFT condition number of Eq. 17 is inﬁnite,
this indicates that an an inﬁnite number of stationary
points are located on a line, surface, or higher surface in
the space of Lagrange multipliers, and the problem may
be described as ill-posed. A simpliﬁed, but physically
plausible example of such a system where this situation
may arise is a open-shell molecule in which the electron
density and spin-density are both constrained, to target
values Nc and Mc, respectively, with the same weight
function wc, yielding N = N↑+N↓ and M = N↑−N↓. In
non-relativistic systems composed of atoms, Hund’s rule
of maximum multiplicity implies that the spin density
in an open-shell region will scale approximately linearly
with the orbital ﬁlling, so that we may write dM/dN = α
for their small changes, where α < 0 for low-spin conﬁg-
urations and α > 0 for high-spin ones.

Let us assume that this condition holds exactly,

in
which case we have a linear dependence given by M =
M0 + α (N − N0) between the constrained variables,
where M0 and N0 are constants. Then, the total-energy
W of the constrained system may be written in terms of
Lagrange multipliers V N
c , in terms of both N
and M , or in terms of each individually, as

c and V M

W = EDFT + V N

= EDFT +(cid:0)V N
= EDFT +(cid:0)V M

− V N

c Nc + V M

c (N − Nc) + V M
c + αV M
c

(cid:1) N
c /α(cid:1) M

c + αV N

c (M0 − αN0) − V M

c Mc

c (M − Mc)

− V N

c (N0 − M0/α) − V M

c Nc + V N

(37)
The 2 × 2 curvature matrix, or integrated interacting re-
sponse matrix, is singular, since its determinant

c Mc.

(cid:12)(cid:12)(cid:12) dN

dVc

(cid:12)(cid:12)(cid:12) =

=

(cid:18) dN
(cid:18) dN

dV N
c

dV N
c

(cid:19)(cid:18) dM
(cid:19)(cid:18)

dV M
c
dN
dV M

α

c

(cid:19)

(cid:19)
(cid:19)

−

(cid:18) dN
(cid:18) dN

dV M

c

(cid:19)(cid:18) dM
(cid:19)(cid:18)

dV N
c

−

α

dN
dV N
c

dV M

c

(38)

(cid:19)

.

vanishes. This cDFT problem is thus said to be ill-posed,
and if it has a stationary point then it is non-unique.

In order to see how this non-uniqueness arises, it is
suﬃcient to analyse the Kohn-Sham potentials acting on
the electron density ˆn and spin density ˆm, denoted by
ˆV N and ˆV M , respectively. Referring to the total-energy
expressions of Eq. 37, these potentials are given by

DFT [ˆn, ˆm] +(cid:0)V N
DFT [ˆn, ˆm] +(cid:0)V M

= ˆV N

= ˆV M

(cid:1) ˆwc
c /α(cid:1) ˆwc.

c + αV M
c

c + V N

and

(39)

ˆV N =

V M =

δW
δˆn
δW
δ ˆm

It is clear that if the Lagrange multipliers are constrained

to lie along lines of the form V N

c = V N0

c − αV M

c , then

ˆV N =

V M =

δW
δˆn
δW
δ ˆm

= ˆV N

= ˆV M

DFT [ˆn, ˆm] + V N0

DFT [ˆn, ˆm] +(cid:0)V N0

c /α(cid:1) ˆwc

ˆwc

c

and

(40)

11

this is used to transform the algorithm according to
c −σn−1D−1Cn−1. The Jacobi preconditioner
c = Vn−1
Vn
is perhaps the simplest available, in the present context it
takes the form [D]IJ = δIJ / [dVc/dC]IJ , which is appro-
priate only for diagonally dominant interacting response
matrices.

c

remain constant for constant values of the intercept V N0
,
and so the electron density and spin-density also remain
unchanged. Thus, if a stationary point exists, and if
the coupling α is measured numerically, then variation of
the Lagrange multipliers along the such lines will leave
the constraints satisﬁed, and thus the total-energy W
unchanged. For a measured α and a ﬁxed V N0
, there
are an inﬁnite number of cDFT stationary points. The
optimization problem is thus ill-posed and numerically
unfeasible, and the problem should be re-deﬁned in terms
of a single Lagrange multiplier, for example V M

c

c with

W = EDFT +(cid:0)V N0

c − αV M

c

(cid:1) (N − Nc)

= EDFT + V M

c ((M − Mc) − α (N − Nc))

+ V M

c (M − Mc)

+ V N0

c

(N − Nc) .

(41)

In practice, the idealization dM/dN = α will never
hold exactly except for pathological situations such as
full spin-polarization. Nonetheless, we have shown that
the solution of cDFT problems in which the same weight
function ˆwc is used to deﬁne two diﬀerent constraints re-
lies, by construction, on a non-vanishing non-linearity in
the coupling between the constrained expectation values.
This is not alleviated by using ˆwc to deﬁne one constraint
and its complimentary function ˆ1− ˆwc for the other, since
using the latter is equivalent to using ˆwc together with a
change in the sign of the corresponding Lagrange multi-
plier. Non-linearly coupled constrained variables of this
type are often numerically feasible to work with, however,
as well as being physically reasonable (such as in the case
of simultaneous charge and spin constraints), as demon-
strated by the calculations described in Refs. 1, 45–48.

B. Preconditioning and Newton’s method

Preconditioning is a transformation of variables that is
applied in order to bring the condition number of an op-
timization problem close to unity. Close to solutions, it
provides optimization algorithms with the approximately
spherical energy landscapes in which they perform well,
by artiﬁcially scaling the gradients and higher deriva-
tives. Here, we brieﬂy outline how our results may be
used to construct preconditioners and Newton’s method.
Consider the steepest descents (for plus) or ascents (for
minus) algorithm, given for the cDFT problem by Vn
c =
c ±σn−1Cn−1, where σ is a step length with the units
Vn−1
of energy, which may be ﬁxed or optimized by line-search
methods. In order to adapt this method to ill-conditioned
problems, a preconditioner matrix D is constructed, and

In cDFT, this preconditioner may be calculated by

ﬁnite-diﬀerence methods, the simplest formula being

(cid:104)

(cid:16)

(cid:20) dC

(cid:21)

dVc

IJ

≈

(cid:17)(cid:105)

∆

C

[Vc] + ∆ ˆVcJ

− [C ([Vc])]I

I

,

(42)

where ˆVcJ is a unit vector for the Lagrange multiplier of
index J, and ∆ is a small real number. Since calculating
the full vector of energy gradients C is typically a very
small contribution to the computational cost of a cDFT
calculation, there is little advantage to limiting this re-
sponse matrix to its diagonal approximation. Making
use also of the oﬀ-diagonal matrix elements, the precon-
ditioner deﬁned by D = dC/dVc, together with σ = 1
eﬀectively yields Newton’s method64, which is adapted
for the cDFT problem by iterating the formula

(cid:19)−1(cid:35)

(cid:34)(cid:18) dC
(cid:21)
(cid:20) dVc
(cid:20) d2EDFT

dVc

dN

(cid:21)

Vc=Vn−1

c

dN2

Vc=Vn−1

c

Vc=Vn−1

× Cn−1

c

(cid:1)
×(cid:0)Nn−1 − Nc
×(cid:0)Nn−1 − Nc

(43)

(cid:1) .

c = Vn−1
Vn

c −

= Vn−1

c −

= Vn−1

c +

Here, the sign in the expression is ﬁxed, since the pre-
conditioner, speciﬁcally its eigenvalues, provides the ap-
propriate sign of the curvature of the energy landscape64.
The unit step length is optimal in the spherical region
surrounding extrema, in which Newton’s method con-
verges quadratically. In practice, it may not be computa-
tionally optimal in all cases to update the preconditioner
on each step, and its initial estimation by ﬁnite-diﬀerence
methods and restart ﬁles may suﬃce. Alternatively, the
ﬁnal line of Eq. 43 provides the preconditioner in terms
of the curvature of the DFT contribution to the total-
energy. With this, the preconditioner might be “trained”
as the calculation proceeds without resort to additional
ﬁnite-diﬀerence calculations, by using the local history of
well converged DFT energies and occupancies updated at
each increment of the Lagrange multiplier vector.

VI. CONCLUDING REMARKS

Constrained DFT is an ﬂexible, potent approach
that broadens
the scope and ﬂexibility of DFT-
based atomistic simulation.
A growing number of
software implementations of cDFT are now appear-
ing1,23,25,28,29,49,65–70, including linear-scaling implemen-
tations designed for application to large systems18,52. It

12

is inherently parallelizable, and thus potentially suitable
for use in combination with high-throughput materials
screening infrastructures50,51, but fundamental develop-
ments will be required to bring cDFT into the realm of
such very routine use. It will need to be made accessi-
ble and computationally eﬃcient, with its optimization
fully automated. For transferability and comparability
between codes, for example, the routine automated selec-
tion of population analysis and targeting schemes, ideally
but not necessarily based on energy considerations, would
surely be beneﬁcial. Methods based on promolecule den-
sities45 or self-consistent Wannier functions71 are promis-
ing possibilities in this direction.

It is our hope that the present work may facilitate the
automation of Lagrange multiplier optimization, particu-
larly by means of rapidly-converging algorithms derived
from Newton’s method. Our results relating both the
response and inverse response functions (interacting and
non-interacting) to energy curvatures are readily gener-
alised to the multivariate case, and it is worth noting

that those pertaining to EDFT are applicable to ground-
state linear-response calculations generally. They may
be easily adapted for any expectation value constraining
functional of Lagrangian form, such as for moments of the
density or density matrix where the Lagrange multipliers
may be identiﬁed as the components of the electromag-
netic ﬁeld. In cases where correlation between multiple
constraints introduces strongly anisotropic energy land-
scapes, our results may be used to construct approximate
preconditioners or, if required, even exact ones.

ACKNOWLEDGEMENTS

This work was enabled by the Royal Irish Academy
– Royal Society International Exchange Cost Share Pro-
gramme (IE131505). GT acknowledges support from EP-
SRC UK (EP/I004483/1 and EP/K013610/1). DO’R is
thankful to the ONETEP Developer’s Group for hosting
a workshop that facilitated the development of this work.

∗ daithi.o.riogain@tcd.ie
† g.teobaldi@liverpool.ac.uk
1 B. Kaduk, T. Kowalczyk, and T. Van Voorhis, Chemical

Reviews 112, 321 (2012).

19 D. H. P. Turban, G. Teobaldi, D. D. O’Regan,

and

N. D. M. Hine, (2016), Submitted.

20 S. Diﬂey and T. Van Voorhis, Journal of Chemical Theory

and Computation 7, 594 (2011).

2 P. Hohenberg and W. Kohn, Phys. Rev. 136, B864 (1964).
3 W. Kohn and L. J. Sham, Phys. Rev. 140, A1133 (1965).
4 Q. Wu and T. Van Voorhis, Journal of Chemical Theory

21 K. Nakamura, Y. Yoshimoto, R. Arita, S. Tsuneyuki, and

M. Imada, Phys. Rev. B 77, 195126 (2008).

22 S. Roychoudhury, C. Motta, and S. Sanvito, Phys. Rev.

and Computation 2, 765 (2006).

5 Q. Wu and T. Van Voorhis, Phys. Rev. A 72, 024502

(2005).

6 M. Segal, M. Singh, K. Rivoire, S. Diﬂey, T. Van Voorhis,

and M. A. Baldo, Nature Materials 6, 374 (2007).

7 T. Kowalczyk, Z. Lin, and T. V. Voorhis, The Journal of

Physical Chemistry A 114, 10427 (2010).

8 P. H. Dederichs, S. Bl¨ugel, R. Zeller, and H. Akai, Phys.

Rev. Lett. 53, 2512 (1984).

9 Q. Wu and T. Van Voorhis, The Journal of Physical Chem-

istry A 110, 9212 (2006).

10 H. Oberhofer and J. Blumberger, The Journal of Chemical

Physics 131, 064101 (2009).

B 93, 045130 (2016).

23 A. M. Souza, I. Rungger, C. D. Pemmaraju, U. Schwingen-
schloegl, and S. Sanvito, Phys. Rev. B 88, 165112 (2013).
24 J. D. Sau, J. B. Neaton, H. J. Choi, S. G. Louie, and M. L.

Cohen, Phys. Rev. Lett. 101, 026804 (2008).

25 C. Brooke, A. Vezzoli, S. J. Higgins, L. A. Zotti, J. J. Pala-
cios, and R. J. Nichols, Phys. Rev. B 91, 195438 (2015).
26 Q. Wu and T. Van Voorhis, The Journal of Chemical

Physics 125, 164105 (2006).

27 F. Ding, H. Wang, Q. Wu, T. Van Voorhis, S. Chen, and
J. P. Konopelski, The Journal of Physical Chemistry A
114, 6039 (2010).

28 H. Oberhofer and J. Blumberger, J. Chem. Phys. 131,

11 P. H.-L. Sit, M. Cococcioni, and N. Marzari, Phys. Rev.

064101 (2009).

Lett. 97, 028303 (2006).

12 T. Tim Kowalczyk, L.-P. Wang, and T. Van Voorhis, The

Journal of Physical Chemistry B 115, 12135 (2011).

13 J. Behler, K. Reuter, and M. Scheﬄer, Phys. Rev. B 77,

115421 (2008).

14 I. Rudra, Q. Wu, and T. Van Voorhis, The Journal of

Chemical Physics 124, 024103 (2006).

15 I. Rudra, Q. Wu, and T. Van Voorhis, Inorganic Chemistry

46, 10539 (2007).

29 H. Oberhofer and J. Blumberger, J. Chem. Phys. 133,

244105 (2010).

30 A. Kubas, F. Hoﬀmann, A. Heck, H. Oberhofer, M. El-
stner, and J. Blumberger, J. Chem. Phys. 140, 104105
(2014).

31 A. Kubas, F. Gajdos, A. Heck, H. Oberhofer, M. Elstner,
and J. Blumberger, Phys. Chem. Chem. Phys. 17, 14342
(2015).

32 H. Oberhofer and J. Blumberger, Angew. Chem. Int. Ed.

16 J. R. Schmidt, N. Shenvi, and J. C. Tully, The Journal of

49, 3631 (2010).

Chemical Physics 129, 114110 (2008).

17 S. Diﬂey, D. Beljonne, and T. Troy Van Voorhis, Journal

of the American Chemical Society 130, 3420 (2008).

18 A. M. P. Sena, T. Miyazaki, and D. R. Bowler, Journal of

Chemical Theory and Computation 7, 884 (2011).

33 H. Oberhofer and J. Blumberger, Phys. Chem. Chem.

Phys. 14, 13846 (2012).

34 K. P. McKenna and J. Blumberger, Phys. Rev. B 86,

245110 (2012).

35 J. Blumberger and K. P. McKenna, Phys. Chem. Chem.

Phys. 15, 2184 (2013).

36 S. Yeganeh and T. Van Voorhis, The Journal of Physical

62 D. D. O’Regan, M. C. Payne, and A. A. Mostoﬁ, Phys.

13

Chemistry C 114, 20756 (2010).

37 D. P. McMahon, R. R. Parkhurst, N. J. Thompson,

,
A. Rao, K. Johnson, M. Y. Sfeir, M. G. Bawendi, T. M.
Swager, R. H. Friend, M. A. Baldo, and T. Van Voorhis,
Nature Chemistry 6, 492 (2014).

38 J. S. Evans, C.-L. Cheng, and T. Van Voorhis, Phys. Rev.

B 78, 165108 (2008).

39 V. I. Anisimov, J. Zaanen, and O. K. Andersen, Phys.

Rev. B 44, 943 (1991).

40 H. Meider and M. Springborg, Journal of Physics: Con-

densed Matter 10, 6953 (1998).

41 P. L. Danielsen, Journal of Physics C: Solid State Physics

19, L741 (1986).

42 H. Meider and M. Springborg, Chemical Physics Letters

300, 339 (1999).

43 M. S. Hybertsen, M. Schl¨uter,

and N. E. Christensen,

Phys. Rev. B 39, 9028 (1989).

44 A. G. Petukhov, I. I. Mazin, L. Chioncel, and A. I. Licht-

enstein, Phys. Rev. B 67, 153106 (2003).

45 Q. Wu, C.-L. Cheng, and T. Van Voorhis, The Journal of

Chemical Physics 127, 164119 (2007).

46 Q. Wu, B. Kaduk, and T. Van Voorhis, The Journal of

Chemical Physics 130, 034109 (2009).

47 B. Kaduk and T. Van Voorhis, The Journal of Chemical

Physics 133, 061102 (2010).

48 B. Kaduk, T. Tsuchimochi, and T. Van Voorhis, The Jour-

nal of Chemical Physics 140 (2014).

49 J. ˘Rez´a˘c, B. L´evy, I. Demachy, and A. de la Lande, Journal

of Chemical Theory and Computation 8, 418 (2012).

50 A. Jain, G. Hautier, C. J. Moore, S. P. Ong, C. C. Fischer,
T. Mueller, K. A. Persson, and G. Ceder, Computational
Materials Science 50, 2295 (2011).

51 S. Curtarolo, G. L. W. Hart, M. B. Nardelli, N. Mingo,

S. Sanvito, and O. Levy, Nat Mater 12, 191 (2013).

52 L. E. Ratcliﬀ, L. Genovese, S. Mohr, and T. Deutsch, The

Journal of Chemical Physics 142, 234105 (2015).

53 S. Baroni, S. de Gironcoli, A. Dal Corso, and P. Giannozzi,

Rev. Mod. Phys. 73, 515 (2001).

54 The “curvature” is used here as a convenient shorthand for
second derivative. We do not mean to imply the geomet-
ric curvature, which equals the second derivative only at
stationary points, strictly speaking.

55 A single, strictly local occupancy constraint is considered
in Ref. 5. We retain these restrictions so as not to obscure
the fundamental aspects under consideration. These con-
ditions are typically lifted in practical cDFT calculations,
bringing us into multivariate optimisation of constrained
Kohn-Sham spin-density functional theory, which may also
be non-local or orbital dependent.

56 S. Baroni, P. Giannozzi, and A. Testa, Phys. Rev. Lett.

58, 1861 (1987).

57 J. M. Rondinelli, B. Deng, and L. D. Marks, Computa-

tional Materials Science 40, 345 (2007).

58 A. D. Becke, Phys. Rev. A 38, 3098 (1988).
59 C. Lee, W. Yang, and R. G. Parr, Phys. Rev. B 37, 785

(1988).

60 C.-K. Skylaris, P. D. Haynes, A. A. Mostoﬁ, and M. C.
Payne, The Journal of Chemical Physics 122, 084119
(2005).

61 C.-K. Skylaris, A. A. Mostoﬁ, P. D. Haynes, O. Di´eguez,

and M. C. Payne, Phys. Rev. B 66, 035119 (2002).

Rev. B 85, 193101 (2012).

63 L. E. Ratcliﬀ, N. D. M. Hine, and P. D. Haynes, Phys.

Rev. B 84, 165131 (2011).

64 Y. N. Dauphin, H. de Vries,

and Y. Bengio,

(2015),

arXiv:1502.04390.

65 M. Valiev, E. Bylaska, N. Govind, K. Kowalski,
T. Straatsma, H. V. Dam, D. Wang, J. Nieplocha, E. Apra,
T. Windus, and W. de Jong, Computer Physics Commu-
nications 181, 1477 (2010).

66 Y. Shao, Z. Gan, E. Epifanovsky, A. T. B. Gilbert, M. Wor-
mit, J. Kussmann, A. W. Lange, A. Behn, J. Deng,
X. Feng, D. Ghosh, M. Goldey, P. R. Horn, L. D. Ja-
cobson, I. Kaliman, R. Z. Khaliullin, T. K´us, A. Lan-
dau, J. Liu, E. I. Proynov, Y. M. Rhee, R. M. Richard,
M. A. Rohrdanz, R. P. Steele, E. J. Sundstrom, H. L.
Woodcock III, P. M. Zimmerman, D. Zuev, B. Albrecht,
E. Alguire, B. Austin, G. J. O. Beran, Y. A. Bernard,
E. Berquist, K. Brandhorst, K. B. Bravaya, S. T. Brown,
D. Casanova, C.-M. Chang, Y. Chen, S. H. Chien, K. D.
Closser, D. L. Crittenden, M. Diedenhofen, R. A. DiS-
tasio Jr., H. Dop, A. D. Dutoi, R. G. Edgar, S. Fatehi,
L. Fusti-Molnar, A. Ghysels, A. Golubeva-Zadorozhnaya,
J. Gomes, M. W. D. Hanson-Heine, P. H. P. Harbach,
A. W. Hauser, E. G. Hohenstein, Z. C. Holden, T.-C.
Jagau, H. Ji, B. Kaduk, K. Khistyaev, J. Kim, J. Kim,
R. A. King, P. Klunzinger, D. Kosenkov, T. Kowalczyk,
C. M. Krauter, K. U. Lao, A. Laurent, K. V. Lawler,
S. V. Levchenko, C. Y. Lin, F. Liu, E. Livshits, R. C.
Lochan, A. Luenser, P. Manohar, S. F. Manzer, S.-P. Mao,
N. Mardirossian, A. V. Marenich, S. A. Maurer, N. J.
Mayhall, C. M. Oana, R. Olivares-Amaya, D. P. O’Neill,
J. A. Parkhill, T. M. Perrine, R. Peverati, P. A. Pieniazek,
A. Prociuk, D. R. Rehn, E. Rosta, N. J. Russ, N. Sergueev,
S. M. Sharada, S. Sharmaa, D. W. Small, A. Sodt, T. Stein,
D. St¨uck, Y.-C. Su, A. J. W. Thom, T. Tsuchimochi,
L. Vogt, O. Vydrov, T. Wang, M. A. Watson, J. Wenzel,
A. White, C. F. Williams, V. Vanovschi, S. Yeganeh, S. R.
Yost, Z.-Q. You, I. Y. Zhang, X. Zhang, Y. Zhou, B. R.
Brooks, G. K. L. Chan, D. M. Chipman, C. J. Cramer,
W. A. Goddard III, M. S. Gordon, W. J. Hehre, A. Klamt,
H. F. Schaefer III, M. W. Schmidt, C. D. Sherrill, D. G.
Truhlar, A. Warshel, X. Xua, A. Aspuru-Guzik, R. Baer,
A. T. Bell, N. A. Besley, J.-D. Chai, A. Dreuw, B. D. Duni-
etz, T. R. Furlani, S. R. Gwaltney, C.-P. Hsu, Y. Jung,
J. Kong, D. S. Lambrecht, W. Liang, C. Ochsenfeld, V. A.
Rassolov, L. V. Slipchenko, J. E. Subotnik, T. Van Voorhis,
J. M. Herbert, A. I. Krylov, P. M. W. Gill, and M. Head-
Gordon, Mol. Phys. 113, 184 (2015).

67 P. Kurz, F. F¨orster, L. Nordstr¨om, G. Bihlmayer, and

S. Bl¨ugel, Phys. Rev. B 69, 024415 (2004).

68 T. Ozaki and H. Kino, Phys. Rev. B 72, 045121 (2005).
69 J. Hutter, M. Iannuzzi, F. Schiﬀmann,

and J. Vande-
Vondele, Wiley Interdisciplinary Reviews: Computational
Molecular Science 4, 15 (2014).

70 P.-W. Ma and S. L. Dudarev, Phys. Rev. B 91, 054420

(2015).

71 D. D. O’Regan, N. D. M. Hine, M. C. Payne, and A. A.

Mostoﬁ, Phys. Rev. B 82, 081102 (2010).

