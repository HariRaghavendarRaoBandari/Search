Modeling and Optimal Operation of Distributed

Battery Storage in Low Voltage Grids

Philipp Fortenbacher, Johanna L. Mathieu, and G¨oran Andersson

1

6
1
0
2

 
r
a

 

M
1
2

 
 
]

Y
S
.
s
c
[
 
 

1
v
8
6
4
6
0

.

3
0
6
1
:
v
i
X
r
a

Abstract—Due to high power in-feed from photovoltaics, it
is expected that more battery systems will be installed in the
distribution grid in near future to mitigate voltage violations
and thermal line overloading. In this paper, we present a two-
stage centralized model predictive control (MPC) scheme for
distributed battery storage that consists of a scheduler entity
and a real-time (RT) control entity. To guarantee secure grid
operation, we solve a robust multi-period optimal power ﬂow
(OPF) in the scheduler stage that minimizes battery degradation
and maximizes the photovoltaic (PV) utilization subject to grid
constraints. The RT control solves a real-time OPF taking storage
allocation proﬁles from the scheduler, a more detailed battery
model, and real-time measurements into account. To reduce
the computational complexity of our controllers, we present a
linearized OPF that approximates the non-linear AC-OPF into
a linear programming (LP) problem. Based on our case study,
we show for two different battery technologies that we can
substantially reduce battery degradation when we incorporate
a battery degradation model. A further ﬁnding is that we can
save up to 30% of the battery losses by using the detailed battery
model in the real-time control stage.

Index Terms—optimal control, power systems, predictive con-

trol

NOMENCLATURE

a2

a1

degradation plane parameter with respect
to Pbat
degradation plane parameter with respect
to SoE
offset parameter with respect to cE
a3
continuous battery system dynamics matrix
A
A1, A2, A3, Az matrices to include battery degradation for

Aq

bbat
b
B

Br
Bv

Bq

cE
cf
cd

input matrix for

multiple storages and time steps
matrix to describe polygonal regions for
active and reactive power
battery system control input vector
offset vector for network losses
battery system control
multiple battery systems
branch ﬂow matrix
linearized active and reactive power to
voltage matrix
matrix to describe polygonal regions for
active and reactive power
battery capacity
feeder cost in e/MWh
battery degradation cost in e/kWh

P. Fortenbacher and G. Andersson are with the Power Systems Laboratory,

ETH Zurich, Switzerland.

ing, University of Michigan, USA.

J. L. Mathieu is with the Department of Electrical and Computer Engineer-

cr
cw
Cg
Cpv
e

e0

emax, emin
ηbat, ηin
E

i
i0, i1

ib
H
L0, L1
λ
l
m
M

M f
n
npv
ns
pgen, qgen
pd, qd

l

pf
pagg
bat
ploss
bat
pp
l , pq
Pbat
Pcell
Pgrid
Φ
R
Rd
SoE
Sx, Su
σPV

inverse charge recovery time in sec−1
capacity well factor
generator to bus mapping matrix
PV generator to bus mapping matrix
state of energy vector of ns battery systems
in MWh
initial state of energy vector of ns battery
systems
storage allocation from scheduler
battery and inverter efﬁciency
state of energy evolution of ns battery
systems
per unit complex nodal current vector
per unit supporting currents for PWA loss
approximation
per unit complex branch current vector
discrete battery control input matrix
hyperplanes for power loss approximation
SOS2 set
Luenberger observer gain
penalty factor for setpoint regions
reduced bus-injection to branch-current
matrix
full bus-injection to branch-current matrix
number of buses
number of PV units
number of storages
generation active and reactive powers
real-time measurement of PV units and
loads
load measurements and predictions
gen PV measurements and predictions

gen

discharging and charging battery grid pow-
ers ∈ ps
feeder generator power
aggregated battery set point
battery losses
grid losses
battery power
battery cell power
battery grid power
discrete battery system dynamics matrix
internal battery resistance
p.u. branch resistance matrix
state of energy
matrices to describe the storage evolution
1 σ bounds of PV prediction

pld, ˆpld, qld
gen, ˆppv
ppv
gen, qpv
ps,dis
gen , ps,ch
gen

T1, T2

U
v
V df
wi
xi ∈ X
xE
xset

X d
X 0, X 1

yagg
set
zi ∈ Z

sampling times for scheduler and RT con-
troller
decision vector for active battery powers
complex voltages in p.u.
diagonal inverse complex voltage matrix
uncertainty set
decision vector for grid variables
dynamic states of battery system
decision helper vector for storage alloca-
tion
p.u. branch reactance matrix
battery state vector (initial and after one
time step)
decision helper variable for aggregated bat-
tery setpoint
decision vector for degradation variables

I. INTRODUCTION

due to the fact

T HE need of energy storage in power systems has emerged

that excess energy from intermittent
renewable sources (RES) has increased. In the next years, it
can be expected that many battery systems will be installed
in the Low Voltage (LV) distribution grid to cope with high
in-feed from photovaltaics (PV) [1] and other ﬂuctuating
energy sources connected to the distribution grid. In particular,
battery systems can mitigate voltage violations and thermal
line overloadings, which allow Distribution System Operators
(DSOs) to defer line upgrades. Some recent papers [2], [3]
focus on decentralized battery control strategies to provide
voltage support. Decentralized control strategies have the ad-
vantage that they rely only on local measurements. Thus, these
ones do not require a communication infrastructure. However,
only centralized and distributed control strategies that rely on
communication can take care of thermal overloadings, since
the power ﬂows are not observable from a local level. In
[4] a centralized predictive control scheme is presented to
avoid thermal constraints. To apply predictive strategies we
need to incorporate load or PV forecasts. Forecasts are only
accurate enough, when they are averaged over a longer time
period, such that predictive strategies can only work on higher
time scales (15min to 1h). However, we need to consider
the grid constraints [5] and battery dynamics that need to be
fulﬁlled and are present on shorter time scales. In particular,
most work uses simple battery models that do not capture
the short timescale dynamics that are present when batteries
are operated in high/low state of charge regimes. Speciﬁcally,
in these regimes the full charge capacity is only accessible at
lower charging/ discharging powers. To exploit the full battery
capacity potential, it is necessary to consider this dynamic
behavior when designing control strategies.

Apart from the technical requirements to foster storage
integration also economical aspects need to be considered.
Since investment costs for batteries are still very high [6],
a battery’s expected lifetime greatly affects assessments of its
economic viability. There is a nonlinear relationship between
operational management and charge capacity loss, and so the
total amount of energy that can be delivered in a battery’s

2

lifetime is dependent on each individual control action. Thus,
operational management has a strong inﬂuence on proﬁtability
and we can best address economic requirements by developing
control policies that take battery lifetime into account. Some
recent papers propose methods to include battery degradation
costs in economic cost functions [7], [8]; however,
these
methods do not consider a detailed model for battery and grid
constraints.

To exploit the full potential of the underlying grid infras-
tructure and dispatch the battery systems in an economic and
efﬁcient way, multi-period Optimal Power Flow (OPF) could
be used. To make the problem tractable one can include convex
approximations of the AC power ﬂow equations. This is done
in [9], [10], where the AC Optimal Power Flow (AC-OPF)
can be approximated to a Second Order Cone Programming
(SOCP) problem, which is solvable in polynomial time, but
still hard to solve. The authors of [11] relax the AC-OPF to a
convex Semi Deﬁnite Programming (SDP) problem and ensure
optimality under certain assumptions. However, this is even
harder to solve than a SOCP problem.

In sum, the main challenge is to develop control methods
that are able to tackle all these challenges with reasonable
computational complexity so that they can be deployed in
computationally limited controllers.

The main contribution of this paper is two-fold. First, we
present a computationally tractable linearized OPF for LV
networks. In particular, we recast the nonlinear AC-OPF into
a Linear Programming (LP) problem by exploiting the radial
structure of an LV network.

Secondly, we incorporate our linear OPF into a two-stage
Model Predictive Control (MPC) control scheme that con-
sists of a scheduler and a real-time (RT) control entity. The
scheduler entity is a robust MPC that solves a multi-period
OPF minimizing battery degradation and maximizing the PV
utilization subject to grid and storage constraints. We link the
planning domain with the RT domain by computing storage
allocation bounds that are used by the RT control entity. This
entity solves a RT-OPF that minimizes the battery system
and network losses while considering a more detailed battery
model and RT measurements of the network and battery states.
This paper is organized as follows: Section II presents the
battery models used for the proposed controllers. Section III
shows how the non-linear AC-OPF problem is approximated
and recasted to a LP programming problem. Section IV
comprises the controller formulations for the scheduler and
RT control entity. Section V comprises the simulation results
and a battery lifetime assessment. Finally, Section VI draws
the conclusion.

II. BATTERY MODELING

A. Efﬁciency

In order to assess a cost optimal operation of multiple
battery systems, we ﬁrst need an accurate model that describes
the total efﬁciency of an individual battery system. To evaluate
the total losses of a battery system, we need to consider the
battery and the inverter efﬁciency as shown in Fig. 1. The
crucial parameter that inﬂuences the battery efﬁciency ηbat is

3

Pcell

ηbat

Ibat

R

Voc

Vt

Pbat

ηin

Pgrid

ps,dis
gen

ps,ch
gen

Figure 1. Block diagram of a battery system consisting of an grid connected
inverter (right block) and the battery stack (left block).

the battery’s internal resistance R. By using a Thevenin circuit
equivalent the battery power Pbat is

Pbat = VocIbat − RIbat

2

,

(1)

where Voc is the open circuit voltage (OCV), which depends
on the SOC. The battery efﬁciency for discharging currents
Ibat > 0 is given by

ηdis
bat =

Pbat
Pcell

=

VocIbat − RIbat

2

VocIbat

= 1 − RIbat
Voc

,

(2)

where the internal cell power Pcell is referred to as the power
input. For charging currents Ibat < 0, we have to reference
the battery power Pbat to the power input:

Figure 2. Battery system efﬁciencies and total power losses as a function
of the grid power. The plot is calculated for a 10kW battery system with R=
10mΩ and a Voc= 42V and a standard inverter efﬁciency curve from [12].

Pcell

charging
Pcell = ηbatPbat

discharging
Pcell = η−1

batPbat

P −

bat,r

P +

bat,r

Pbat

.

(3)

Figure 3. Linear approximation of the cell power Pcell with respect to the
battery power Pbat.

1) Linear Basic Model: The ﬁrst introduced model is an

integrator-based model

˙SoE = −Pcell

,

(7)

where SoE denotes the time-varying state of energy. As shown
in Fig. 3 it turns out that Pcell has a non-linear relationship
with respect to the battery power. To derive a linear model,
we linearize Pcell in ranges of the rated powers P −
bat,r
by evaluating (5) at those points. By including an averaged
inverter efﬁciency ¯ηin, we obtain
(cid:125)
(cid:123)(cid:122)
˙SoE ≈ [−ηbat(P +
bat,r)−1 ¯η −1
(cid:123)(cid:122)
−η

−ηbat(P −
−ηch

(cid:20) ps,dis

bat,r,P +

bat,r)¯ηin

(cid:125)
(cid:125)

gen
ps,ch
gen

(cid:123)(cid:122)

(cid:21)

(cid:124)

in

]

,

bT

bat

(8)
gen < 0 represent the discharging and

(cid:124)
(cid:124)
gen ≥ 0, ps,ch

−1
dis

where ps,dis
charging powers.

2) Linear Extended Model: The linear extended model
allows us to capture the rate capacity effect [14]. This effect
accounts for the ion diffusion in the electrolyte and reduces
the full capacity potential at high/ or low SoE regimes in
combination with high battery powers. As we have presented
in [13] we capture this effect by using and modifying the
KiBaM model [15]. The model is

(cid:34) − cr
(cid:124)

cw
cr
cw

(cid:35)
(cid:125)

cr
1−cw
− cr
1−cw

(cid:123)(cid:122)

˙xE =

xE +

(cid:20) bT

bat
0

(cid:21)

(cid:21)(cid:20) ps,dis

gen
ps,ch
gen

A
SoE = xE1 + xE2

,

(9)

ηch
bat =

Voc − RIbat
For Voc >> RIbat, we can approximate (3) to

= 1 +

Pcell
Pbat

RIbat

(cid:12)(cid:12)(cid:12)(cid:12) RIbat

Voc

(cid:12)(cid:12)(cid:12)(cid:12)

bat ≈ ηdis
ηch

bat = 1 −

.

(4)

The battery efﬁciency can be expressed as a function of the
applied battery power Pbat by solving (1) for Ibat and putting
this expression into (4)

ηbat = 1 −

.

(5)

(cid:12)(cid:12)(cid:12)(cid:12)

(cid:12)(cid:12)(cid:12)(cid:12) Voc − √
(cid:40)(cid:0)ηbat

−1ηin

2 − 4RPbat

Voc
2Voc

−1 − 1(cid:1) Pgrid

Including the inverter efﬁciency ηin the total losses are

P bat

loss = f (Pgrid) =

(ηbatηin − 1)Pgrid

: Pgrid > 0
: Pgrid < 0,
(6)
where Pgrid is injection to or outtake from the grid. The
multiplication of ηbat and ηin leads to a non-convex function,
which is shown with the blue curve in Fig. 2. In addition, the
battery and inverter efﬁciencies are depicted by evaluating (6)
and a standard inverter curve from [12].

B. Fast Transients

To assess the value of enhanced battery models in power
system applications, we include the linear battery models
presented in [13] to our optimization framework. As an
extension we add to our models the inverter efﬁciency and
for convenience we express the normalized state of charge
(SoC) by the state of energy (SoE).

Grid Power Pgrid (kW)-10-50510Power Losses (kW)012Pbatloss2bat2in2tot = 2in2batEfficiency 200.514

In general, we can calculate the per unit complex nodal

into our linear Forward Backward Sweep Optimal Power Flow
(FBS-OPF) problem.
current injection vector i ∈ Rn×1 by
(cid:124)
(cid:125)
i = diag{1/v1, . . . , 1/vn}∗

[p + jq]∗

(cid:123)(cid:122)

(11)

,

V df

where p ∈ Rn×1 and q ∈ Rn×1 are the balanced three-phase
real and reactive per unit power injections at each bus n.
The variables v1, . . . , vn are the complex nodal line to neutral
voltages in per unit. According to [19] we can deﬁne a matrix
M f ∈ Rl×n that maps the nodal current injection vector i to
the branch current vector ib ∈ Rl×1 with

ib = M f i

,

(12)

where l denotes the number of branches in a radial network.
The matrix M f ∈ Rl×n is also called bus-injection to branch-
current (BIBC) matrix. Here, we also deﬁne a reduced version
of M f indicated with M ∈ Rl×n−1, in which the column of
the involved slack bus is deleted.

A. Voltage Approximation

By applying Ohm’s law the voltage drops across the lines

can be exactly expressed by

,

df [p + jq]∗

∆v = M T [Rd + jX d]M f V ∗

(13)
where Rd = diag{rd1, ..., rdl} ∈ Rl×l is the branch resistance
matrix in per unit and X d = diag{xd1, ..., xdl} ∈ Rl×l is the
reactance matrix in per unit. However, (13) is complex, such
that we have to ﬁnd a linear and real approximation in reactive
and active power for our linear optimization problem. If we
assume that the nodal voltage angles are small (< 10◦) and
the R/X ratio is high (> 2), which is usually the case for LV
networks, we can approximate (13) to absolute voltage drops
with respect to the slack bus voltage vs ∈ Rl×1 by

v − vs ≈(cid:104)
(cid:124)

M T RdM f|V df| M T X dM f|V df|(cid:105)
(cid:125)

(cid:123)(cid:122)

(cid:20) p

q

(cid:21)

Bv

.

(14)

B. Loss Approximation

We can approximate the losses by

pl = Rdib ◦ i
(cid:123)(cid:122)

(cid:124)
(cid:125)
≈ Rd(M f|V df|p)2

∗
b

,

pp
l

(cid:124)
(cid:125)
+ Rd(M f|V df|q)2

(cid:123)(cid:122)

pq
l

(15)
(16)

.

Note that we also assume here that the voltage angles are small
to neglect the contribution of the voltage’s imaginary part.
To ﬁnd linear expressions in p and q, we approximate their
quadratic functions into piecewise linear functions. For this
purpose, we divide the quadratic functions into four reqions
that are deﬁned by the branch currents i0 and i1 and the branch
resistances. We thus obtain following convex formulation for

Figure 4.
Illustration of the degradation map for a 10 kWh battery system
(cE = 10kWh). The red surface is the piecewise afﬁne (PWA) approximation
(10) of the identiﬁed map (blue surface) by evaluating its convex hull.

where xE denotes the state vector for two wells that are
interconnected. Energy can only withdrawn from the available
well xE1. The parameter cw is a factor that determines the
size of the wells and the time constant cr is the inverse charge
recovery time.

C. Slow Transients

Capacity fade is a very slow process and very hard to model.
Among the contributors to capacity fade are two chemical side
reactions that transform cyclable ions into solids during battery
operation. In [13], we present a method to identify a stationary
degradation process on a arbitrary usage pattern. Its result is
a degradation map in terms of the applied battery power and
state of energy. Unfortunately, degradation maps are in general
not convex [16], such we cannot apply efﬁcient convex solvers
in our optimization framework. As an additional extension, we
compute the convex hull of the degradation map from [13]
by means of a Delaunay triangulation. Figure 4 shows the
convex hull (red surface) of the identiﬁed degradation map
(blue surface). By evaluating the plane parameters a1, a2, a3
of the triangles from the convex hull, we can deﬁne following
piece-wise afﬁne mapping for the degradation z

(cid:19)

(cid:18)

(cid:21)

(cid:20) Pbat

SoE

z = max

[a1 a2]

+ a3cE

,

(10)

where cE is the battery energy capacity.

III. OPTIMAL POWERFLOW (OPF) FOR LOW VOLTAGE

(LV) GRIDS

From [17], [18] we present the recast of the non-linear
AC-OPF problem into an LP problem. Based on the Forward
Backward Sweep (FBS) power ﬂow method from [19] we
linearly approximate voltage, power losses and branch ﬂow
limits as a function of the nodal reactive and active power for
a radial network. These approximations are then incorporated

108Energy (kWh)642015105Power(kW)0-5-1042068-15#10-3Degradation (kWh/h)Identified Degradation MapPWA Convex Hullthe power losses that are induced by the active bus power
injections

l ≈ max{L0p,−L0p, L1p + b,−L1p + b}} ,
pp

(17)

where

1,··· , i0
L0 = diag{i0
L1 = diag{i0
1,··· , i0
l + i1
1 + i1
b = −[rd1i0
1,··· , rdli0
1i1
l i1
l ]T

l }RdM f|V df|

.

,

l }RdM f|V df|

(18)
, (19)
(20)

Equations (18)-(20) deﬁne hyperplanes for the power losses.
In the same straightforward way, we can express the losses
caused by the reactive bus power by

l ≈ max{L0q,−L0q, L1q + b,−L1q + b}
pq

.

(21)

C. Branch Flow Approximation

The branch ﬂow currents are exactly given by

ib = M f V ∗

df [p + jq]∗

.

(22)

If we assume that the reactive power injections are much
smaller than the active power injections, which holds for nor-
mal grid operation in LV grids, we can neglect the contribution
on the reactive power by approximating (22) into

(cid:123)(cid:122)
(cid:125)
ib ≈ M f|V df|

(cid:124)

Br

p .

(23)

D. FBS-OPF Formulation

With the approximations from the previous Section the
AC-OPF problem can be recasted into a computationally less
complex problem. We deﬁne following optimization vector

l , v(cid:3)T . If we consider positive linear

x = (cid:2)pgen, qgen, pp

prices cp for the active generator powers the OPF problem
can be approximated to the following LP problem:
J∗ = min
s.t.

l , pq

− vs

qd

(cid:21)

x
(a)

Cgqgen

l = 1T pd

(cid:20) pd

(cid:21)
cT
p pgen
1T Cgpgen − 1T pp

(cid:20) Cgpgen

l − 1T pq
− v = Bv
(b) Bv
l − L0Cgpgen ≥ −L0pd
pp
(c)
l + L0Cgpgen ≥ L0pd
pp
(d)
l − L1Cgpgen ≥ −L1pd + b
pp
(e)
l + L1Cgpgen ≥ +L1pd + b
pp
(f)
l − L0Cgqgen ≥ −L0qd
pq
(g)
l + L0Cgqgen ≥ L0qd
pq
(h)
l − L1Cgqgen ≥ −L1qd + b
pq
(i)
l + L1Cgqgen ≥ +L1qd + b
pq
(j)
(k) −imax
b + Brpd ≤ BrCgpgen ≤ imax
vmin ≤ v ≤ vmax
(l)
(m) pmin ≤ pgen ≤ pmax
pgen + Aqqgen ≤ smax
(n)
pgen − Aqqgen ≤ smax
(o)
pgen + Aqqgen ≥ −smax
(p)
pgen − Aqqgen ≥ −smax
(q)
(r) −Bqsmax ≤ qgen ≤ Bqsmax

,

b + Brpd

5

qgen

pgen

smax

φ

a)

qgen

pgen

smax

φ

b)

Figure 5. Approxmitated reactive power capability areas a) circular bounded
b) cos φ bounded. The polygonal convex regions can be described with the
constraints (24l-m). [17]

where pd ∈ Rn×1 and qd ∈ Rn×1 are the active and reactive
load consumption for n buses. Further, the active and reactive
ng generator bus injections pgen ∈ Rng×1 and qgen ∈ Rng×1
are mapped to the buses with the Matrix Cg ∈ Rn×ng.
Equation (24a) speciﬁes the power balance in the grid. The
voltage approximation from (14) is included in (24b). The
constraints (24c-j) incorporate epigraph formulations that ap-
proximate the power losses. Note to get an optimal solution
the solver can only select values for pp
that lie on
the deﬁned hyperplanes (18)-(20). Constraint (24k) include
branch ﬂow limits, and the constraints (24l-m) specify the
lower and upper bounds for the voltage and active generator
powers. In this formulation, we use (24n-r) to deﬁne circular-
bounded and cos φ bounded active and reactive power settings
by approximating the circular area/ segments with convex sets
[17] that describe the polygons depicted in Fig 5.

l and pq

l

IV. OPTIMAL BATTERY OPERATION

A. Control Structure

As depicted in Fig. 6 our proposed control scheme con-
sists of two control entities working at different time scales.
The overall control objective is to utilize the complete PV
production, while complying with the grid constraints and
keeping battery degradation to the minimum. This objective
is in line with a DSO’s perspective that rather wants to
invest in distributed storage instead of building new lines
to utilize the full PV power. Since we do not allow for
PV curtailment, the scheduler has to calculate future storage
allocation bounds that are feasible under the worst and best
case PV and load prediction scenarios. The real time (RT)
controller tries to control the storages within these bounds,
while minimizing network and storage losses and taking the
real-time measurements of PVs and loads into consideration.

B. Photovoltaic (PV) Prediction

In [20] a method is presented to predict the in-feed of
photovoltaics (PV) on a local area. It relies on PV power
measurement data from the past as well as from weather
forecasts. The predictor estimates the solar transmittance τ.
It is calculated as follows

τ =

ppv
pcs

,

(25)

(24)

Forecast
PV, Load

Scheduler
T1 = 1h

emin, emax

pagg
bat

pd, qd

RT
Control
T2 = 10 s

Figure 6. Centralized control scheme consisting of a scheduler and a real-time
(RT) control entity. The scheduler acts as a robust model predictive controller
(MPC) in a receding horizon fashion. The RT control solves a real-time OPF
using the storage allocation from the scheduler and real-time measurements.

Figure 7. Assumed solar prediction error probalitity density functions (PDFs)
as a function of the transmittance for different time horizon lengths (1 and
24). The horizons in between are linearly interpolated.

where ppv is the PV solar power and pcs is the clear sky
radiation to the inclined surface of the PV, which can be pre-
calculated ofﬂine as stated in the paper. They use following
AutoRegressive with eXogenous input (ARX) model

t+k|t + et+k

ˆτk+1 = m + a1τ1 + a2τt−24h + b1 ˆτ nwp

(26)
to predict the solar transmittance ˆτ. The exogenous input is
the weather forecast ˆτ nwp. The parameters m, a1, a2, b1 can be
estimated by using a Least Squares (LS) method. As shown in
Fig. 7, we derive from [20] 1σ bounds for the solar prediction
assuming a Gaussian distributed error e. This allows us to
include those bounds into a robust optimization framework.

e

with updated energy levels, the scheduler acts here as a robust
model predictive controller (MPC).

6

e(k+1) = Ie(k)+T1

1) Incorporation of Distributed Storage: Due to its high
sample time the scheduler cannot capture the battery dynamics.
Hence, it is sufﬁcient to incorporate the linear basic model (8).
The discrete version of (8) for ns battery systems with respect
to the sample time T1 is

(cid:2)diag{−η−1
dis} diag{−ηch}(cid:3)
(cid:123)(cid:122)
(cid:125)

(cid:21)
(cid:124)
(cid:125)
(27)
gen < 0 ∈ Rns×1 represent the discharg-
gen ≥ 0, ps,ch
where ps,dis
ing and charging powers of the storages with their correspond-
ing total discharging and charging efﬁciencies ηdis, ηch ∈
Rns×1. To incorporate the complete state of energy (SoE)
evolution E = [e(1), ..., e(N )]T for the time horizon N we
can write

(cid:20) ps,dis
(cid:124)
(cid:123)(cid:122)

gen
ps,ch
gen

ps

gen

B

,

0

gen(0)

,

(28)


(cid:125)

 ps
(cid:124)

...
ps

gen(N )

(cid:123)(cid:122)

U


(cid:125)

 I

(cid:124) (cid:123)(cid:122) (cid:125)

...
I

Sx

 B
(cid:124)

. . .

...
B ··· B

(cid:123)(cid:122)

Su

E =

e0 +

where e0 is the initial SoE vector.

2) Incorporation of Battery Degradation: In Section II-C
we calculated the piecewise-afﬁne (PWA) convex hull (10) for
the battery degradation. To incorporate the degradation in the
planning problem, we deﬁne helper decision variables Z =
[z(1), . . . , z(N ) ∈ Rns×1]T for the degradation and include
their epigraphs of (10) in the constraints of our problem. By
substituting the SoE vector with the control variable U with
(28), we express the eqigraphs of (10) in respect to U and
obtain

(A1 + A2Su) U + AzZ ≤ −A2Sxe0 − A3cE ,

(29)
where A1 = [I N ns ⊗a1][−I N ns −I N ns ], A2 = [I N ns ⊗a2],
A3 = [1N ns×1 ⊗ a3], and Az = [I N ⊗ −1ns×1].

3) Robust Optimization Problem Formulation: To solve a
multi-period OPF we ﬁrst need to incorporate a sequence
of the single step OPF problem (24). To do so, we ex-
tend the optimization vector to X = [x1,··· , xN ]T , where
gen,i]T ∈ xi. The variable pf,i denotes the slack
pgen,i = [pf,i ps
gen,i ∈ R2ns×1 reﬂects the charging
generator and the vector ps
and discharging battery powers. Since we do not allow for PV
curtailment, we set

pd,i = −Cpv(ˆppv

gen,i + wiσT

pv,i) + ˆpld

,

(30)

C. Scheduler

We solve a robust multi-period OPF (31) including battery
and grid constraints subject to the worst case PV predictions.
As an result we obtain a storage allocation bounds and
aggregated battery power signal. Since we solve the multi-
period problems in a receding horizon fashion in every hour

where the ﬁxed PV and load injections are denoted by ˆppv
and ˆpl and Cpv ∈ Rn×npv maps the npv PV units to the buses.
We deﬁne W = [w1, . . . , wN ]T , which is a boxed constrained
uncertainty set taking the values from −1 ≤ W ≤ 1. Note
that we do not consider a load prediction uncertainty here,
since the absolute prediction errors are far smaller than for

gen,i

−0.500.500.5101020Transmittance τError eHorizon k = 1PDF(e)−0.500.500.510510Transmittance τError eHorizon k = 24PDF(e)RT Control

emin, emax

pagg
bat
pd, qd

MPC
Control

ps,1
gen, qs,1
gen
Battery 1

e1

x1

Observer 1

...

ps,n
gen, qs,n
gen
Battery n

en

...

xn

Observer n

problem

min
u0

s.t.

Figure 8. Real-time control.

7

(cid:125)

(cid:123)(cid:122)
(cid:20)

(cid:124) (cid:123)(cid:122) (cid:125)

(cid:124) (cid:123)(cid:122) (cid:125)

(cid:124)

0

gen

(cid:21)

+ yagg

battery losses

+ 1T ploss
bat

set + 1T xset
setpoint regions

cw
1 − cw
diag{m}CX 1 − I nsxset ≤ emaxm
I nsxset ≤ 0

1T pgen
network losses
(24a) − (24r)
(a) X 1 = ΦX 0 + Hps
≤ X 1 ≤ 1ns×1 ⊗
(b)
(c) − diag{m}CX 1 − I nsxset ≤ −eminm
(d)
(e)
(f) −m1T ps
(g) −m1T ps
(h)
(i)
(j) −I ns ps
(k) −I ns ploss
(l)
(m) λ = [λ1, . . . , λns]T ∀λi : SOS2 ,

set ≤ −mpagg
set ≤ 0
gen + pld
gen + qld

pd = −Cpvppv
qd = −Cpvqpv

gen +(cid:2)I ns ⊗ ps,P
bat +(cid:2)I ns ⊗ f (ps,P
(cid:2)I ns ⊗ 11×ns(cid:3) λ = 1

(cid:3) λ = 0
gen)(cid:3) λ = 0

gen − yagg
gen − yagg

gen

bat

the PV prediction. The robust problem is

(cid:33)

(cid:32) N(cid:88)

min
X,Z
s.t.

cf pf (k) + cd1T z(k)

T
(a) −Sxe0 ≤ SuU ≤ cE − Sxe0

k=0

∀x : max

−1≤W ≤1

(24a-f,k), (24g-j,l-r),(29) ,

(31)

where cf and cd are cost parameters for the feeder usage and
the battery degradation. The constraint set (31a) operates the
storages in their minimum and maximum bounds. To retrieve
the robust counterpart of the problem (31), we can eliminate
wi by only taking constraint-wise the absolute values of
|σpv,i| [21], since X is not affected by the uncertainty [22].
4) Determination of Robust Storage Level Bounds: To link
the planning domain with the RT domain, we determine robust
bounds from the scheduler for the RT control entity. By
applying

emin = min(e(0), e(1))
emax = max(e(0), e(1))
bat = 1T p∗s
pagg

gen(1)

,

(32)
(33)
(34)

we evaluate e(1) with (28) and the optimal decision vector
p∗s
gen(1) of the robust problem (31). As an additional signal,
we also send the aggregated battery setpoint pagg
bat to ensure
that the batteries will be discharged.

D. Real-Time Control

gen, qs

As depicted in Fig. 8, the real-time (RT) control receives
the storage allocation and an aggregated battery power signal.
By using real-time measurements pd, qd of the PV injections
gen and loads pld, qld it sets the reactive and active
ppv
gen, qpv
gen by solving a real-time OPF. In par-
battery powers ps
ticular, we solve an MPC problem for one step incorporating
the battery model (9) that captures the battery dynamics in
more detail. This allows us to estimate the power availability
of each individual battery system, such that a CC/CV charging
strategy is inherently considered. We deﬁne following decision
vector u0 = [ps
set xset]T , where λ, ploss
bat
are helper variables to incorporate the battery losses into
the problem and yagg
set , xset are helper variables to penalize
deviations from the storage allocation schedule. The RT-OPF

gen λ ploss

bat yagg

gen qs

(35)
is a Mixed Integer Linear Programming (MILP) problem that
minimizes the total power losses in the grid. Constraint (35a)
is the discrete version of (9) for multiple battery systems.
Speciﬁcally, X 0 is initial the battery system state, and X 1
after one time step; Φ is the battery system dynamics matrix,
and H is the control input matrix with respect to the sample
time T2. The constraint (35b) avoids an overspill of the
capacity wells. The constraints (35c-e) deﬁne two regions
that penalize deviations outside the storage allocation bounds
emin, emax with the penalty factor m. The inequalities (35f,g)
only penalize the lower part from the aggregated battery power
setpoint. This allows us to override the worst case prediction
of the PV prediction with the real-time PV realization which
yields to lower storage utilization and thus results in lower
battery degradation. The equalities (35h,i) incorporate the
real-time measurements and the equalities (35j-m) represent
non-convex piece-wise linear functions of the battery losses
using an efﬁcient Special Ordered Set (SOS) formulation [23].
gen and evaluate the
We discretize (6) with P points in ps,P
gen) for each
corresponding function values of (6) with f (ps,P
battery system. The sum of the set λi has to be equal to 1 (35j)
and at most two elements in the set have to be consecutively
non-zero (35k), which is referred to as an SOS2 set.

1) Observer: We implemented a Luenberger observer to
estimate the internal states xE of each individual battery
system, since battery management systems typically provide
only the SoE. Since the system (9) is detectable [24] we can
design following Luenberger observer

(cid:20) 1

(cid:21)(cid:20) Pbat

(cid:21)

˙ˆxE = (A − l[1 1])ˆxE +

(36)
where l ∈ R2×1 has to be chosen such that the dynamic matrix
(A − l[1 1]) is stable.

SoE

0

l

,

V. SIMULATION RESULTS

In our case study we aim to show the performance of our
proposed centralized control scheme. In Table I the parameters
for the case study are listed. Figure 9 shows the involved units

8

Figure 10. Real-time evolution of the battey storage levels. The gray boxes
are the storage level bounds from the scheduler, in which the RT controller
can operate. For high state of charge regimes the RT controller has to switch
from constant current Mode (CC) into constant voltage (CV) charging mode.

Figure 9. Scenario conﬁguration including the Cigre test grid [26] with PV
generators (20kW) and battery storages (10kW/20kWh).

SIMULATION PARAMETERS FOR THE CASE STUDY.

Table I

Storages
Storage Power
Deg model LiCoO2
Deg model LiFePO4
PV units
PV power
Charging Efﬁciency
Discharging Efﬁciency
Simulation Horizon
Households
Grid

ps,max
gen =10kW,qs,max

gen = 10kVar, cE =20kWh

convexiﬁed degradation map from [13]
convexiﬁed degradation map from [16]

ppv,max
gen

= 20 kW (λ = 1)

18

18

0.91
0.91
1 year

18 @ 4kW (randomized proﬁle)

European LV network [26]

with the underlying grid. Importantly, we will assess each
control stage on different time scales. To study the dynamic
behavior in real-time, we simulate the RT control entity over
a sunny day and use in place of a real battery system the
high-ﬁdelity model DUALFOIL [25].

In order to carry out a quantitative life time assessment,
a longer time horizon need to be considered. However, to
reduce simulation times, we omit the real-time stage and run
our scheduler with the simpliﬁed battery model and emulate
the capacity loss with the convexiﬁed degradation maps. We
think this is reasonable, since capacity fade is a slow transient
process.

A. RT control performance

In Fig. 10 we show the real-time evolution of the bat-
tery storage levels. The gray boxes are the energy bounds
emin, emax from the scheduler. While the scheduler could not
take care of the limited power availability in high/low state of
charge regimes, the real-time controller can reduce the power
in real-time by switching from constant current (CC) mode to
constant voltage (CV) mode.

To reduce the battery system losses,

the RT controller
dispatches the batteries in a loss-optimal operating point, while
keeping them within the speciﬁed bounds. This can be clearly
seen in Fig. 11, where the RT controller sets power blocks for
the batteries, which results in a switched battery operation. To
illustrate the merit of the more detailed battery loss model,
we simulate the RT controller in two conﬁguration. The RT-
MILP conﬁguration includes the detailed battery loss model as
presented in (35), while the RT-LP conﬁguration ommits the
loss model, which yields then to a LP problem. As depicted
in Fig. 12 the battery losses are 30% smaller, if we use the

Figure 11. Real-time dispatch scene for a one day simulation with a snapshot
of the battery discharging phase. The blue curve shows the aggregated battery
power signal from the scheduler. To reduce battery losses, it can be seen that
the batteries are discharged (positive powers) and charged (negative powers)
in a switched way.

RT-MILP conﬁguration. Table II quantiﬁes again this ﬁnding.
Interestingly, the battery losses are by 1/3 smaller than the
network losses. From this, we can infer that storage devices
can help to reduce overall losses and therefore potentially
utilize more PV power.

B. Lifetime Assessment

We aim to compare two different battery technologies in
the life time assessment. For the LiCoO2 system we take
the degradation map from [13]. For the LiFePO4 system we
discretize the analytic degradation function presented in [16]
to obtain the map. Both maps are convexiﬁed as proposed in
Section II-C and are included in the scheduler, which we refer
as deg model mode. We also simulate the scheduler without

R1R2R0R4R12R13R15R14R5R7R8R11R3R16R6R17R9R18R1005101520255678900.0050.010.0150.02Storage IDTime (h)Energy Level (MWh)5101520−0.4−0.3−0.2−0.100.10.20.30.4Time (h)Power (MW)  bat 1bat 2bat 3bat 4bat 5bat 6bat 7bat 8bat 9bat 10bat 11bat 12bat 13bat 14bat 15bat 16bat 17bat 18netloadPVpbatagg0.511.52−0.0500.059

Figure 14. Distribution of the remaining battery capacities after a 1 year
simulation. The blue line indicates the initial battery capacity and the bars
specify the remaining capacity for different battery technologies and scheduler
control policies.

LIFE TIME ASSESSMENT FOR DIFFERENT BATTERY TECHNOLOGIES.

Table III

Battery
Technology mode

Scheduler

LiFePO4

LiCoO2

w deg model
w/o deg model
w deg model
w/o deg model

Expected full cycle

achievement
@ EOL0=0.8

2816
1609
1652
166

Expected Lifetime

@ EOL0=0.8

in years

4.4
2.64
2.63
0.29

Figure 12. Battery and network losses for a sunny day. The bars show the
energy losses in dependence on the RT control method. The curves are the
power loss curves for the different RT control methods. While the network
power losses remain equal, it can be seen that when the detailed MILP model
is used almost 30% of the battery losses can be saved.

RESULTS FOR THE RT CONTROL ENTITY.

Table II

RT control mode
RT-MILP
RT-LP

network losses

141.8 kWh
141.2kWh

battery losses

47.5 kWh
68.4 kWh

battery lifetimes (see Tab. III). To get an insight on expected
battery lifetimes, we have extrapolated the battery lifetimes
based on the 1 year simulations by using the end of life
(EOL) criterion of 0.8, which means that 80% of the nominal
capacity is remained. Depending on the battery technology
we can prolong the life time by factor 10 for the LiCoO2
system and by factor 2 for the LiCoO2, if we incorporate the
degradation model in our proposed control scheme.

VI. CONCLUSION

In this paper we present a novel two-stage centralized MPC
scheme for distributed battery storage to mitigate voltage and
line violations that is induced by high PV penetration in LV
grids. To link the time domains of planning and real time
operation, our control scheme consists of a robust scheduler
and a RT control entity. We have shown that this division
is crucial, since grid and battery operation requires lower
times scales than forecast predictions for planning allow for.
While planning algorithms ﬁlter the battery dynamics out and
can therefore use simple battery models, enhanced battery
models in real-time need to be considered. As a further
contribution we present a linearized version of the AC-OPF
that is incorporated in our controllers to reduce computational
complexity. To guarantee a secure grid operation, the scheduler
solves a robust multi-period OPF taking the worst-case PV
prediction and battery degradation into account. It provides
us a robust feasible storage allocation schedule for the RT

Figure 13.
Accumulated capacity fade for a 1 year simulation and for
different battery technologies and different scheduler control policies. The
capacity fade of the LiCoO2 batteries without considering the degradation
model in the scheduler is the highest, since they are mainly operated at low
state of charge regimes.

using the degradation model, but constrain the minimum SoE
level to 5% of the nominal capacity for fairness reasons. In
Fig. 13 we compare the capacity fade for the different battery
technologies when running our control scheme over one year.
The scheduler without using the degradation model operates
the batteries on low SoE regimes. Since those ones induce
high stress on the battery wear, especially the LiCoO2 system
is subject to a high capacity fade. As shown in Fig. 14 we also
quantify the distribution of the battery wear over the individual
batteries. It turns out that the deg model mode balances the
battery wear over the batteries, which contributes to longer

RT−LP MethodRT−MILP Method00.050.10.150.20.25Energy Losses (MWh)  051015202500.0050.010.0150.020.025time (h)Power losses (MW)network lossesbattery lossesRT−LP netlossRT−LP batlossRT−MILP netlossRT−MILP batlosstime (month)JanFebMarAprMayJunJulAugSepOctNovDecJanTotal Capacity (MWh)0.050.10.150.20.250.30.350.4LiFePO4 w deg modelLiFePO4 w/o deg modelLiCoO2 w deg modelLiCoO2 w/o deg modelbat 1bat 2bat 3bat 4bat 5bat 6bat 7bat 8bat 9bat 10bat 11bat 12bat 13bat 14bat 15bat 16bat 17bat 18Battery Capacity (MWh)00.0050.010.0150.020.025LiFePO4 w deg modelLiFePO4 w/o deg modelLiCoO2 w deg modelLiCoO2 w/o deg modelinitial capacity10

control entity that maximizes the PV utilization, while keeping
battery degradation to the minimum. As a major ﬁnding we
have shown in our simulations that we can substantially reduce
battery wear, when we incorporate a degradation model. To
maximize the full grid potential, we solve a single step OPF
problem in the RT control entity. We found out when we
incorporate a detailed battery loss model in the RT control
entity we signiﬁcantly save battery system losses.

REFERENCES

[22] J. L¨ofberg, “Automatic robust convex programming,” Optimization
Methods and Software, vol. 27, no. 1, pp. 115–129, 2012. [Online].
Available: http://dx.doi.org/10.1080/10556788.2010.517532

[23] J. A. Tomlin, “Special ordered sets and an application to gas supply
operations planning,” Mathematical Programming, vol. 42, no. 1, pp.
69–84. [Online]. Available: http://dx.doi.org/10.1007/BF01589393

[24] J. O’Reilly, Observers for Linear Systems, ser. Mathematics in science

and engineering. Elsevier Science, 1983.

[25] M. Doyle, T. F. Fuller, and J. Newman, “Modeling of galvanostatic
charge and discharge of the lithium/polymer/insertion cell,” Journal of
The Electrochemical Society, vol. 140, no. 6, pp. 1526–1533, 1993.

[26] “Benchmark systems for network integration of renewable and dis-
tributed energy resources,” Cigre Task Force C6.04.02, Tech. Rep., 2014.
[Online]. Available: http://c6.cigre.org/Publications/Technical-Brochures

[1] “Battery energy storage for smart grid applications,” Eurobat, Tech.
[Online]. Available: https://http://www.eurobat.org/sites/

Rep., 2013.
default/ﬁles/eurobat smartgrid publication may 2013 0.pdf

[2] F. Marra, G. Yang, C. Træholt, J. Østergaard, and E. Larsen, “A
decentralized storage strategy for residential feeders with photovoltaics,”
IEEE Transactions on Smart Grid, vol. 5, no. 2, pp. 974–981, 2014.

[3] T. Wang, H. Kamath, and S. Willard, “Control and optimization of grid-
tied photovoltaic storage systems using model predictive control,” IEEE
Transactions on Smart Grid, vol. 5, no. 2, pp. 1010–1017, 2014.

[4] K. H. Chua, Y. S. Lim, P. Taylor, S. Morris, and J. Wong, “Energy
storage system for mitigating voltage unbalance on low-voltage networks
with photovoltaic systems,” IEEE Transactions on Power Delivery,
vol. 27, no. 4, pp. 1783–1790, 2012.

[5] E. S. 50160, “Voltage characteristics of electricity supplied by public

distribution networks,” Cenelec, 2010.

[6] S. Schoenung, “Energy storage systems cost update,” Sandia National

Laboratories, Tech. Rep. SAND2011-2730, 2011.

[7] M. Koller, T. Borsche, A. Ulbig, and G. Andersson, “Deﬁning a
degradation cost function for optimal control of a battery energy storage
system,” in Proceedings of PowerTech, 2013.

[8] A. Trippe, R. Arunachala, T. Massier, J. Jossen, and T. Hamacher,
“Charging optimization of battery electric vehicles including cycle
battery aging,” in Proceedings of ISGT EUROPE, Oct 2014.

[9] S. H. Low, “Convex Relaxation of Optimal Power Flow, Part
I: Formulations and Equivalence,” 2014. [Online]. Available: http:
//arxiv.org/abs/1405.0766

[10] K. Christakou, D.-C. Tomozei, J.-Y. L. Boudec, and M. Paolone, “AC
OPF in Radial Distribution Networks - Parts I,II,” 2015. [Online].
Available: http://arxiv.org/abs/1503.06809

[11] D. K. Molzahn and I. A. Hiskens, “Moment-Based Relaxation of the
Optimal Power Flow Problem,” in 18th Power Syst. Comput. Conf.
(PSCC), 18-22 Aug. 2014.

[12] “Efﬁciency and derating sunny boy /
mini central,” SMA, Tech. Rep., 2015.
//ﬁles.sma.de/dl/1348/WirkungDerat-TI-en-40.pdf

sunny
sunny tripower
[Online]. Available: http:

/

[13] P. Fortenbacher, J. Mathieu, and G. Andersson, “Modeling, identiﬁca-
tion, and optimal control of batteries for power system applications,” in
Proceedings of the PSCC, 2014.

[14] M. Doyle and J. Newman, “Analysis of capacity-rate data for lithium
batteries using simpliﬁed models of the discharge process,” Journal of
Applied Electrochemistry, vol. 27, no. 7, pp. 846–856, 1997.

[15] J. F. Manwell and J. G. McGowan, “Lead acid battery storage model
for hybrid energy systems,” Solar Energy, vol. 50, no. 5, pp. 399 – 405,
1993.

[16] J. C. Forman, S. J. Moura, J. L. Stein, and H. K. Fathy, “Optimal
Experimental Design for Modeling Battery Degradation,” 5th Annual
Dynamic Systems and Control Conference joint with the JSME 11th
Motion and Vibration Conference, vol. 1, pp. 309–318, 2012.

[17] P. Fortenbacher, J. Mathieu, and G. Andersson, “Optimal real-time
control of multiple battery sets for power system applications,” in
Proceedings of POWERTECH, 2015.

[18] P. Fortenbacher, M. Zellner, and G. Andersson, “Optimal sizing and
placement of distributed storage in low voltage networks,” in accepted
for 19th Power Systems Computation Conference, Genoa, Italy, 2016.
[Online]. Available: http://arxiv.org/abs/1512.01218

[19] J.-H. Teng, “A direct approach for distribution system load ﬂow solu-
tions,” IEEE Transactions on Power Delivery, vol. 18, no. 3, pp. 882–
887, July 2003.

[20] P. Bacher, H. Madsen, and H. A. Nielsen, “Online short-term solar power

forecasting,” Solar Energy, vol. 83, no. 10, pp. 1772 – 1783, 2009.

[21] A. Ben-Tal, L. El Ghaoui, and A. Nemirovski, Robust Optimization,

2009.

